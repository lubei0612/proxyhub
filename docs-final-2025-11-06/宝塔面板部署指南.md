# ProxyHub 宝塔面板部署指南

**部署方式**: 宝塔面板 + Docker  
**适合人群**: 喜欢图形化管理界面的用户 ⭐  
**难度**: ⭐⭐ (比纯命令行简单)

---

## 📋 为什么选择宝塔面板？

### 优势

✅ **图形化界面** - 无需记忆复杂命令  
✅ **一键安装** - Docker、Nginx、数据库等  
✅ **文件管理** - 可视化上传、编辑文件  
✅ **监控面板** - CPU、内存、磁盘实时监控  
✅ **定时任务** - 自动备份、更新等  
✅ **SSL证书** - 一键申请Let's Encrypt证书  
✅ **防火墙** - 可视化端口管理  

### 适用场景

- 不熟悉Linux命令行
- 需要管理多个网站/应用
- 希望图形化监控服务器状态
- 需要定时备份等自动化任务

---

## 🚀 部署步骤

### 步骤 1: 安装宝塔面板

**SSH连接到服务器后执行**:

```bash
# Ubuntu/Debian 系统
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec

# CentOS 系统
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

**安装时间**: 约5-10分钟

**安装完成后会显示**:
```
==================================================================
Congratulations! Installed successfully!
==================================================================
外网面板地址: http://你的服务器IP:8888/xxxxxxxx
内网面板地址: http://172.x.x.x:8888/xxxxxxxx
username: xxxxxxxx
password: xxxxxxxx
==================================================================
```

**⚠️ 重要**: 
- 请记录面板地址、用户名和密码
- 立即修改默认密码
- 绑定手机号或邮箱

---

### 步骤 2: 登录宝塔面板并初始化

1. **访问面板地址**: `http://你的服务器IP:8888/xxxxxxxx`

2. **登录后会弹出"一键安装"提示**:
   - 选择 **LNMP** (推荐) 或 **LAMP**
   - Nginx: 1.22
   - MySQL: 8.0 (如果不需要可以不装)
   - PHP: 8.1 (如果不需要可以不装)
   - **Docker**: ✅ 必须勾选
   - **Docker-Compose**: ✅ 必须勾选

3. **点击"一键安装"**，等待15-20分钟

4. **配置安全设置**:
   - 左侧菜单 → **安全**
   - 放行端口: 80, 443, 3000, 8080
   - 启用防火墙

---

### 步骤 3: 上传项目文件

#### 方法1: 使用宝塔文件管理器（推荐）

1. **左侧菜单 → 文件**

2. **导航到根目录** `/`

3. **创建目录** `/opt/proxyhub`

4. **进入项目目录**

5. **上传文件**:
   - 点击"上传"按钮
   - 选择本地项目文件夹
   - 或者先在本地打包成zip，上传后解压

#### 方法2: 使用SFTP

宝塔自带SFTP功能:
- 主机: 你的服务器IP
- 端口: 22
- 用户: root
- 密码: 你的密码

---

### 步骤 4: 配置环境变量

**在宝塔面板中**:

1. **文件 → /opt/proxyhub/backend**

2. **创建 `.env.production` 文件**（点击右上角"新建文件"）

3. **粘贴以下内容并修改**:

```bash
# 数据库配置
DB_HOST=db
DB_PORT=5432
DB_USERNAME=proxyhub
DB_PASSWORD=请修改为强密码
DB_DATABASE=proxyhub

# Redis配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=请修改为强密码

# JWT配置
JWT_SECRET=请修改为长随机字符串_至少32字符
JWT_EXPIRES_IN=7200

# 985Proxy API配置
PROXY985_API_KEY=你的API_Key
PROXY985_API_SECRET=你的API_Secret
PROXY985_API_BASE_URL=https://api.985proxy.com

# 应用配置
NODE_ENV=production
PORT=3000
FRONTEND_URL=http://你的服务器IP:8080
```

4. **创建 `/opt/proxyhub/frontend/.env.production`**:

```bash
VITE_API_BASE_URL=http://你的服务器IP:3000/api/v1
VITE_APP_TITLE=ProxyHub
```

5. **保存文件**

---

### 步骤 5: 使用Docker部署

**在宝塔面板中**:

1. **左侧菜单 → Docker**

2. **镜像管理 → 从Dockerfile构建**:
   
   **构建后端镜像**:
   - 名称: `proxyhub-backend`
   - Dockerfile路径: `/opt/proxyhub/backend/Dockerfile`
   - 点击"构建"
   
   **构建前端镜像**:
   - 名称: `proxyhub-frontend`
   - Dockerfile路径: `/opt/proxyhub/frontend/Dockerfile`
   - 点击"构建"

3. **或使用终端**（更简单）:
   
   点击右上角 **终端** 按钮，输入:
   
   ```bash
   cd /opt/proxyhub
   docker compose build
   docker compose up -d
   ```

4. **查看容器状态**:
   
   - Docker → 容器
   - 应该看到4个容器在运行

---

### 步骤 6: 初始化数据库

**在宝塔终端中执行**:

```bash
cd /opt/proxyhub

# 运行数据库迁移
docker compose exec backend npm run migration:run

# 创建种子数据
docker compose exec backend npm run seed
```

**或在宝塔Docker界面**:
- 容器 → proxyhub-backend → 终端
- 输入命令:
  ```bash
  npm run migration:run
  npm run seed
  ```

---

### 步骤 7: 配置Nginx反向代理（可选但推荐）

**使用宝塔配置Nginx更简单**:

1. **左侧菜单 → 网站**

2. **添加站点**:
   - 域名: 输入你的域名（如 `proxyhub.yourdomain.com`）
   - 或使用IP: `你的服务器IP`
   - 根目录: `/www/wwwroot/proxyhub`（任意，不会用到）
   - PHP版本: 纯静态
   - 点击"提交"

3. **配置反向代理**:
   
   点击站点 → **设置** → **反向代理**
   
   **添加反向代理**:
   
   **代理名称**: ProxyHub前端
   ```
   目标URL: http://127.0.0.1:8080
   发送域名: $host
   ```
   
   **添加第二个代理**:
   
   **代理名称**: ProxyHub API
   ```
   目标URL: http://127.0.0.1:3000
   代理路径: /api
   发送域名: $host
   ```

4. **配置完成后**，可以通过域名或IP的80端口访问（无需加8080）

---

### 步骤 8: 配置SSL证书（推荐）

**前提**: 已有域名并指向服务器IP

1. **网站 → 你的站点 → 设置 → SSL**

2. **Let's Encrypt**:
   - 输入邮箱
   - 勾选域名
   - 点击"申请"
   - 等待1-2分钟

3. **强制HTTPS**:
   - 开启"强制HTTPS"开关

4. **访问**: `https://你的域名`

---

## 🎨 宝塔面板特色功能

### 1. 可视化文件管理

**文件 → /opt/proxyhub**:
- 在线编辑配置文件
- 上传/下载文件
- 解压/压缩
- 权限管理
- 文件回收站

### 2. 计划任务（自动备份）

**计划任务 → 添加任务**:

**备份数据库**:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
cd /opt/proxyhub
docker compose exec -T db pg_dump -U proxyhub proxyhub > /www/backup/db_$DATE.sql
```

**执行周期**: 每天 02:00

### 3. 系统监控

**面板首页**:
- CPU使用率
- 内存使用率
- 磁盘使用率
- 网络流量
- 实时监控图表

### 4. Docker可视化管理

**Docker → 容器**:
- 启动/停止容器
- 查看日志
- 进入终端
- 查看资源占用
- 端口映射管理

### 5. 安全管理

**安全**:
- SSH端口修改
- 禁ping
- 端口放行/禁止
- IP黑白名单
- 系统加固

---

## 🔧 常用管理操作

### 查看日志

**方法1**: 宝塔Docker界面
- Docker → 容器 → proxyhub-backend → 日志

**方法2**: 终端
```bash
cd /opt/proxyhub
docker compose logs -f backend
```

### 重启服务

**方法1**: 宝塔Docker界面
- Docker → 容器 → 选择容器 → 重启

**方法2**: 终端
```bash
cd /opt/proxyhub
docker compose restart
```

### 更新代码

**使用宝塔文件管理**:
1. 本地修改代码
2. 打包成zip
3. 上传到 `/opt/proxyhub`
4. 解压覆盖
5. 重新构建: `docker compose build && docker compose up -d`

---

## 📊 性能优化

### 1. 启用Gzip压缩

**网站 → 设置 → 配置文件**

添加到 `http` 块:
```nginx
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
```

### 2. 启用缓存

**网站 → 设置 → 配置文件**

添加到 `server` 块:
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

### 3. 配置CDN（腾讯云CDN）

参考下面的CDN配置指南

---

## 🔐 安全建议

### 1. 修改SSH端口

**安全 → SSH安全 → SSH端口** → 改为其他端口（如 `6789`）

### 2. 修改面板端口

**面板设置 → 安全设置 → 面板端口** → 改为其他端口

### 3. 绑定域名/IP

**面板设置 → 安全设置 → 授权IP访问** → 添加你的IP

### 4. 开启BasicAuth

**面板设置 → 安全设置 → 基础认证** → 开启

### 5. 定期更新

**软件商店 → 已安装** → 检查更新

---

## 💾 数据备份

### 自动备份配置

1. **计划任务 → 添加任务**

2. **任务类型**: Shell脚本

3. **脚本内容**:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/www/backup/proxyhub"
mkdir -p $BACKUP_DIR

# 备份数据库
cd /opt/proxyhub
docker compose exec -T db pg_dump -U proxyhub proxyhub > $BACKUP_DIR/db_$DATE.sql

# 备份环境变量
cp backend/.env.production $BACKUP_DIR/env_$DATE.backup

# 压缩备份
cd /www/backup
tar -czf proxyhub_$DATE.tar.gz proxyhub/

# 删除30天前的备份
find /www/backup -name "proxyhub_*.tar.gz" -mtime +30 -delete

echo "备份完成: $DATE"
```

4. **执行周期**: 每天 02:00

---

## 🆘 故障排查

### 1. 容器无法启动

**Docker → 容器 → 日志** 查看错误信息

常见问题:
- 端口被占用 → 修改端口
- 环境变量错误 → 检查`.env.production`
- 内存不足 → 升级服务器

### 2. 无法访问网站

**检查清单**:
- [ ] 容器是否运行: Docker → 容器
- [ ] 端口是否开放: 安全 → 端口列表
- [ ] Nginx是否启动: 软件商店 → Nginx → 启动
- [ ] 防火墙规则: 安全 → 系统防火墙

### 3. SSL证书申请失败

**原因**:
- 域名未正确解析
- 80端口未开放
- 域名已有其他证书

**解决**:
- 检查DNS解析
- 开放80端口
- 使用其他SSL方式（如Cloudflare）

---

## 🎯 宝塔vs命令行对比

| 功能 | 宝塔面板 | 纯命令行 |
|------|----------|----------|
| 文件管理 | ✅ 可视化 | ⚠️ 需要vim/nano |
| 配置Nginx | ✅ 图形界面 | ⚠️ 手动编辑 |
| SSL证书 | ✅ 一键申请 | ⚠️ certbot命令 |
| 监控 | ✅ 实时图表 | ⚠️ top/htop |
| 备份 | ✅ 定时任务 | ⚠️ crontab |
| Docker管理 | ✅ 可视化 | ⚠️ docker命令 |
| 学习曲线 | ⭐ 简单 | ⭐⭐⭐ 陡峭 |
| 资源占用 | ⚠️ 约500MB | ✅ 最小 |

---

## 📝 总结

**宝塔面板适合**:
- 新手用户
- 需要管理多个应用
- 喜欢图形界面
- 需要定时任务和监控

**不适合**:
- 极简主义者
- 服务器资源有限（<2GB内存）
- 只运行单一应用

---

## 🔗 相关资源

- 宝塔官网: https://www.bt.cn/
- 宝塔文档: https://www.bt.cn/bbs/
- 宝塔论坛: https://www.bt.cn/bbs/forum.php

---

**宝塔面板让部署更简单！** 🎉

