# ProxyHub 腾讯云部署指南（国内镜像加速版）

## 🚀 速度提升 5-10倍！

使用国内镜像源，构建时间从 **10-15分钟** 缩短至 **2-3分钟**！

---

## ⚡ 加速原理

### 使用的国内镜像源

| 组件 | 国外源 | 国内源 | 提速 |
|------|--------|--------|------|
| **Docker基础镜像** | Docker Hub | 腾讯云镜像加速器 | 10倍 |
| **NPM依赖** | npmjs.com | 淘宝NPM镜像 | 5倍 |
| **Alpine包** | dl-cdn.alpinelinux.org | 阿里云镜像源 | 5倍 |

---

## 📋 一键部署命令

### 在腾讯云SSH终端执行以下命令：

```bash
# 进入项目目录
cd /opt/proxyhub

# 下载国内加速版部署脚本
curl -o deploy.sh https://raw.githubusercontent.com/lubei0612/proxyhub/master/deploy-china.sh

# 给脚本执行权限
chmod +x deploy.sh

# 执行自动部署（全程自动，约2-3分钟）
./deploy.sh
```

---

## 📊 部署流程

脚本会自动完成以下操作：

### ✅ 步骤1-6：环境准备
- 配置Docker镜像加速器（腾讯云+阿里云+网易云）
- 备份现有配置
- 从GitHub拉取最新代码
- 恢复环境变量配置

### ✅ 步骤7-9：Docker容器部署
- 停止旧容器
- 使用国内镜像源构建新镜像（⚡ 最快2分钟）
- 启动所有服务

### ✅ 步骤10-12：数据库初始化
- 等待服务就绪
- 运行数据库迁移
- 创建测试账号

### ✅ 步骤13：部署验证
- 显示访问地址
- 提供测试账号
- 列出管理命令

---

## 🎯 部署后访问

### 访问地址
- **前端**: http://43.130.35.117
- **后端API**: http://43.130.35.117:3000/api/v1
- **健康检查**: http://43.130.35.117:3000/api/v1/health

### 测试账号
- **管理员**: admin@example.com / admin123（余额$10000）
- **普通用户**: alice@test.com / password123（余额$500）

---

## 🛠️ 常用管理命令

```bash
# 查看容器状态
docker-compose -f docker-compose.cn.yml ps

# 查看后端日志
docker-compose -f docker-compose.cn.yml logs -f backend

# 查看前端日志
docker-compose -f docker-compose.cn.yml logs -f frontend

# 重启所有服务
docker-compose -f docker-compose.cn.yml restart

# 停止所有服务
docker-compose -f docker-compose.cn.yml down

# 重新构建并启动
docker-compose -f docker-compose.cn.yml up -d --build
```

---

## 🔧 技术细节

### 国内镜像源配置

#### 1. Docker镜像加速器
```json
{
  "registry-mirrors": [
    "https://mirror.ccs.tencentyun.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
```

#### 2. NPM镜像（淘宝）
```bash
npm config set registry https://registry.npmmirror.com
```

#### 3. Alpine镜像源（阿里云）
```bash
sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
```

---

## 📁 相关文件

- `backend/Dockerfile.cn` - 后端国内加速版Dockerfile
- `frontend/Dockerfile.cn` - 前端国内加速版Dockerfile
- `docker-compose.cn.yml` - 国内加速版Docker Compose配置
- `deploy-china.sh` - 国内加速版一键部署脚本

---

## ⏱️ 预计时间

| 阶段 | 时间 |
|------|------|
| 环境准备 | 30秒 |
| 代码拉取 | 10秒 |
| 镜像构建 | 2-3分钟 ⚡ |
| 服务启动 | 30秒 |
| 数据库初始化 | 20秒 |
| **总计** | **约3-4分钟** |

对比国外源：10-15分钟 → **速度提升 4-5倍！**

---

## 🐛 常见问题

### Q: 构建仍然很慢？
A: 检查Docker镜像加速器是否生效：
```bash
docker info | grep -A 5 "Registry Mirrors"
```

### Q: NPM安装失败？
A: 手动设置淘宝镜像：
```bash
docker exec proxyhub-backend npm config set registry https://registry.npmmirror.com
```

### Q: 如何切换回国外源？
A: 使用原始的 `docker-compose.yml` 和 `Dockerfile`：
```bash
docker-compose -f docker-compose.yml up -d --build
```

---

## 📞 获取帮助

- 查看部署日志：`./deploy.sh 2>&1 | tee deploy.log`
- 查看容器日志：`docker-compose -f docker-compose.cn.yml logs`
- 重新部署：删除所有容器后重新运行脚本

---

**🎉 享受飞速部署体验！**

