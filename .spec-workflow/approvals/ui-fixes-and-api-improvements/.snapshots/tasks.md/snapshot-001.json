{
  "id": "snapshot_1762757321494_own9ykv7f",
  "approvalId": "approval_1762757321444_oelr3c3ll",
  "approvalTitle": "UI修复和API改进 - 任务列表",
  "version": 1,
  "timestamp": "2025-11-10T06:48:41.494Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# UI修复和API改进 - 任务列表\r\n\r\n## 任务概览\r\n- **总任务数：** 15\r\n- **预估工时：** 12-15小时\r\n- **优先级分布：** P0(6), P1(9)\r\n\r\n---\r\n\r\n## Phase 1: P0 - 关键API修复\r\n\r\n### Task 1.1: 修复985Proxy API连接\r\n**优先级：** P0  \r\n**预估时间：** 1小时  \r\n**依赖：** 无\r\n\r\n**子任务：**\r\n- [ ] 1.1.1 验证`.env`文件中的API KEY配置\r\n- [ ] 1.1.2 修复`Proxy985Service.getBusinessList()`方法（移除重复定义）\r\n- [ ] 1.1.3 添加API调用日志记录\r\n- [ ] 1.1.4 实现API错误重试机制（最多3次）\r\n- [ ] 1.1.5 添加API响应缓存（TTL: 1小时）\r\n\r\n**验收标准：**\r\n```bash\r\n# 测试命令\r\ncurl -X GET http://localhost:3000/api/v1/proxy985/business-list \\\r\n  -H \"Authorization: Bearer {token}\"\r\n\r\n# 预期响应\r\n{\r\n  \"success\": true,\r\n  \"data\": [...]\r\n}\r\n```\r\n\r\n---\r\n\r\n### Task 1.2: 实现业务场景API端点\r\n**优先级：** P0  \r\n**预估时间：** 1小时  \r\n**依赖：** Task 1.1\r\n\r\n**子任务：**\r\n- [ ] 1.2.1 创建`GET /api/v1/proxy985/business-list`端点\r\n- [ ] 1.2.2 实现`Proxy985Controller.getBusinessList()`方法\r\n- [ ] 1.2.3 添加JWT认证守卫\r\n- [ ] 1.2.4 添加响应数据转换\r\n- [ ] 1.2.5 编写单元测试\r\n\r\n**实现文件：**\r\n- `backend/src/modules/proxy985/proxy985.controller.ts`\r\n- `backend/src/modules/proxy985/proxy985.service.ts`\r\n\r\n---\r\n\r\n### Task 1.3: 前端集成业务场景选择器\r\n**优先级：** P0  \r\n**预估时间：** 1.5小时  \r\n**依赖：** Task 1.2\r\n\r\n**子任务：**\r\n- [ ] 1.3.1 在`proxy985.ts` API模块添加`getBusinessList()`方法\r\n- [ ] 1.3.2 在`StaticBuy.vue`页面添加业务场景下拉框\r\n- [ ] 1.3.3 实现业务场景加载逻辑\r\n- [ ] 1.3.4 更新`getInventory()`调用，传递`businessScenario`参数\r\n- [ ] 1.3.5 添加加载状态和错误处理\r\n\r\n**UI位置：**\r\n```\r\n静态住宅选购页面\r\n  └── 筛选区域\r\n      ├── IP类型选择\r\n      ├── 套餐时长选择\r\n      └── 业务场景选择 ⬅️ 新增\r\n```\r\n\r\n---\r\n\r\n### Task 1.4: 创建用户级IP池API端点\r\n**优先级：** P0  \r\n**预估时间：** 2小时  \r\n**依赖：** 数据库迁移（已完成）\r\n\r\n**子任务：**\r\n- [ ] 1.4.1 实现`PricingService.getUserIpPoolForPriceOverride(userId)`\r\n- [ ] 1.4.2 创建`GET /api/v1/price/user-ip-pool/:userId`端点\r\n- [ ] 1.4.3 添加管理员权限检查（RolesGuard）\r\n- [ ] 1.4.4 实现数据聚合逻辑（全局覆盖 + 用户覆盖）\r\n- [ ] 1.4.5 添加数据缓存策略\r\n- [ ] 1.4.6 编写集成测试\r\n\r\n**响应数据结构：**\r\n```typescript\r\ninterface UserIpPoolItem {\r\n  country: string;\r\n  city: string;\r\n  ipType: string;\r\n  originalPrice: number;\r\n  globalOverridePrice: number | null;\r\n  userOverridePrice: number | null;\r\n  currentPrice: number;\r\n  hasUserOverride: boolean;\r\n}\r\n```\r\n\r\n---\r\n\r\n### Task 1.5: 创建批量更新价格覆盖API\r\n**优先级：** P0  \r\n**预估时间：** 2小时  \r\n**依赖：** Task 1.4\r\n\r\n**子任务：**\r\n- [ ] 1.5.1 实现`PricingService.batchUpdateUserPriceOverrides(userId, updates)`\r\n- [ ] 1.5.2 创建`POST /api/v1/price/user-overrides/:userId/batch`端点\r\n- [ ] 1.5.3 添加数据验证（价格范围、必填字段）\r\n- [ ] 1.5.4 实现事务处理（全部成功或全部回滚）\r\n- [ ] 1.5.5 添加操作日志记录\r\n- [ ] 1.5.6 清除相关缓存\r\n- [ ] 1.5.7 编写单元测试和集成测试\r\n\r\n**请求示例：**\r\n```json\r\n{\r\n  \"updates\": [\r\n    {\r\n      \"country\": \"美国\",\r\n      \"city\": \"洛杉矶\",\r\n      \"ipType\": \"shared\",\r\n      \"overridePrice\": 4.99\r\n    },\r\n    {\r\n      \"country\": \"日本\",\r\n      \"city\": \"东京\",\r\n      \"ipType\": \"premium\",\r\n      \"overridePrice\": null  // 删除覆盖\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n---\r\n\r\n### Task 1.6: 前端价格覆盖对话框集成\r\n**优先级：** P0  \r\n**预估时间：** 2.5小时  \r\n**依赖：** Task 1.5\r\n\r\n**子任务：**\r\n- [ ] 1.6.1 在`admin.ts` API模块添加`getUserIpPool()`和`updateUserPriceOverrides()`\r\n- [ ] 1.6.2 在`Users.vue`添加\"价格覆盖\"按钮\r\n- [ ] 1.6.3 创建`UserPriceOverrideModal.vue`组件\r\n- [ ] 1.6.4 实现IP池数据加载和表格展示\r\n- [ ] 1.6.5 实现价格编辑功能（可编辑输入框）\r\n- [ ] 1.6.6 实现批量保存逻辑\r\n- [ ] 1.6.7 添加变更检测（只提交修改过的数据）\r\n- [ ] 1.6.8 添加加载状态、错误提示、成功反馈\r\n- [ ] 1.6.9 测试完整流程\r\n\r\n**UI位置：**\r\n```\r\n用户管理页面\r\n  └── 操作列\r\n      ├── 编辑\r\n      ├── 删除\r\n      └── 价格覆盖 ⬅️ 新增\r\n          └── 打开对话框\r\n              └── 显示用户IP池 + 价格编辑\r\n```\r\n\r\n---\r\n\r\n## Phase 2: P1 - UI/UX改进\r\n\r\n### Task 2.1: 重构账户中心页面布局\r\n**优先级：** P1  \r\n**预估时间：** 3小时  \r\n**依赖：** 无\r\n\r\n**子任务：**\r\n- [ ] 2.1.1 创建左右分栏布局结构\r\n- [ ] 2.1.2 实现左侧账户信息卡片\r\n  - [ ] 登录密码卡片\r\n  - [ ] 邮箱绑定卡片\r\n  - [ ] 通知设置卡片\r\n- [ ] 2.1.3 实现右侧快捷操作卡片\r\n  - [ ] 订购静态IP\r\n  - [ ] 动态代理管理\r\n  - [ ] 静态IP管理\r\n  - [ ] 查看订单\r\n- [ ] 2.1.4 实现右侧联系客服卡片\r\n  - [ ] 在线客服信息\r\n  - [ ] 工作时间显示\r\n  - [ ] 平均响应时间\r\n- [ ] 2.1.5 添加响应式样式（移动端上下布局）\r\n- [ ] 2.1.6 添加交互动画和过渡效果\r\n- [ ] 2.1.7 多设备测试（桌面、平板、手机）\r\n\r\n**文件路径：**\r\n- `frontend/src/views/account/AccountCenter.vue`\r\n\r\n---\r\n\r\n### Task 2.2: 修复仪表盘统计卡片渲染\r\n**优先级：** P1  \r\n**预估时间：** 1小时  \r\n**依赖：** 无\r\n\r\n**子任务：**\r\n- [ ] 2.2.1 检查`Dashboard.vue`中的`el-col` span值总和\r\n- [ ] 2.2.2 修正卡片宽度计算（确保总和=24）\r\n- [ ] 2.2.3 调整卡片间距（gutter）\r\n- [ ] 2.2.4 优化卡片内部布局（图标+文字对齐）\r\n- [ ] 2.2.5 添加响应式断点\r\n  - 桌面端：4列（每列span=6）\r\n  - 手机端：2列（每列span=12）\r\n- [ ] 2.2.6 测试不同屏幕尺寸\r\n\r\n**修复前：**\r\n```vue\r\n<!-- 错误：span总和超过24 -->\r\n<el-col :span=\"6\">...</el-col>\r\n<el-col :span=\"6\">...</el-col>\r\n<el-col :span=\"6\">...</el-col>\r\n<el-col :span=\"8\">...</el-col> <!-- ❌ 总和=26 -->\r\n```\r\n\r\n**修复后：**\r\n```vue\r\n<el-col :xs=\"12\" :sm=\"12\" :md=\"6\" :lg=\"6\">...</el-col>\r\n<el-col :xs=\"12\" :sm=\"12\" :md=\"6\" :lg=\"6\">...</el-col>\r\n<el-col :xs=\"12\" :sm=\"12\" :md=\"6\" :lg=\"6\">...</el-col>\r\n<el-col :xs=\"12\" :sm=\"12\" :md=\"6\" :lg=\"6\">...</el-col> <!-- ✅ 总和=24 -->\r\n```\r\n\r\n---\r\n\r\n### Task 2.3: 实现待处理事项数据动态化\r\n**优先级：** P1  \r\n**预估时间：** 2小时  \r\n**依赖：** 无\r\n\r\n**子任务：**\r\n- [ ] 2.3.1 创建`StatsService.getAdminPendingTasks()`方法\r\n- [ ] 2.3.2 实现数据库查询逻辑\r\n  - [ ] 查询待审核充值数量\r\n  - [ ] 查询异常订单数量\r\n  - [ ] 查询未读系统通知数量\r\n- [ ] 2.3.3 创建`GET /api/v1/stats/admin-pending-tasks`端点\r\n- [ ] 2.3.4 添加管理员权限检查\r\n- [ ] 2.3.5 在前端创建`adminStore`\r\n- [ ] 2.3.6 实现自动刷新机制（每60秒）\r\n- [ ] 2.3.7 在管理后台侧边栏显示数字徽章\r\n- [ ] 2.3.8 移除所有硬编码的\"3\"\r\n\r\n**实现文件：**\r\n- Backend: `backend/src/modules/stats/stats.service.ts`\r\n- Backend: `backend/src/modules/stats/stats.controller.ts`\r\n- Frontend: `frontend/src/stores/admin.ts`\r\n- Frontend: `frontend/src/layouts/DashboardLayout.vue`\r\n\r\n---\r\n\r\n### Task 2.4: 完善价格覆盖页面响应式设计\r\n**优先级：** P1  \r\n**预估时间：** 1.5小时  \r\n**依赖：** Task 1.6\r\n\r\n**子任务：**\r\n- [ ] 2.4.1 在`PriceOverrides.vue`添加移动端样式\r\n- [ ] 2.4.2 表格在移动端支持横向滚动\r\n- [ ] 2.4.3 筛选器在移动端堆叠显示\r\n- [ ] 2.4.4 按钮在移动端全宽显示\r\n- [ ] 2.4.5 对话框在移动端全屏显示\r\n- [ ] 2.4.6 测试各个断点\r\n\r\n**移动端样式：**\r\n```scss\r\n@media (max-width: 768px) {\r\n  .filter-container {\r\n    flex-direction: column;\r\n    .el-select,\r\n    .el-input {\r\n      width: 100%;\r\n      margin-bottom: 12px;\r\n    }\r\n  }\r\n\r\n  .table-wrapper {\r\n    overflow-x: auto;\r\n    -webkit-overflow-scrolling: touch;\r\n  }\r\n\r\n  .el-button {\r\n    width: 100%;\r\n    min-height: 44px;\r\n  }\r\n}\r\n```\r\n\r\n---\r\n\r\n### Task 2.5: 完善用户价格覆盖对话框响应式\r\n**优先级：** P1  \r\n**预估时间：** 1小时  \r\n**依赖：** Task 1.6\r\n\r\n**子任务：**\r\n- [ ] 2.5.1 对话框在移动端自适应宽度（90%）\r\n- [ ] 2.5.2 表格在移动端支持横向滚动\r\n- [ ] 2.5.3 输入框在移动端尺寸合适\r\n- [ ] 2.5.4 底部按钮在移动端堆叠显示\r\n- [ ] 2.5.5 测试各个设备尺寸\r\n\r\n---\r\n\r\n### Task 2.6: 完善静态购买页面响应式设计\r\n**优先级：** P1  \r\n**预估时间：** 1小时  \r\n**依赖：** Task 1.3\r\n\r\n**子任务：**\r\n- [ ] 2.6.1 筛选区域在移动端堆叠显示\r\n- [ ] 2.6.2 IP库存卡片在移动端单列显示\r\n- [ ] 2.6.3 购买按钮在移动端全宽显示\r\n- [ ] 2.6.4 测试完整购买流程（移动端）\r\n\r\n---\r\n\r\n### Task 2.7: 账户中心移动端交互优化\r\n**优先级：** P1  \r\n**预估时间：** 1小时  \r\n**依赖：** Task 2.1\r\n\r\n**子任务：**\r\n- [ ] 2.7.1 快捷操作按钮添加点击反馈\r\n- [ ] 2.7.2 卡片添加阴影和圆角\r\n- [ ] 2.7.3 图标和文字间距优化\r\n- [ ] 2.7.4 添加骨架屏加载效果\r\n- [ ] 2.7.5 测试触摸交互\r\n\r\n---\r\n\r\n### Task 2.8: 仪表盘图表移动端优化\r\n**优先级：** P1  \r\n**预估时间：** 1小时  \r\n**依赖：** Task 2.2\r\n\r\n**子任务：**\r\n- [ ] 2.8.1 图表在移动端自适应容器宽度\r\n- [ ] 2.8.2 图表支持触摸滚动\r\n- [ ] 2.8.3 图表工具提示在移动端正确显示\r\n- [ ] 2.8.4 统计卡片数字在移动端字号合适\r\n- [ ] 2.8.5 测试横屏和竖屏模式\r\n\r\n---\r\n\r\n### Task 2.9: 全局样式规范统一\r\n**优先级：** P1  \r\n**预估时间：** 1.5小时  \r\n**依赖：** 无\r\n\r\n**子任务：**\r\n- [ ] 2.9.1 创建响应式断点变量（SCSS）\r\n- [ ] 2.9.2 创建移动端适配混合宏（mixin）\r\n- [ ] 2.9.3 统一最小点击区域（44px）\r\n- [ ] 2.9.4 统一最小字号（14px）\r\n- [ ] 2.9.5 统一间距规范（8px倍数）\r\n- [ ] 2.9.6 更新所有页面使用统一规范\r\n\r\n**文件路径：**\r\n- `frontend/src/styles/responsive.scss` (新建)\r\n- `frontend/src/styles/variables.scss` (更新)\r\n\r\n---\r\n\r\n## Phase 3: 测试和验证\r\n\r\n### Task 3.1: 编写单元测试\r\n**优先级：** P1  \r\n**预估时间：** 2小时  \r\n**依赖：** Phase 1, Phase 2\r\n\r\n**测试覆盖：**\r\n- [ ] 3.1.1 `PricingService.getUserIpPoolForPriceOverride()`\r\n- [ ] 3.1.2 `PricingService.batchUpdateUserPriceOverrides()`\r\n- [ ] 3.1.3 `Proxy985Service.getBusinessList()`\r\n- [ ] 3.1.4 `StatsService.getAdminPendingTasks()`\r\n- [ ] 3.1.5 目标覆盖率：≥80%\r\n\r\n---\r\n\r\n### Task 3.2: 编写集成测试\r\n**优先级：** P1  \r\n**预估时间：** 1.5小时  \r\n**依赖：** Phase 1, Phase 2\r\n\r\n**测试场景：**\r\n- [ ] 3.2.1 完整的用户价格覆盖流程\r\n- [ ] 3.2.2 985Proxy API连接测试\r\n- [ ] 3.2.3 待处理事项数据查询测试\r\n- [ ] 3.2.4 业务场景加载和过滤测试\r\n\r\n---\r\n\r\n### Task 3.3: 多设备响应式测试\r\n**优先级：** P1  \r\n**预估时间：** 2小时  \r\n**依赖：** Phase 2\r\n\r\n**测试设备/尺寸：**\r\n- [ ] 3.3.1 iPhone SE (375x667)\r\n- [ ] 3.3.2 iPhone 12 Pro (390x844)\r\n- [ ] 3.3.3 iPad (768x1024)\r\n- [ ] 3.3.4 桌面 (1920x1080)\r\n- [ ] 3.3.5 桌面 (2560x1440)\r\n\r\n**测试页面：**\r\n- [ ] 账户中心\r\n- [ ] 仪表盘\r\n- [ ] 用户管理\r\n- [ ] 价格覆盖\r\n- [ ] 静态代理购买\r\n\r\n---\r\n\r\n### Task 3.4: 用户验收测试\r\n**优先级：** P1  \r\n**预估时间：** 1小时  \r\n**依赖：** Task 3.1, 3.2, 3.3\r\n\r\n**验收清单：**\r\n- [ ] 3.4.1 所有P0问题已修复并验证\r\n- [ ] 3.4.2 所有P1问题已修复并验证\r\n- [ ] 3.4.3 无新增bug或回归问题\r\n- [ ] 3.4.4 性能指标达标\r\n- [ ] 3.4.5 用户体验良好\r\n\r\n---\r\n\r\n## 任务执行顺序\r\n\r\n```\r\nPhase 1 (P0 - 关键修复)\r\n├── Task 1.1 → Task 1.2 → Task 1.3\r\n│   (985API连接 → 业务场景API → 前端集成)\r\n│\r\n└── Task 1.4 → Task 1.5 → Task 1.6\r\n    (用户IP池API → 批量更新API → 前端价格覆盖)\r\n\r\nPhase 2 (P1 - UI/UX)\r\n├── Task 2.1 (账户中心重构)\r\n├── Task 2.2 (仪表盘卡片修复)\r\n├── Task 2.3 (待处理事项动态化)\r\n├── Task 2.4-2.6 (响应式设计)\r\n├── Task 2.7-2.8 (交互优化)\r\n└── Task 2.9 (样式规范)\r\n\r\nPhase 3 (测试验证)\r\n└── Task 3.1 → Task 3.2 → Task 3.3 → Task 3.4\r\n    (单元测试 → 集成测试 → 响应式测试 → 用户验收)\r\n```\r\n\r\n---\r\n\r\n## 风险和注意事项\r\n\r\n### 高风险任务\r\n- **Task 1.1**: 985Proxy API可能不稳定，需要添加重试和降级机制\r\n- **Task 1.5**: 批量更新需要事务处理，确保数据一致性\r\n- **Task 2.3**: 查询逻辑复杂，注意性能优化\r\n\r\n### 依赖关系\r\n- Phase 2必须等待Phase 1完成\r\n- Task 1.6依赖Task 1.4和1.5\r\n- 所有响应式任务（2.4-2.8）依赖基础功能完成\r\n\r\n### 时间缓冲\r\n- 每个任务预留20%时间缓冲\r\n- 复杂任务（如Task 2.1, 2.3）可能需要额外时间\r\n- 测试阶段可能发现新问题，预留修复时间\r\n\r\n---\r\n\r\n**任务列表版本：** 1.0.0  \r\n**创建日期：** 2025-11-10  \r\n**最后更新：** 2025-11-10  \r\n**状态：** 待开始\r\n\r\n",
  "fileStats": {
    "size": 13384,
    "lines": 491,
    "lastModified": "2025-11-10T06:48:31.353Z"
  },
  "comments": []
}