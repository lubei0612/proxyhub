{
  "id": "snapshot_1762395709740_86954j4yn",
  "approvalId": "approval_1762395709726_ksbhh5gaq",
  "approvalTitle": "Design: 985Proxy Full API Integration",
  "version": 1,
  "timestamp": "2025-11-06T02:21:49.740Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: 985Proxy Full API Integration\r\n\r\n## Overview\r\n\r\nThis design document outlines the complete integration of all 7 985Proxy APIs into the ProxyHub platform. The integration will transform ProxyHub from using mock data to providing real-time proxy inventory, pricing, purchasing, and management capabilities powered by the 985Proxy service.\r\n\r\n**Scope**: Full integration of 985Proxy external API service including:\r\n- Real-time inventory checking\r\n- Dynamic price calculation\r\n- Live IP list management\r\n- IP detail queries\r\n- IP renewal functionality\r\n- Order status tracking\r\n- Business channel (Zone) management\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- **NestJS Modules**: All new services follow NestJS dependency injection patterns\r\n- **Service Layer Architecture**: Business logic separated from API controllers\r\n- **Error Handling**: Consistent exception handling with custom error types\r\n- **Logging**: Structured logging for all external API calls\r\n- **Environment Configuration**: All API credentials managed via `.env` file\r\n\r\n### Project Structure (structure.md)\r\n- **Backend**: `backend/src/modules/proxy985/` - Dedicated module for 985Proxy integration\r\n- **Frontend**: `frontend/src/api/static-proxy.ts` - API client methods\r\n- **Frontend Components**: `frontend/src/views/` - UI components for displaying data\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n\r\n1. **Proxy985Service** (`backend/src/modules/proxy985/proxy985.service.ts`)\r\n   - Already has `buyStaticProxy` method (recently fixed)\r\n   - Will be extended with 6 additional API methods\r\n   - Existing HTTP client setup will be reused\r\n\r\n2. **StaticProxyService** (`backend/src/modules/proxy/static/static-proxy.service.ts`)\r\n   - Currently handles purchase flow (recently updated to call real API)\r\n   - Will be extended to handle inventory checking, renewal, and IP management\r\n   - Existing database transaction logic will be leveraged\r\n\r\n3. **StaticProxyController** (`backend/src/modules/proxy/static/static-proxy.controller.ts`)\r\n   - Will add new endpoints for inventory, IP list, renewal, etc.\r\n   - Existing authentication guards will be reused\r\n\r\n4. **Frontend API Client** (`frontend/src/api/static-proxy.ts`)\r\n   - Will add new methods for calling new backend endpoints\r\n   - Existing axios interceptors handle authentication\r\n\r\n5. **Dashboard Component** (`frontend/src/views/Dashboard.vue`)\r\n   - Will integrate real-time statistics from 985Proxy\r\n   - Will replace mock data with live API calls\r\n\r\n### Integration Points\r\n\r\n- **Database**: `static_proxies` table will store additional fields (order_no, expiration tracking)\r\n- **Redis**: Will cache inventory data and pricing calculations (5-minute TTL)\r\n- **Authentication**: All endpoints require JWT authentication\r\n- **Transaction Management**: Critical operations (purchase, renewal) wrapped in DB transactions\r\n\r\n## Architecture\r\n\r\n### System Architecture Diagram\r\n\r\n```mermaid\r\ngraph TD\r\n    A[Frontend Dashboard] -->|HTTP/REST| B[NestJS Backend]\r\n    B -->|Inject| C[StaticProxyController]\r\n    C -->|Inject| D[StaticProxyService]\r\n    D -->|Inject| E[Proxy985Service]\r\n    E -->|HTTPS| F[985Proxy External API]\r\n    D -->|Read/Write| G[(PostgreSQL Database)]\r\n    E -->|Cache| H[(Redis Cache)]\r\n    \r\n    subgraph Backend Module\r\n        C\r\n        D\r\n        E\r\n    end\r\n    \r\n    subgraph External Services\r\n        F\r\n        H\r\n    end\r\n```\r\n\r\n### Data Flow\r\n\r\n1. **Inventory Check Flow**\r\n   ```\r\n   User opens purchase page → Frontend calls /api/v1/static-proxy/inventory\r\n   → StaticProxyController → StaticProxyService → Proxy985Service.getStock()\r\n   → Check Redis cache → If miss, call 985Proxy API → Cache result (5 min)\r\n   → Return to frontend → Display available countries/cities\r\n   ```\r\n\r\n2. **Purchase Flow** (Enhanced)\r\n   ```\r\n   User submits purchase → Frontend calls calculate API first → Display total price\r\n   → User confirms → Call purchase API → StaticProxyService.purchase()\r\n   → Call 985Proxy buy API → Get order_no → Poll order_result API\r\n   → When success, call ip_list API → Get actual IPs → Save to DB\r\n   → Return success to user\r\n   ```\r\n\r\n3. **IP Management Flow**\r\n   ```\r\n   User views \"My Proxies\" → Call /api/v1/static-proxy/my-ips\r\n   → StaticProxyService queries DB + calls ip_list API → Merge data\r\n   → Display IP list with expiration dates → User can renew\r\n   ```\r\n\r\n### Modular Design Principles\r\n\r\n- **Single File Responsibility**: \r\n  - `proxy985.service.ts` handles ONLY external API calls\r\n  - `static-proxy.service.ts` handles ONLY business logic\r\n  - Controllers handle ONLY HTTP request/response\r\n\r\n- **Component Isolation**: \r\n  - Frontend components are split: `PurchaseForm.vue`, `IPList.vue`, `RenewalDialog.vue`\r\n\r\n- **Service Layer Separation**: \r\n  - Data access: TypeORM repositories\r\n  - Business logic: Service classes\r\n  - Presentation: Controllers and Vue components\r\n\r\n## Components and Interfaces\r\n\r\n### Backend Component 1: Proxy985Service\r\n\r\n**File**: `backend/src/modules/proxy985/proxy985.service.ts`\r\n\r\n**Purpose**: Low-level HTTP client for all 985Proxy API endpoints\r\n\r\n**New Interfaces** (7 methods):\r\n\r\n```typescript\r\n// 1. Get stock/inventory\r\nasync getStock(params: {\r\n  zone: string;\r\n  time_period: number;\r\n  static_proxy_type: 'shared' | 'premium';\r\n}): Promise<{\r\n  code: number;\r\n  data: Array<{\r\n    country_code: string;\r\n    country_name: string;\r\n    stock: number;\r\n    cities: Array<{\r\n      city_name: string;\r\n      stock: number;\r\n    }>;\r\n  }>;\r\n}>\r\n\r\n// 2. Calculate price\r\nasync calculatePrice(data: {\r\n  zone: string;\r\n  time_period: number;\r\n  static_proxy_type: 'shared' | 'premium';\r\n  buy_data: Array<{\r\n    country_code: string;\r\n    city_name?: string;\r\n    count: number;\r\n  }>;\r\n}): Promise<{\r\n  code: number;\r\n  data: {\r\n    amount: number;\r\n    currency: string;\r\n  };\r\n}>\r\n\r\n// 3. Get IP list\r\nasync getIPList(params: {\r\n  zone: string;\r\n  page?: number;\r\n  per_page?: number;\r\n  country_code?: string;\r\n  ip?: string;\r\n}): Promise<{\r\n  code: number;\r\n  data: {\r\n    data: Array<{\r\n      ip: string;\r\n      port: number;\r\n      username: string;\r\n      password: string;\r\n      country_code: string;\r\n      city_name: string;\r\n      expire_at: string;\r\n      plan: string;\r\n    }>;\r\n    total: number;\r\n    per_page: number;\r\n    current_page: number;\r\n  };\r\n}>\r\n\r\n// 4. Get IP detail\r\nasync getIPDetail(params: {\r\n  zone: string;\r\n  ip: string;\r\n}): Promise<{\r\n  code: number;\r\n  data: {\r\n    ip: string;\r\n    port: number;\r\n    username: string;\r\n    password: string;\r\n    country_code: string;\r\n    city_name: string;\r\n    expire_at: string;\r\n    plan: string;\r\n  };\r\n}>\r\n\r\n// 5. Renew IP\r\nasync renewIP(data: {\r\n  zone: string;\r\n  ip: string;\r\n  time_period: number;\r\n}): Promise<{\r\n  code: number;\r\n  data: {\r\n    order_no: string;\r\n  };\r\n}>\r\n\r\n// 6. Get order result\r\nasync getOrderResult(params: {\r\n  zone: string;\r\n  order_no: string;\r\n}): Promise<{\r\n  code: number;\r\n  data: {\r\n    order_no: string;\r\n    status: 'pending' | 'completed' | 'failed';\r\n    amount: number;\r\n    currency: string;\r\n  };\r\n}>\r\n\r\n// 7. Get business list (zones)\r\nasync getBusinessList(): Promise<{\r\n  code: number;\r\n  data: Array<{\r\n    zone: string;\r\n    name: string;\r\n    status: string;\r\n  }>;\r\n}>\r\n```\r\n\r\n**Dependencies**: \r\n- `@nestjs/common` (Injectable, Logger, HttpException)\r\n- `axios` (HTTP client)\r\n- Environment variables: `PROXY_985_API_KEY`, `PROXY_985_ZONE`\r\n\r\n**Reuses**: Existing `client` (axios instance), existing error handling pattern\r\n\r\n---\r\n\r\n### Backend Component 2: StaticProxyService (Enhanced)\r\n\r\n**File**: `backend/src/modules/proxy/static/static-proxy.service.ts`\r\n\r\n**Purpose**: Business logic layer that orchestrates 985Proxy API calls with database operations\r\n\r\n**New Methods**:\r\n\r\n```typescript\r\n// Get available inventory with caching\r\nasync getInventory(ipType: string, duration: number): Promise<InventoryDto>\r\n\r\n// Calculate total price before purchase\r\nasync calculatePurchasePrice(dto: PurchaseStaticProxyDto): Promise<PriceDto>\r\n\r\n// List user's purchased IPs (paginated)\r\nasync listMyIPs(userId: string, page: number, limit: number): Promise<MyIPsDto>\r\n\r\n// Get single IP details\r\nasync getIPDetails(userId: string, ip: string): Promise<IPDetailDto>\r\n\r\n// Renew an IP\r\nasync renewIP(userId: string, ip: string, duration: number): Promise<RenewalResultDto>\r\n\r\n// Check order status\r\nasync checkOrderStatus(userId: string, orderNo: string): Promise<OrderStatusDto>\r\n\r\n// Sync IPs from 985Proxy (admin only, called by cron job)\r\nasync syncIPsFromRemote(): Promise<SyncResultDto>\r\n```\r\n\r\n**Dependencies**: \r\n- `Proxy985Service` (injected)\r\n- `StaticProxyRepository` (database)\r\n- `RedisService` (caching)\r\n- `TransactionService` (database transactions)\r\n\r\n**Reuses**: \r\n- Existing `purchaseStaticProxy` method\r\n- Existing balance checking logic\r\n- Existing transaction creation logic\r\n\r\n---\r\n\r\n### Backend Component 3: StaticProxyController (Enhanced)\r\n\r\n**File**: `backend/src/modules/proxy/static/static-proxy.controller.ts`\r\n\r\n**Purpose**: HTTP endpoints for frontend to call\r\n\r\n**New Routes**:\r\n\r\n```typescript\r\n// GET /api/v1/static-proxy/inventory\r\n@Get('inventory')\r\n@UseGuards(JwtAuthGuard)\r\nasync getInventory(@Query() query: InventoryQueryDto)\r\n\r\n// POST /api/v1/static-proxy/calculate-price\r\n@Post('calculate-price')\r\n@UseGuards(JwtAuthGuard)\r\nasync calculatePrice(@Body() dto: PurchaseStaticProxyDto)\r\n\r\n// GET /api/v1/static-proxy/my-ips\r\n@Get('my-ips')\r\n@UseGuards(JwtAuthGuard)\r\nasync getMyIPs(@Request() req, @Query() query: PaginationDto)\r\n\r\n// GET /api/v1/static-proxy/ip/:ip\r\n@Get('ip/:ip')\r\n@UseGuards(JwtAuthGuard)\r\nasync getIPDetail(@Request() req, @Param('ip') ip: string)\r\n\r\n// POST /api/v1/static-proxy/renew\r\n@Post('renew')\r\n@UseGuards(JwtAuthGuard)\r\nasync renewIP(@Request() req, @Body() dto: RenewIPDto)\r\n\r\n// GET /api/v1/static-proxy/order/:orderNo\r\n@Get('order/:orderNo')\r\n@UseGuards(JwtAuthGuard)\r\nasync getOrderStatus(@Request() req, @Param('orderNo') orderNo: string)\r\n```\r\n\r\n**Dependencies**: JwtAuthGuard, StaticProxyService\r\n\r\n**Reuses**: Existing guards, existing response formatting\r\n\r\n---\r\n\r\n### Frontend Component 1: Enhanced Purchase Form\r\n\r\n**File**: `frontend/src/views/proxy/StaticProxy.vue`\r\n\r\n**Purpose**: Show real-time inventory and pricing\r\n\r\n**Changes**:\r\n- Add inventory API call on component mount\r\n- Show available countries/cities dynamically\r\n- Add \"Calculate Price\" button before purchase\r\n- Display calculated price preview\r\n- Disable \"Purchase\" if insufficient balance\r\n\r\n**New API Calls**:\r\n```typescript\r\nimport { getInventory, calculatePrice, purchaseProxy } from '@/api/static-proxy'\r\n\r\n// On mount\r\nconst inventory = await getInventory({ ipType, duration })\r\n\r\n// On form change\r\nconst price = await calculatePrice(formData)\r\n\r\n// On submit\r\nconst result = await purchaseProxy(formData)\r\n```\r\n\r\n---\r\n\r\n### Frontend Component 2: My IPs List\r\n\r\n**File**: `frontend/src/views/proxy/MyProxies.vue` (new file)\r\n\r\n**Purpose**: Display user's purchased IPs with management options\r\n\r\n**Features**:\r\n- Paginated IP list\r\n- Filter by country\r\n- Search by IP\r\n- Show expiration countdown\r\n- \"Renew\" button for each IP\r\n- \"View Details\" link\r\n\r\n**API Calls**:\r\n```typescript\r\nimport { getMyIPs, getIPDetail, renewIP } from '@/api/static-proxy'\r\n```\r\n\r\n---\r\n\r\n### Frontend Component 3: Dashboard Statistics\r\n\r\n**File**: `frontend/src/views/Dashboard.vue`\r\n\r\n**Purpose**: Show real-time statistics from 985Proxy\r\n\r\n**Enhancements**:\r\n- Replace mock total_ips with count from `getMyIPs` API\r\n- Add \"Active IPs\" widget (count of non-expired IPs)\r\n- Add \"Expiring Soon\" widget (IPs expiring in < 7 days)\r\n- Add \"Available Balance\" from user account\r\n\r\n---\r\n\r\n## Data Models\r\n\r\n### Database Schema Extension\r\n\r\n**Table**: `static_proxies` (existing, add new fields)\r\n\r\n```sql\r\nALTER TABLE static_proxies \r\nADD COLUMN order_no VARCHAR(255),\r\nADD COLUMN expire_at TIMESTAMP,\r\nADD COLUMN plan VARCHAR(50),\r\nADD COLUMN last_synced_at TIMESTAMP,\r\nADD INDEX idx_expire_at (expire_at),\r\nADD INDEX idx_order_no (order_no);\r\n```\r\n\r\n### New DTOs (Data Transfer Objects)\r\n\r\n**InventoryDto**\r\n```typescript\r\ninterface InventoryDto {\r\n  countries: Array<{\r\n    countryCode: string;\r\n    countryName: string;\r\n    stock: number;\r\n    cities: Array<{\r\n      cityName: string;\r\n      stock: number;\r\n    }>;\r\n  }>;\r\n}\r\n```\r\n\r\n**PriceDto**\r\n```typescript\r\ninterface PriceDto {\r\n  amount: number;\r\n  currency: string;\r\n  breakdown: Array<{\r\n    country: string;\r\n    city?: string;\r\n    quantity: number;\r\n    unitPrice: number;\r\n    subtotal: number;\r\n  }>;\r\n}\r\n```\r\n\r\n**MyIPsDto**\r\n```typescript\r\ninterface MyIPsDto {\r\n  data: Array<{\r\n    ip: string;\r\n    port: number;\r\n    username: string;\r\n    password: string;\r\n    country: string;\r\n    city: string;\r\n    expiresAt: string;\r\n    daysRemaining: number;\r\n    status: 'active' | 'expiring_soon' | 'expired';\r\n  }>;\r\n  total: number;\r\n  page: number;\r\n  perPage: number;\r\n}\r\n```\r\n\r\n**RenewalResultDto**\r\n```typescript\r\ninterface RenewalResultDto {\r\n  success: boolean;\r\n  orderNo: string;\r\n  newExpirationDate: string;\r\n  amountCharged: number;\r\n}\r\n```\r\n\r\n---\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n1. **Scenario: 985Proxy API Rate Limit**\r\n   - **Handling**: Catch 429 status, implement exponential backoff, cache results longer\r\n   - **User Impact**: Show \"Service busy, please try again in a moment\"\r\n\r\n2. **Scenario: Insufficient Balance**\r\n   - **Handling**: Check balance before calling 985Proxy API\r\n   - **User Impact**: Show \"Insufficient balance\" with recharge button\r\n\r\n3. **Scenario: Out of Stock**\r\n   - **Handling**: Inventory API returns 0 stock\r\n   - **User Impact**: Disable country/city selection, show \"Out of stock\"\r\n\r\n4. **Scenario: Order Pending**\r\n   - **Handling**: Poll order_result API every 3 seconds (max 10 attempts)\r\n   - **User Impact**: Show loading spinner \"Processing your order...\"\r\n\r\n5. **Scenario: IP Already Expired**\r\n   - **Handling**: Check expiration before renewal\r\n   - **User Impact**: Show \"This IP has expired and cannot be renewed\"\r\n\r\n6. **Scenario: Network Timeout**\r\n   - **Handling**: Set 30s timeout, retry once\r\n   - **User Impact**: Show \"Request timeout, please try again\"\r\n\r\n---\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n**Backend Services**:\r\n- Mock 985Proxy API responses\r\n- Test each Proxy985Service method with mock axios\r\n- Test StaticProxyService business logic with mock Proxy985Service\r\n- Test price calculations\r\n- Test inventory caching logic\r\n\r\n**Frontend Components**:\r\n- Mock API calls\r\n- Test component rendering with various data states\r\n- Test error handling UI\r\n\r\n### Integration Testing\r\n\r\n**API Flow Testing**:\r\n- Test full purchase flow: inventory → calculate → buy → order status → IP list\r\n- Test renewal flow: get IP → renew → check order → verify new expiration\r\n- Test with `PROXY_985_TEST_MODE=true` to avoid real charges\r\n\r\n**Database Testing**:\r\n- Test transaction rollback on API failure\r\n- Test IP sync logic\r\n\r\n### End-to-End Testing\r\n\r\n**User Scenarios**:\r\n1. User opens purchase page → sees real inventory → calculates price → purchases → sees new IP in \"My IPs\"\r\n2. User opens \"My IPs\" → sees expiring IP → clicks renew → completes renewal → expiration date updated\r\n3. Admin opens dashboard → sees real statistics → clicks \"Sync IPs\" → IPs synchronized\r\n\r\n**Testing with Chrome DevTools MCP**:\r\n- Navigate to purchase page\r\n- Fill form with real data\r\n- Verify inventory displayed correctly\r\n- Calculate price and verify amount\r\n- Complete purchase and verify deduction from 985Proxy balance\r\n- Check \"My IPs\" and verify IP appears\r\n\r\n---\r\n\r\n## Performance Considerations\r\n\r\n### Caching Strategy\r\n\r\n- **Inventory Data**: 5-minute Redis cache (key: `inventory:${zone}:${ipType}:${duration}`)\r\n- **IP List**: 30-second cache per user (key: `user_ips:${userId}`)\r\n- **Price Calculation**: 1-minute cache (key: `price:${hash(params)}`)\r\n\r\n### Rate Limiting\r\n\r\n- Max 10 requests/minute per user for inventory checks\r\n- Max 5 purchase attempts/minute per user\r\n- Admin sync: Max once per 10 minutes\r\n\r\n### Database Optimization\r\n\r\n- Add indexes on `expire_at`, `order_no`, `user_id`\r\n- Use pagination for IP lists (default 20 per page)\r\n- Batch IP sync updates (100 IPs per transaction)\r\n\r\n---\r\n\r\n## Security Considerations\r\n\r\n- **API Key Protection**: Store in `.env`, never expose to frontend\r\n- **Zone ID Validation**: Verify user owns the zone before API calls\r\n- **Input Sanitization**: Validate all user inputs (country codes, IP addresses)\r\n- **Rate Limiting**: Prevent abuse of expensive API calls\r\n- **Transaction Integrity**: Use DB transactions for financial operations\r\n\r\n---\r\n\r\n## Deployment Checklist\r\n\r\n1. ✅ Update `.env` with correct `PROXY_985_ZONE` and `PROXY_985_API_KEY`\r\n2. ✅ Run database migration to add new fields\r\n3. ✅ Set `PROXY_985_TEST_MODE=false` for production\r\n4. ✅ Deploy backend with new endpoints\r\n5. ✅ Deploy frontend with new components\r\n6. ✅ Test purchase flow with small amount ($1-2)\r\n7. ✅ Monitor logs for API errors\r\n8. ✅ Set up cron job for IP sync (runs every 6 hours)\r\n\r\n---\r\n\r\n## Success Metrics\r\n\r\n- ✅ All 7 985Proxy APIs integrated and functional\r\n- ✅ Real-time inventory displayed on purchase page\r\n- ✅ Successful test purchase with actual deduction from 985Proxy balance\r\n- ✅ \"My IPs\" page shows live data from 985Proxy\r\n- ✅ IP renewal works correctly\r\n- ✅ Dashboard statistics reflect real data\r\n- ✅ No mock data remaining in critical flows\r\n\r\n",
  "fileStats": {
    "size": 17646,
    "lines": 630,
    "lastModified": "2025-11-06T02:21:40.923Z"
  },
  "comments": []
}