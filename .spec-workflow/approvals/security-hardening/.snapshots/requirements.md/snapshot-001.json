{
  "id": "snapshot_1762776976822_e6n9xilmh",
  "approvalId": "approval_1762776976779_20140e9ue",
  "approvalTitle": "Security Hardening Requirements - Phase 1",
  "version": 1,
  "timestamp": "2025-11-10T12:16:16.822Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\r\n\r\n## Introduction\r\n\r\nThis specification addresses critical security vulnerabilities, architecture weaknesses, and technical debt identified in the ProxyHub codebase. The goal is to transform the current MVP into a production-ready, secure, and maintainable system that follows industry best practices and security standards.\r\n\r\n**Value Proposition:**\r\n- Protect user data and prevent security breaches\r\n- Reduce technical debt and improve code maintainability\r\n- Enable safe scaling and future feature development\r\n- Establish foundation for long-term product success\r\n\r\n## Alignment with Product Vision\r\n\r\nThis aligns with ProxyHub's core values of:\r\n- **Security**: Protecting customer proxy credentials and payment information\r\n- **Reliability**: Building a stable platform users can depend on\r\n- **Professional Service**: Providing enterprise-grade proxy management\r\n\r\n## Requirements\r\n\r\n### Requirement 1: Remove All Hardcoded Secrets\r\n\r\n**User Story:** As a security-conscious platform operator, I want all sensitive credentials removed from source code, so that our codebase can be safely shared and our keys cannot be compromised.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN the application starts THEN the system SHALL validate that all required environment variables are configured\r\n2. IF JWT_SECRET is not set or is the default value THEN the system SHALL refuse to start with a clear error message\r\n3. WHEN any API key (985Proxy, email, Telegram) is missing THEN the system SHALL log a warning and disable that feature gracefully\r\n4. IF JWT_SECRET length is less than 32 characters THEN the system SHALL reject it and refuse to start\r\n5. WHEN developers check out the code THEN they SHALL find a comprehensive .env.example file with all required variables documented\r\n\r\n**Priority:** P0 - Critical Security Fix\r\n**Effort Estimate:** 4 hours\r\n\r\n---\r\n\r\n### Requirement 2: Implement Strong Password Policy\r\n\r\n**User Story:** As a platform user, I want my account protected by strong password requirements, so that my data and proxy access remain secure.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN a user registers THEN the system SHALL enforce password requirements: minimum 8 characters, at least 1 uppercase, 1 lowercase, and 1 number\r\n2. IF a password fails strength validation THEN the system SHALL return a specific error message explaining requirements\r\n3. WHEN validating passwords THEN the system SHALL reject common weak passwords from a blocklist\r\n4. WHEN users change passwords THEN the system SHALL apply the same validation rules\r\n5. WHEN implementing validation THEN the system SHALL use class-validator decorators for consistency\r\n\r\n**Priority:** P0 - Critical Security Fix\r\n**Effort Estimate:** 2 hours\r\n\r\n---\r\n\r\n### Requirement 3: Add Rate Limiting Protection\r\n\r\n**User Story:** As a platform operator, I want API endpoints protected from brute force attacks, so that malicious actors cannot compromise accounts or overwhelm our services.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN implementing rate limiting THEN the system SHALL use @nestjs/throttler package\r\n2. WHEN users attempt login THEN the system SHALL allow maximum 5 attempts per 15 minutes per IP\r\n3. WHEN users request verification codes THEN the system SHALL allow maximum 3 requests per hour per email\r\n4. IF rate limit is exceeded THEN the system SHALL return HTTP 429 with retry-after header\r\n5. WHEN rate limits apply THEN the system SHALL log excessive attempts for security monitoring\r\n6. WHEN implementing THEN the system SHALL use Redis for distributed rate limiting\r\n\r\n**Priority:** P0 - Critical Security Fix\r\n**Effort Estimate:** 3 hours\r\n\r\n---\r\n\r\n### Requirement 4: Implement Global Exception Filter\r\n\r\n**User Story:** As a platform operator, I want errors handled consistently without exposing sensitive information, so that our system is both user-friendly and secure.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN any exception occurs THEN the system SHALL catch it with a global filter\r\n2. IF the error contains sensitive data THEN the system SHALL sanitize it before logging\r\n3. WHEN returning errors to clients THEN the system SHALL use standardized format: { statusCode, message, errorCode, timestamp }\r\n4. IF the environment is production THEN the system SHALL hide stack traces from responses\r\n5. WHEN errors occur THEN the system SHALL log full details (including stack trace) to logging service\r\n6. WHEN implementing THEN the system SHALL create AllExceptionsFilter with proper error mapping\r\n\r\n**Priority:** P1 - High Priority\r\n**Effort Estimate:** 3 hours\r\n\r\n---\r\n\r\n### Requirement 5: Add Input Length Validation\r\n\r\n**User Story:** As a platform operator, I want all user inputs validated for reasonable lengths, so that our database remains protected from overflow attacks.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN users submit any text input THEN the system SHALL enforce maximum length constraints\r\n2. WHEN validating email THEN the system SHALL enforce maximum 255 characters\r\n3. WHEN validating nickname THEN the system SHALL enforce maximum 100 characters\r\n4. WHEN validating free-form text THEN the system SHALL enforce maximum 1000 characters\r\n5. IF input exceeds length limits THEN the system SHALL return validation error with specific field and limit\r\n6. WHEN implementing THEN the system SHALL use @MaxLength decorator from class-validator\r\n\r\n**Priority:** P1 - High Priority\r\n**Effort Estimate:** 2 hours\r\n\r\n---\r\n\r\n### Requirement 6: Implement Database Transaction Safety\r\n\r\n**User Story:** As a platform operator, I want financial transactions protected from race conditions, so that user balances remain accurate even under concurrent load.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN deducting user balance THEN the system SHALL use database transaction with row-level locking\r\n2. IF balance is insufficient THEN the transaction SHALL rollback atomically\r\n3. WHEN processing proxy purchases THEN the system SHALL wrap balance deduction and proxy creation in a single transaction\r\n4. IF any step fails THEN the system SHALL rollback all changes and return clear error\r\n5. WHEN implementing THEN the system SHALL use TypeORM QueryRunner for transaction management\r\n6. WHEN concurrent requests access same user balance THEN the system SHALL handle them serially without data corruption\r\n\r\n**Priority:** P1 - High Priority\r\n**Effort Estimate:** 4 hours\r\n\r\n---\r\n\r\n### Requirement 7: Add Comprehensive Unit Tests\r\n\r\n**User Story:** As a developer, I want critical business logic covered by tests, so that I can refactor safely and catch bugs early.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN testing authentication THEN the system SHALL have tests for login, registration, token validation, and password reset\r\n2. WHEN testing pricing THEN the system SHALL have tests for price calculations, overrides, and discount logic\r\n3. WHEN testing user balance THEN the system SHALL have tests for deposit, deduction, and concurrent access\r\n4. IF any test fails THEN CI/CD pipeline SHALL block deployment\r\n5. WHEN implementing THEN the system SHALL achieve minimum 70% code coverage for services\r\n6. WHEN writing tests THEN the system SHALL use Jest and follow AAA pattern (Arrange-Act-Assert)\r\n\r\n**Priority:** P2 - Technical Debt\r\n**Effort Estimate:** 12 hours\r\n\r\n---\r\n\r\n### Requirement 8: Enhance Security Headers and CORS\r\n\r\n**User Story:** As a security engineer, I want proper security headers and CORS policies configured, so that our application is protected from common web attacks.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN serving responses THEN the system SHALL include security headers via Helmet middleware\r\n2. WHEN configuring CORS THEN the system SHALL use environment-based allowed origins\r\n3. IF environment is production THEN CORS SHALL only allow configured production domains\r\n4. IF environment is development THEN CORS SHALL allow localhost origins\r\n5. WHEN implementing THEN the system SHALL set: X-Frame-Options, X-Content-Type-Options, Strict-Transport-Security\r\n6. WHEN implementing THEN the system SHALL disable X-Powered-By header\r\n\r\n**Priority:** P1 - High Priority\r\n**Effort Estimate:** 2 hours\r\n\r\n---\r\n\r\n### Requirement 9: Implement Sensitive Data Logging Filter\r\n\r\n**User Story:** As a compliance officer, I want logs cleaned of sensitive data, so that we don't accidentally expose passwords, tokens, or payment information.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN logging objects THEN the system SHALL automatically redact fields: password, token, apiKey, creditCard\r\n2. WHEN errors include request bodies THEN the system SHALL sanitize before logging\r\n3. IF log contains JWT token THEN the system SHALL mask all but last 4 characters\r\n4. WHEN implementing THEN the system SHALL create a LoggingSanitizer utility\r\n5. WHEN developers log data THEN they SHALL use sanitized logger wrapper\r\n6. WHEN implementing THEN the system SHALL provide logger.sanitize(obj) helper method\r\n\r\n**Priority:** P2 - Technical Debt\r\n**Effort Estimate:** 3 hours\r\n\r\n---\r\n\r\n### Requirement 10: Add Environment Configuration Validation\r\n\r\n**User Story:** As a DevOps engineer, I want configuration validated at startup, so that I catch misconfigurations before they cause runtime errors.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN application starts THEN the system SHALL validate all environment variables against a schema\r\n2. IF required variables are missing THEN the system SHALL list all missing vars and exit with error code 1\r\n3. IF variables have invalid format THEN the system SHALL explain expected format\r\n4. WHEN validating JWT_SECRET THEN the system SHALL ensure minimum 32 character length\r\n5. WHEN validating database config THEN the system SHALL ensure all connection params are present\r\n6. WHEN implementing THEN the system SHALL use @nestjs/config with Joi schema validation\r\n\r\n**Priority:** P0 - Critical Security Fix\r\n**Effort Estimate:** 3 hours\r\n\r\n---\r\n\r\n## Non-Functional Requirements\r\n\r\n### Code Architecture and Modularity\r\n- **Single Responsibility Principle**: Each service handles one domain concern (auth, billing, proxy management)\r\n- **Modular Design**: Security utilities isolated in common/security module\r\n- **Dependency Management**: Security features injectable via NestJS DI\r\n- **Clear Interfaces**: DTOs with class-validator provide input contracts\r\n\r\n### Performance\r\n- **Rate Limiting**: Redis-backed for sub-millisecond checks\r\n- **Transaction Overhead**: Database transactions add <50ms overhead\r\n- **Validation Speed**: Input validation adds <5ms per request\r\n- **No Breaking Changes**: All changes maintain backward API compatibility\r\n\r\n### Security\r\n- **Zero Hardcoded Secrets**: All credentials from environment\r\n- **Defense in Depth**: Multiple layers (rate limiting, validation, transactions)\r\n- **Secure Defaults**: Fail closed when config missing\r\n- **Audit Trail**: All security events logged with context\r\n\r\n### Reliability\r\n- **Graceful Degradation**: Non-critical services (email, Telegram) fail gracefully\r\n- **Idempotent Operations**: Financial transactions safe to retry\r\n- **Error Recovery**: Clear error messages guide remediation\r\n- **Health Checks**: Startup validation prevents bad deploys\r\n\r\n### Maintainability\r\n- **Test Coverage**: 70% minimum for critical paths\r\n- **Documentation**: Security decisions documented in code comments\r\n- **Code Reviews**: All security changes require review\r\n- **Technical Debt Tracking**: Remaining TODOs tracked in issues\r\n\r\n### Usability\r\n- **Developer Experience**: Clear error messages during development\r\n- **Deployment Safety**: Configuration errors caught at startup\r\n- **Debugging Support**: Detailed (sanitized) logs for troubleshooting\r\n- **Migration Path**: Existing deployments get clear upgrade instructions\r\n\r\n",
  "fileStats": {
    "size": 11731,
    "lines": 238,
    "lastModified": "2025-11-10T12:16:06.491Z"
  },
  "comments": []
}