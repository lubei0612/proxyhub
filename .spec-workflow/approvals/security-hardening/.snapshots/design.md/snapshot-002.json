{
  "id": "snapshot_1762777525372_668zpe5ie",
  "approvalId": "approval_1762777515188_cifhn92fl",
  "approvalTitle": "Security Hardening Design - Phase 2",
  "version": 2,
  "timestamp": "2025-11-10T12:25:25.372Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\r\n\r\n## Overview\r\n\r\nThis design outlines the technical implementation of security enhancements for ProxyHub. The approach follows NestJS best practices, maintains backward compatibility, and integrates seamlessly with the existing modular architecture. The implementation prioritizes fail-safe defaults, defense-in-depth, and clear separation of concerns.\r\n\r\n**Core Design Principles:**\r\n- **Security by Default**: All new configurations require explicit setup, failing closed when missing\r\n- **Modular Integration**: Security features added as reusable modules and guards\r\n- **Backward Compatibility**: Existing APIs remain unchanged; only internal improvements\r\n- **Progressive Enhancement**: Features can be enabled incrementally without breaking deployments\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n\r\n**NestJS Patterns:**\r\n- Use dependency injection for all security services\r\n- Guards for rate limiting and authentication\r\n- Pipes for validation enhancement\r\n- Interceptors for logging sanitization\r\n- Filters for exception handling\r\n\r\n**TypeScript Best Practices:**\r\n- Strong typing for all DTOs and configurations\r\n- Interface contracts for security utilities\r\n- Enum-based error codes\r\n\r\n### Project Structure (structure.md)\r\n\r\n**New Security Module Structure:**\r\n```\r\nbackend/src/\r\n├── common/\r\n│   ├── security/                 # NEW: Security utilities\r\n│   │   ├── config-validator.ts\r\n│   │   ├── password-validator.ts\r\n│   │   ├── logging-sanitizer.ts\r\n│   │   └── security.module.ts\r\n│   ├── filters/                  # NEW: Exception filters\r\n│   │   └── all-exceptions.filter.ts\r\n│   └── guards/                   # ENHANCED: Add rate limit guards\r\n│       ├── jwt-auth.guard.ts    # Existing\r\n│       └── rate-limit.guard.ts  # NEW\r\n```\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n\r\n- **@nestjs/config (ConfigModule)**: Already configured globally - extend with validation\r\n- **@nestjs/throttler (ThrottlerModule)**: Already imported - configure with Redis storage\r\n- **class-validator**: Already used for DTOs - add new decorators for password strength\r\n- **bcrypt**: Already used for password hashing - keep existing implementation\r\n- **Redis Client**: Already configured in app.module.ts - use for distributed rate limiting\r\n- **ValidationPipe**: Already enabled globally - extend with additional rules\r\n\r\n### Integration Points\r\n\r\n- **AuthModule**: Add password strength validation to DTOs, enhance JWT strategy\r\n- **ConfigModule**: Add schema validation at startup\r\n- **main.ts**: Register global exception filter, configure Helmet middleware\r\n- **All Controllers**: Optionally apply rate limiting guards via decorators\r\n- **Database Transactions**: Enhance BillingModule and UserModule with transaction wrappers\r\n- **Logging**: Create wrapper around NestJS Logger with sanitization\r\n\r\n## Architecture\r\n\r\n### Security Layers\r\n\r\n```mermaid\r\ngraph TD\r\n    A[HTTP Request] --> B[Helmet Middleware]\r\n    B --> C[CORS Check]\r\n    C --> D[Rate Limit Guard]\r\n    D --> E[JWT Auth Guard]\r\n    E --> F[Validation Pipe]\r\n    F --> G[Controller Handler]\r\n    G --> H[Service Layer]\r\n    H --> I[Transaction Wrapper]\r\n    I --> J[Database]\r\n    G --> K[Exception Filter]\r\n    K --> L[Sanitized Response]\r\n    \r\n    style B fill:#f9f,stroke:#333\r\n    style D fill:#f9f,stroke:#333\r\n    style F fill:#f9f,stroke:#333\r\n    style K fill:#f9f,stroke:#333\r\n    style I fill:#f9f,stroke:#333\r\n```\r\n\r\n### Modular Design Principles\r\n\r\n- **Single File Responsibility**: Each security utility handles one concern (validation, sanitization, rate limiting)\r\n- **Component Isolation**: Security module is standalone, injectable into any module\r\n- **Service Layer Separation**: Security checks at controller/guard level, business logic unchanged\r\n- **Utility Modularity**: Each security helper (password validator, config validator, sanitizer) is independently testable\r\n\r\n## Components and Interfaces\r\n\r\n### Component 1: ConfigValidator\r\n\r\n**File**: `backend/src/common/security/config-validator.ts`\r\n\r\n- **Purpose**: Validates environment configuration at application startup\r\n- **Interfaces**: \r\n  ```typescript\r\n  class ConfigValidator {\r\n    static validateConfig(): void;\r\n    static validateJwtSecret(secret: string): void;\r\n    static validateDatabase(config: DatabaseConfig): void;\r\n  }\r\n  ```\r\n- **Dependencies**: @nestjs/config, Joi\r\n- **Reuses**: Existing ConfigService\r\n- **Behavior**: \r\n  - Throws exception if required vars missing or invalid\r\n  - Logs warnings for optional missing vars (email, Telegram)\r\n  - Validates JWT secret minimum length (32 chars)\r\n  - Process exits with code 1 on validation failure\r\n\r\n---\r\n\r\n### Component 2: PasswordValidator\r\n\r\n**File**: `backend/src/common/security/password-validator.ts`\r\n\r\n- **Purpose**: Provides strong password validation decorator and utility\r\n- **Interfaces**:\r\n  ```typescript\r\n  function IsStrongPassword(validationOptions?: ValidationOptions): PropertyDecorator;\r\n  function validatePasswordStrength(password: string): ValidationResult;\r\n  ```\r\n- **Dependencies**: class-validator\r\n- **Reuses**: Existing validation framework\r\n- **Behavior**:\r\n  - Checks: minLength 8, uppercase, lowercase, numbers\r\n  - Rejects common weak passwords (123456, password, etc.)\r\n  - Returns specific error messages for failed checks\r\n\r\n---\r\n\r\n### Component 3: AllExceptionsFilter\r\n\r\n**File**: `backend/src/common/filters/all-exceptions.filter.ts`\r\n\r\n- **Purpose**: Catches all exceptions and formats responses securely\r\n- **Interfaces**:\r\n  ```typescript\r\n  @Catch()\r\n  class AllExceptionsFilter implements ExceptionFilter {\r\n    catch(exception: unknown, host: ArgumentsHost): void;\r\n  }\r\n  ```\r\n- **Dependencies**: @nestjs/common, LoggingSanitizer\r\n- **Reuses**: Existing error code constants\r\n- **Behavior**:\r\n  - Maps exceptions to HTTP status codes\r\n  - Sanitizes error messages (no stack traces in production)\r\n  - Logs full error details with sanitization\r\n  - Returns standardized format: `{ statusCode, message, errorCode, timestamp }`\r\n\r\n---\r\n\r\n### Component 4: RateLimitGuard\r\n\r\n**File**: `backend/src/common/guards/rate-limit.guard.ts`\r\n\r\n- **Purpose**: Apply endpoint-specific rate limiting with Redis\r\n- **Interfaces**:\r\n  ```typescript\r\n  @Injectable()\r\n  class RateLimitGuard extends ThrottlerGuard {\r\n    protected async handleRequest(context: ExecutionContext, limit: number, ttl: number): Promise<boolean>;\r\n  }\r\n  ```\r\n- **Dependencies**: @nestjs/throttler, Redis\r\n- **Reuses**: Existing Redis client, ThrottlerModule\r\n- **Behavior**:\r\n  - Uses Redis for distributed rate limiting\r\n  - Tracks by IP + user ID (if authenticated)\r\n  - Returns 429 with Retry-After header\r\n  - Logs excessive attempts\r\n\r\n---\r\n\r\n### Component 5: LoggingSanitizer\r\n\r\n**File**: `backend/src/common/security/logging-sanitizer.ts`\r\n\r\n- **Purpose**: Removes sensitive data from logs\r\n- **Interfaces**:\r\n  ```typescript\r\n  class LoggingSanitizer {\r\n    static sanitize(data: any): any;\r\n    static redactFields(obj: object, fields: string[]): object;\r\n  }\r\n  ```\r\n- **Dependencies**: None (pure utility)\r\n- **Reuses**: None\r\n- **Behavior**:\r\n  - Recursively scans objects for sensitive keys\r\n  - Redacts: password, token, apiKey, creditCard, secret\r\n  - Masks JWT tokens (shows only last 4 chars)\r\n  - Returns sanitized copy (non-destructive)\r\n\r\n---\r\n\r\n### Component 6: TransactionWrapper\r\n\r\n**File**: `backend/src/common/database/transaction-wrapper.ts`\r\n\r\n- **Purpose**: Simplifies safe transaction handling\r\n- **Interfaces**:\r\n  ```typescript\r\n  class TransactionWrapper {\r\n    static async execute<T>(\r\n      dataSource: DataSource,\r\n      work: (manager: EntityManager) => Promise<T>,\r\n      isolationLevel?: IsolationLevel\r\n    ): Promise<T>;\r\n  }\r\n  ```\r\n- **Dependencies**: TypeORM\r\n- **Reuses**: Existing DataSource\r\n- **Behavior**:\r\n  - Wraps business logic in transaction\r\n  - Auto-rollback on error\r\n  - Configurable isolation levels\r\n  - Error logging with context\r\n\r\n---\r\n\r\n### Component 7: HelmetConfigurer\r\n\r\n**File**: `backend/src/common/security/helmet-configurer.ts`\r\n\r\n- **Purpose**: Configures security headers middleware\r\n- **Interfaces**:\r\n  ```typescript\r\n  class HelmetConfigurer {\r\n    static getConfig(): HelmetOptions;\r\n  }\r\n  ```\r\n- **Dependencies**: helmet\r\n- **Reuses**: None\r\n- **Behavior**:\r\n  - Sets secure defaults for all headers\r\n  - Disables X-Powered-By\r\n  - Configures CSP for API usage\r\n  - Returns helmet configuration object\r\n\r\n---\r\n\r\n### Component 8: EnhancedCorsOptions\r\n\r\n**File**: `backend/src/common/security/cors-options.ts`\r\n\r\n- **Purpose**: Environment-based CORS configuration\r\n- **Interfaces**:\r\n  ```typescript\r\n  class EnhancedCorsOptions {\r\n    static getOptions(env: string): CorsOptions;\r\n  }\r\n  ```\r\n- **Dependencies**: @nestjs/common\r\n- **Reuses**: ConfigService\r\n- **Behavior**:\r\n  - Dev: Allows localhost origins\r\n  - Prod: Reads CORS_ORIGINS from env (comma-separated)\r\n  - Validates origin format\r\n  - Enables credentials for authenticated endpoints\r\n\r\n## Data Models\r\n\r\n### ConfigValidationSchema\r\n\r\n**Purpose**: Joi schema for environment validation\r\n\r\n```typescript\r\ninterface ConfigValidationSchema {\r\n  // Required\r\n  DATABASE_HOST: string;\r\n  DATABASE_PORT: number;\r\n  DATABASE_USER: string;\r\n  DATABASE_PASSWORD: string;\r\n  DATABASE_NAME: string;\r\n  JWT_SECRET: string; // minLength 32\r\n  PROXY_985_API_KEY: string;\r\n  PROXY_985_BASE_URL: string;\r\n  PROXY_985_ZONE: string;\r\n  \r\n  // Optional (with defaults)\r\n  NODE_ENV: 'development' | 'production';\r\n  PORT: number;\r\n  REDIS_HOST: string;\r\n  REDIS_PORT: number;\r\n  \r\n  // Optional (warnings if missing)\r\n  MAIL_HOST: string;\r\n  MAIL_USER: string;\r\n  MAIL_PASSWORD: string;\r\n  TELEGRAM_BOT_TOKEN: string;\r\n}\r\n```\r\n\r\n### RateLimitConfig\r\n\r\n**Purpose**: Type-safe rate limit configuration\r\n\r\n```typescript\r\ninterface RateLimitConfig {\r\n  ttl: number;        // Time window in ms\r\n  limit: number;      // Max requests per window\r\n  blockDuration: number; // Ban duration on violation (ms)\r\n  bypassRoles: string[]; // Roles exempt from limits\r\n}\r\n\r\n// Predefined configs\r\nconst RATE_LIMITS = {\r\n  LOGIN: { ttl: 900000, limit: 5, blockDuration: 3600000, bypassRoles: [] },\r\n  VERIFICATION_CODE: { ttl: 3600000, limit: 3, blockDuration: 7200000, bypassRoles: [] },\r\n  API_DEFAULT: { ttl: 60000, limit: 100, blockDuration: 300000, bypassRoles: ['admin'] },\r\n};\r\n```\r\n\r\n### ErrorResponse\r\n\r\n**Purpose**: Standardized error format\r\n\r\n```typescript\r\ninterface ErrorResponse {\r\n  statusCode: number;\r\n  message: string;\r\n  errorCode: string;\r\n  timestamp: string;\r\n  path?: string;      // Optional: request path\r\n  details?: string[]; // Optional: validation errors\r\n}\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n#### 1. Missing Required Environment Variable\r\n\r\n- **Trigger**: JWT_SECRET not set or PROXY_985_API_KEY not set\r\n- **Handling**: \r\n  - ConfigValidator throws exception during bootstrap\r\n  - Application logs error with missing variable name\r\n  - Process exits with code 1\r\n- **User Impact**: Application fails to start; ops team alerted via monitoring\r\n- **Recovery**: Set missing variable and restart\r\n\r\n#### 2. Weak JWT Secret\r\n\r\n- **Trigger**: JWT_SECRET length < 32 characters\r\n- **Handling**:\r\n  - ConfigValidator rejects secret\r\n  - Logs: \"JWT_SECRET must be at least 32 characters (got: X)\"\r\n  - Process exits with code 1\r\n- **User Impact**: Application fails to start\r\n- **Recovery**: Generate strong secret, update config, restart\r\n\r\n#### 3. Rate Limit Exceeded\r\n\r\n- **Trigger**: User exceeds configured request limit\r\n- **Handling**:\r\n  - RateLimitGuard throws ThrottlerException\r\n  - AllExceptionsFilter catches and formats\r\n  - Returns HTTP 429 with Retry-After header\r\n  - Logs attempt with IP and user ID\r\n- **User Impact**: Client receives 429 error with wait time\r\n- **Recovery**: Automatic after TTL expires\r\n\r\n#### 4. Password Validation Failure\r\n\r\n- **Trigger**: User submits weak password during registration\r\n- **Handling**:\r\n  - ValidationPipe rejects DTO\r\n  - Returns HTTP 400 with specific requirement violated\r\n  - Example: \"Password must contain at least one uppercase letter\"\r\n- **User Impact**: Registration form shows error, user corrects password\r\n- **Recovery**: Immediate - user resubmits with stronger password\r\n\r\n#### 5. Transaction Conflict\r\n\r\n- **Trigger**: Concurrent balance deduction attempts\r\n- **Handling**:\r\n  - TransactionWrapper acquires row-level lock\r\n  - Second request waits or times out\r\n  - If timeout: returns HTTP 409 \"Conflict - please retry\"\r\n  - Transaction rolls back automatically\r\n- **User Impact**: User sees temporary error, can retry immediately\r\n- **Recovery**: Automatic retry succeeds\r\n\r\n#### 6. Uncaught Exception\r\n\r\n- **Trigger**: Unexpected error (e.g., database connection lost)\r\n- **Handling**:\r\n  - AllExceptionsFilter catches all unhandled errors\r\n  - Logs full error with context (sanitized)\r\n  - Returns generic HTTP 500 message\r\n  - In production: hides implementation details\r\n- **User Impact**: User sees \"Internal Server Error\" message\r\n- **Recovery**: Ops team investigates logs; system may self-recover\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n**Target: 70% Code Coverage for Security Module**\r\n\r\n#### ConfigValidator Tests\r\n```typescript\r\ndescribe('ConfigValidator', () => {\r\n  it('should reject JWT_SECRET with length < 32');\r\n  it('should accept valid configuration');\r\n  it('should throw on missing DATABASE_HOST');\r\n  it('should warn but not fail on missing MAIL_HOST');\r\n});\r\n```\r\n\r\n#### PasswordValidator Tests\r\n```typescript\r\ndescribe('PasswordValidator', () => {\r\n  it('should accept strong password: \"Abcd1234\"');\r\n  it('should reject password without uppercase');\r\n  it('should reject common weak passwords');\r\n  it('should provide specific error messages');\r\n});\r\n```\r\n\r\n#### LoggingSanitizer Tests\r\n```typescript\r\ndescribe('LoggingSanitizer', () => {\r\n  it('should redact password field');\r\n  it('should mask JWT tokens');\r\n  it('should handle nested objects');\r\n  it('should not mutate original object');\r\n});\r\n```\r\n\r\n#### AllExceptionsFilter Tests\r\n```typescript\r\ndescribe('AllExceptionsFilter', () => {\r\n  it('should format HttpException correctly');\r\n  it('should handle TypeError with 500 status');\r\n  it('should hide stack trace in production');\r\n  it('should include path in error response');\r\n});\r\n```\r\n\r\n### Integration Testing\r\n\r\n**Focus: End-to-End Security Flows**\r\n\r\n#### Rate Limiting Integration\r\n- Test: Submit 6 login attempts within 15 minutes\r\n- Expected: First 5 succeed/fail normally, 6th returns 429\r\n- Verify: Redis contains rate limit counter\r\n- Verify: After TTL, requests allowed again\r\n\r\n#### Transaction Safety Integration\r\n- Test: Two concurrent balance deductions for same user\r\n- Expected: Both complete without race condition\r\n- Verify: Final balance is correct\r\n- Verify: Transaction logs show serialized execution\r\n\r\n#### Configuration Validation Integration\r\n- Test: Start app with missing JWT_SECRET\r\n- Expected: Bootstrap fails with clear error\r\n- Verify: Process exits with code 1\r\n- Verify: Error log contains \"JWT_SECRET\"\r\n\r\n### End-to-End Testing\r\n\r\n**User Scenarios**\r\n\r\n#### Scenario 1: New User Registration with Weak Password\r\n1. User navigates to registration page\r\n2. User enters email and weak password (\"12345678\")\r\n3. System rejects with: \"Password must contain uppercase and lowercase letters\"\r\n4. User corrects password to \"Abcd1234\"\r\n5. Registration succeeds\r\n\r\n#### Scenario 2: Brute Force Attack Prevention\r\n1. Attacker attempts login with wrong password 5 times\r\n2. All 5 attempts fail with \"Invalid password\"\r\n3. 6th attempt returns: \"429 Too Many Requests, retry after 900 seconds\"\r\n4. After 15 minutes, attacker can try again\r\n\r\n#### Scenario 3: Concurrent Purchase Attempts\r\n1. User has $100 balance\r\n2. User initiates two $60 proxy purchases simultaneously\r\n3. First purchase succeeds, balance becomes $40\r\n4. Second purchase fails: \"Insufficient balance\"\r\n5. No race condition occurs; balance remains accurate\r\n\r\n## Implementation Phases\r\n\r\n### Phase 1: Foundation (P0 - Critical)\r\n- ConfigValidator with startup validation\r\n- PasswordValidator decorator\r\n- Enhanced rate limiting with Redis\r\n\r\n### Phase 2: Protection Layers (P1 - High)\r\n- AllExceptionsFilter\r\n- Input length validation\r\n- Transaction wrappers\r\n- Security headers (Helmet + CORS)\r\n\r\n### Phase 3: Observability (P2 - Technical Debt)\r\n- LoggingSanitizer\r\n- Unit test suite\r\n- Integration test suite\r\n\r\n## Migration Strategy\r\n\r\n### Backward Compatibility\r\n\r\n**No Breaking Changes:**\r\n- Existing API endpoints unchanged\r\n- Response formats remain identical\r\n- Client applications require no updates\r\n\r\n**Deployment Steps:**\r\n1. Update .env file with required variables\r\n2. Deploy new code (app will validate config)\r\n3. Monitor logs for rate limit violations\r\n4. Gradually tighten rate limits based on usage patterns\r\n\r\n### Rollback Plan\r\n\r\nIf issues arise:\r\n1. Revert code to previous version\r\n2. Old code still works with new .env (additional vars ignored)\r\n3. No database migrations required\r\n4. Zero downtime rollback possible\r\n\r\n## Security Considerations\r\n\r\n### Threat Mitigation\r\n\r\n| Threat | Mitigation | Component |\r\n|--------|------------|-----------|\r\n| Exposed secrets in code | Config validation | ConfigValidator |\r\n| Brute force attacks | Rate limiting | RateLimitGuard |\r\n| Weak passwords | Strength validation | PasswordValidator |\r\n| Information leakage | Error sanitization | AllExceptionsFilter |\r\n| SQL injection | Input validation | ValidationPipe + MaxLength |\r\n| Race conditions | Transactions | TransactionWrapper |\r\n| XSS/Clickjacking | Security headers | Helmet |\r\n| CSRF | CORS + credentials | CorsOptions |\r\n\r\n### Performance Impact\r\n\r\n- **Config Validation**: <100ms at startup (one-time cost)\r\n- **Rate Limiting**: <5ms per request (Redis lookup)\r\n- **Password Validation**: <10ms per registration/login\r\n- **Exception Filtering**: <1ms per error\r\n- **Transactions**: <50ms overhead per financial operation\r\n- **Sanitization**: <2ms per log entry\r\n\r\n**Overall**: <5% performance impact for 10x security improvement\r\n\r\n",
  "fileStats": {
    "size": 18215,
    "lines": 568,
    "lastModified": "2025-11-10T12:25:05.295Z"
  },
  "comments": []
}