# ProxyHub 关键问题修复 - 需求文档

**规格名称**: proxyhub-critical-fixes  
**创建日期**: 2025-11-06  
**状态**: 📋 Requirements Phase  
**优先级**: P0 - 紧急

---

## 1. 概述

### 1.1 背景
ProxyHub项目已完成90%的核心功能开发，但存在4个关键问题影响生产就绪状态：
- P0-1: IP续费API调用失败（985Proxy返回"please input the renewal IP"）
- P0-2: 管理后台路由重定向问题（无法访问/admin/dashboard）
- P1-1: 购买后订单状态查询缺失（proxies数组为空）
- P1-2: 价格显示不一致（计算$5实际扣$1）

### 1.2 目标
修复所有P0和P1级别的问题，确保系统可以投入生产使用。

### 1.3 范围
- ✅ 包含：后端API修复、前端路由修复、订单状态轮询、价格同步
- ❌ 不包含：手机端适配、多语言功能、新功能开发

---

## 2. 用户故事

### 2.1 P0-1: IP续费功能修复

**用户故事**:
```
作为 ProxyHub用户
我想要 能够续费我购买的静态IP
以便 延长IP的使用时间而不用重新购买
```

**验收标准**:
- [ ] 用户可以点击"续费"按钮选择续费时长
- [ ] 系统正确调用985Proxy续费API
- [ ] 续费成功后IP过期时间正确更新
- [ ] 用户余额正确扣除
- [ ] 创建交易记录
- [ ] 显示成功提示

**当前问题**:
- API调用返回错误："please input the renewal IP"
- 需要检查请求参数格式是否符合985Proxy要求

**测试数据**:
- 测试IP: `250.130.139.91`
- 续费时长: 30天
- 预期价格: $5.00

---

### 2.2 P0-2: 管理后台路由修复

**用户故事**:
```
作为 管理员
我想要 能够访问管理后台仪表盘
以便 查看系统统计和待处理事项
```

**验收标准**:
- [ ] 访问`/admin/dashboard`不会重定向到`/dashboard`
- [ ] 管理员可以正常访问所有管理后台页面
- [ ] 非管理员用户无法访问管理后台
- [ ] 路由守卫正确验证用户角色
- [ ] 面包屑导航正确显示

**当前问题**:
- 访问`/admin/dashboard`自动重定向到用户仪表盘
- 可能原因：路由守卫配置错误或路由定义问题

**相关文件**:
- `frontend/src/router/index.ts`
- `frontend/src/router/guards.ts`

---

### 2.3 P1-1: 订单状态轮询机制

**用户故事**:
```
作为 ProxyHub用户
我想要 在购买IP后立即看到分配的IP信息
以便 我可以开始使用这些IP
```

**验收标准**:
- [ ] 购买提交后显示"处理中"状态
- [ ] 后端自动轮询985Proxy订单状态
- [ ] 订单完成后保存真实IP信息到数据库
- [ ] 前端实时显示订单状态更新
- [ ] 超时后显示友好提示（建议联系客服）
- [ ] 支持手动刷新订单状态

**当前问题**:
- 购买API只返回order_no，不返回IP列表
- 需要调用`getOrderResult` API获取IP详情
- 需要实现轮询机制（每3秒检查一次，最多10次）

**技术要求**:
- 使用事务确保数据一致性
- 轮询失败不影响订单创建
- 支持后台异步处理

---

### 2.4 P1-2: 价格显示同步

**用户故事**:
```
作为 ProxyHub用户
我想要 看到准确的IP购买价格
以便 我可以正确预估消费金额
```

**验收标准**:
- [ ] 价格计算API返回的价格与实际扣费一致
- [ ] 如果有折扣，明确显示折扣信息
- [ ] 购买前再次确认最终价格
- [ ] 价格显示包含货币单位和时长
- [ ] 多个IP的总价计算正确

**当前问题**:
- `calculatePrice` 返回 $5.00
- 实际购买只扣费 $1.00
- 可能原因：测试账号折扣或首单优惠

**解决方案**:
1. 验证985Proxy账户实际扣费
2. 检查API返回的折扣字段
3. 前端显示原价和折后价
4. 购买确认时显示最终价格

---

## 3. 功能需求

### 3.1 IP续费功能增强

**FR-1.1**: 增加详细的API请求日志
- 记录发送给985Proxy的完整请求参数
- 记录响应内容和错误信息
- 便于调试和问题追踪

**FR-1.2**: 修复续费API参数格式
- 检查`renew_ip_list`格式要求
- 确认是否需要包含端口号
- 测试不同的IP格式

**FR-1.3**: 添加续费前验证
- 检查IP是否属于当前用户
- 检查IP是否已过期
- 检查用户余额是否足够

---

### 3.2 管理后台路由增强

**FR-2.1**: 修复路由守卫逻辑
- 区分普通用户路由和管理员路由
- 正确验证用户角色
- 提供友好的无权限提示

**FR-2.2**: 优化路由结构
- 确保嵌套路由正确配置
- 添加路由元信息（requiresAdmin）
- 统一路由命名规范

---

### 3.3 订单状态管理

**FR-3.1**: 实现订单状态轮询服务
- 创建后台任务服务
- 支持订单状态自动更新
- 记录轮询历史

**FR-3.2**: 前端订单状态实时更新
- 使用轮询或WebSocket
- 显示处理进度
- 支持手动刷新

**FR-3.3**: 订单超时处理
- 设置合理的超时时间（30秒）
- 超时后保存订单为"pending"状态
- 提供客服联系方式

---

### 3.4 价格显示优化

**FR-4.1**: 实现价格详情显示
- 显示原价、折扣、最终价
- 显示价格有效期
- 支持价格历史查询

**FR-4.2**: 购买确认优化
- 确认对话框显示最终价格
- 显示余额和扣费后余额
- 防止重复提交

---

## 4. 非功能需求

### 4.1 性能要求
- API响应时间 < 200ms（不含985Proxy调用）
- 订单轮询间隔 3秒
- 前端状态更新延迟 < 100ms

### 4.2 可靠性要求
- 使用数据库事务确保数据一致性
- API调用失败时提供降级方案
- 关键操作记录到事件日志

### 4.3 安全要求
- 验证用户身份和权限
- 防止越权访问
- 敏感操作记录审计日志

### 4.4 可维护性要求
- 代码遵循README开发规范
- 添加详细的注释
- 保持代码简洁性和高效性

---

## 5. 约束条件

### 5.1 技术约束
- 必须兼容现有的数据库结构
- 不能破坏现有功能
- 使用现有的技术栈（NestJS + Vue3）

### 5.2 时间约束
- P0问题必须在1天内修复
- P1问题必须在2天内修复
- 所有修复必须通过测试

### 5.3 资源约束
- 不增加新的依赖包（除非必要）
- 使用现有的服务和工具
- 复用现有的代码和组件

---

## 6. 验收标准

### 6.1 功能验收
- [ ] 所有用户故事的验收标准通过
- [ ] 使用Chrome DevTools测试通过
- [ ] 回归测试无新增问题

### 6.2 代码质量
- [ ] 遵循README开发规范
- [ ] 无TypeScript编译错误
- [ ] 无ESLint警告
- [ ] 代码审查通过

### 6.3 文档完整
- [ ] 更新API文档
- [ ] 创建测试报告
- [ ] 更新README（如有必要）

---

## 7. 风险与依赖

### 7.1 风险
- **R1**: 985Proxy API文档可能不完整
  - 缓解措施：联系客服确认API格式
  - 备选方案：使用API测试工具验证
  
- **R2**: 修复可能影响现有功能
  - 缓解措施：完整的回归测试
  - 备选方案：Git回滚机制

### 7.2 依赖
- **D1**: 需要访问985Proxy测试账户
- **D2**: 需要Chrome DevTools MCP工具
- **D3**: 需要本地开发环境正常运行

---

## 8. 成功指标

- ✅ IP续费成功率 100%
- ✅ 管理后台访问成功率 100%
- ✅ 订单IP获取成功率 > 95%
- ✅ 价格显示准确率 100%
- ✅ 0个新增的关键Bug
- ✅ 代码质量评分 A级

---

**文档版本**: v1.0  
**下一步**: 创建design.md设计文档

