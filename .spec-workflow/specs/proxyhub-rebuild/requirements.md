# ProxyHub 完整项目重建 - 需求文档

## 📋 项目概述

### 1.1 项目背景

ProxyHub是一个现代化的代理IP管理平台，对接985Proxy API，为用户提供动态住宅代理、静态住宅代理和移动代理服务。当前项目存在编码问题和文件损坏，需要**完整重建**以确保代码质量和可维护性。

### 1.2 项目目标

- **REQ-GOAL-1**: 构建一个稳定、可扩展的代理IP管理平台
- **REQ-GOAL-2**: 提供用户友好的Web界面和完善的管理后台
- **REQ-GOAL-3**: 确保代码质量、可读性和可维护性
- **REQ-GOAL-4**: 实现与985Proxy API的无缝对接
- **REQ-GOAL-5**: 支持中英文国际化

### 1.3 用户角色

| 角色 | 描述 | 权限 |
|------|------|------|
| **普通用户** | 购买和管理代理IP | 查看代理、购买、续费、充值、查看订单 |
| **管理员** | 系统管理和运营 | 用户管理、订单审核、充值审核、IP管理、数据统计、系统配置 |
| **代理商**（可选） | 推广代理赚取返佣 | 推广链接、返佣统计、提现 |

---

## 🎯 功能需求

### 2.1 用户认证系统 (REQ-AUTH)

#### REQ-AUTH-1: 用户注册
**WHEN** 新用户访问注册页面  
**IF** 用户填写有效的邮箱和密码  
**THEN** 系统创建账户并发送验证邮件  

**验收标准**:
- [ ] 邮箱格式验证
- [ ] 密码强度验证（至少8位，包含大小写字母和数字）
- [ ] 邮箱唯一性检查
- [ ] 密码使用bcrypt加密存储
- [ ] 注册成功后自动登录

#### REQ-AUTH-2: 用户登录
**WHEN** 用户访问登录页面  
**IF** 用户输入正确的邮箱和密码  
**THEN** 系统返回JWT Token并跳转到仪表盘  

**验收标准**:
- [ ] 支持邮箱+密码登录
- [ ] JWT Token有效期2小时
- [ ] Refresh Token有效期7天
- [ ] 记住我功能（延长Token有效期）
- [ ] 错误提示清晰（"邮箱不存在"、"密码错误"）

#### REQ-AUTH-3: 密码找回
**WHEN** 用户忘记密码  
**IF** 用户输入注册邮箱  
**THEN** 系统发送重置密码链接到邮箱  

**验收标准**:
- [ ] 发送重置密码邮件
- [ ] 重置链接有效期1小时
- [ ] 重置成功后旧密码失效

#### REQ-AUTH-4: 用户登出
**WHEN** 用户点击登出按钮  
**THEN** 清除本地Token并跳转到登录页  

---

### 2.2 用户中心 (REQ-USER)

#### REQ-USER-1: 个人资料管理
**WHEN** 用户访问个人中心  
**THEN** 用户可以查看和修改个人信息  

**验收标准**:
- [ ] 查看用户基本信息（邮箱、注册时间、余额）
- [ ] 修改昵称和联系方式
- [ ] 修改密码（需验证旧密码）
- [ ] 上传头像（可选）

#### REQ-USER-2: API Key管理
**WHEN** 用户需要API调用  
**THEN** 用户可以生成和管理API Key  

**验收标准**:
- [ ] 生成新的API Key
- [ ] 查看API Key列表
- [ ] 删除API Key
- [ ] API Key有使用记录

---

### 2.3 动态住宅代理 (REQ-DYNAMIC)

#### REQ-DYNAMIC-1: 查看动态代理套餐
**WHEN** 用户访问动态代理购买页面  
**THEN** 显示5个套餐选项（现收现付、个人、商务、高级、企业定制）  

**验收标准**:
- [ ] **现收现付**: 免费 + $5.0/GB
- [ ] **个人**: $150/365天 + $4.5/GB（标记为"最受欢迎"）
- [ ] **商务**: $450/365天 + $4.0/GB
- [ ] **高级**: $1200/365天 + $3.6/GB
- [ ] **企业定制**: "请联系客服商议"
- [ ] 每个套餐显示功能列表（无限并发会话、城市级定位、IP轮换、流量不过期、专属支持、优先带宽、定制方案）
- [ ] 点击"企业定制"跳转到Telegram客服链接 (https://t.me/lubei12)

#### REQ-DYNAMIC-2: 动态代理管理
**WHEN** 用户访问动态代理管理页面  
**THEN** 显示已购买的动态代理通道列表  

**验收标准**:
- [ ] 显示通道名称、类型（HTTP/HTTPS/SOCKS5）、状态（活跃/停用）、流量使用、创建时间、备注
- [ ] 支持添加白名单IP
- [ ] 查看详情
- [ ] 删除通道（需确认）
- [ ] 如果无代理，显示空状态+联系客服按钮

---

### 2.4 静态住宅代理 (REQ-STATIC)

#### REQ-STATIC-1: 查看静态代理购买页面
**WHEN** 用户访问静态代理购买页面  
**THEN** 显示IP池和购买配置界面  

**验收标准**:
- [ ] **Channel Name输入框**（必填，后续不可更改）
- [ ] **IP类型选择**：普通IP / 原生IP
- [ ] **业务场景选择**：Shopee、TikTok、Amazon、Instagram、Facebook、YouTube、Google、Twitter、自定义
- [ ] **地区选择**：欧洲、美洲、亚洲、大洋洲
- [ ] **国家标签页**：显示该地区所有国家（带国旗图标）
- [ ] **购买时长选择**：30天、60天、90天、180天（单选按钮）
- [ ] **国家IP卡片网格**（左侧）：
  - 显示国家名称、城市、国旗图标
  - 显示库存数量
  - 显示单价（根据IP类型和时长动态计算）
  - 数量选择器（+/-按钮，输入框）
  - 点击国家卡片添加到购物车
- [ ] **支付详情面板**（右侧固定）：
  - 显示已选IP列表（国家、城市、数量、单价、小计）
  - 显示总数量和总价格
  - 显示当前余额
  - "确认购买"按钮（余额不足时禁用）
  - "清空购物车"按钮
- [ ] **定价规则**：
  - 普通IP: 30天=$5, 60天=$10, 90天=$15, 180天=$30
  - 原生IP: 30天=$8, 60天=$16, 90天=$24, 180天=$48

#### REQ-STATIC-2: 静态代理购买流程
**WHEN** 用户点击"确认购买"  
**IF** 余额充足  
**THEN** 创建订单、扣除余额、分配IP、跳转到管理页面  

**验收标准**:
- [ ] 验证Channel Name非空
- [ ] 验证购物车非空
- [ ] 验证余额充足
- [ ] 确认弹窗显示购买明细
- [ ] 调用后端API购买
- [ ] 购买成功后显示订单号
- [ ] 更新用户余额
- [ ] 清空购物车
- [ ] 1.5秒后自动跳转到静态代理管理页面

#### REQ-STATIC-3: 静态代理管理
**WHEN** 用户访问静态代理管理页面  
**THEN** 显示已购买的静态IP列表  

**验收标准**:
- [ ] **表格显示**：
  - 复选框（批量选择）
  - IP:端口:账号:密码（带复制按钮）
  - 国家/城市（带国旗图标）
  - 类型（普通/原生，不同颜色标签）
  - 到期时间（带状态标签：X天剩余/今天到期/已过期）
  - 释放时间
  - 操作按钮（续费、释放）
- [ ] **筛选功能**：
  - IP地址搜索
  - 国家下拉选择（美国、英国、德国、日本）
  - IP类型单选（所有/普通IP/原生IP）
  - 搜索和重置按钮
- [ ] **批量操作**：
  - 批量导出（TXT/CSV格式）
  - 批量续费（选择时长30/60/90/180天，显示总价）
- [ ] **导出格式**：
  - TXT: `IP:端口:账号:密码` 每行一个
  - CSV: 包含IP,端口,账号,密码,国家,城市,到期时间

#### REQ-STATIC-4: 静态代理续费
**WHEN** 用户点击"续费"按钮（单个或批量）  
**IF** 余额充足  
**THEN** 延长IP有效期并扣除费用  

**验收标准**:
- [ ] 弹窗显示续费明细（数量、IP类型、时长、单价、总价）
- [ ] 验证余额充足
- [ ] 调用后端续费API
- [ ] 续费成功后更新到期时间
- [ ] 更新用户余额
- [ ] 刷新IP列表

#### REQ-STATIC-5: 静态代理释放
**WHEN** 用户点击"释放"按钮  
**THEN** 释放IP资源（不退款）  

**验收标准**:
- [ ] 确认弹窗
- [ ] 调用后端释放API
- [ ] 从列表中移除

---

### 2.5 移动代理 (REQ-MOBILE)

#### REQ-MOBILE-1: 移动代理占位页
**WHEN** 用户点击"移动代理"菜单  
**THEN** 显示"功能开发中"占位页面  

**验收标准**:
- [ ] 显示"功能开发中"提示
- [ ] 显示图标和说明文字
- [ ] 保留菜单项但标记为"敬请期待"

---

### 2.6 钱包充值系统 (REQ-WALLET)

#### REQ-WALLET-1: 充值申请
**WHEN** 用户访问钱包充值页面  
**THEN** 用户可以提交充值申请  

**验收标准**:
- [ ] 充值金额输入（最小$1，最大$10000）
- [ ] 实时显示CNY换算（汇率7.2）
- [ ] 支付方式选择（支付宝/微信支付/银行转账）
- [ ] 备注输入框（可选）
- [ ] 提交充值申请按钮
- [ ] 提交后显示成功消息

#### REQ-WALLET-2: 充值历史
**WHEN** 用户在充值页面向下滚动  
**THEN** 显示充值历史记录表格  

**验收标准**:
- [ ] 显示订单号、金额、支付方式、状态（待审核/已批准/已拒绝）、创建时间、备注
- [ ] 分页显示
- [ ] 加载状态

---

### 2.7 订单管理 (REQ-ORDER)

#### REQ-ORDER-1: 查看订单列表
**WHEN** 用户访问订单页面  
**THEN** 显示所有订单列表  

**验收标准**:
- [ ] 显示订单号、订单类型（静态代理/动态代理/移动代理/充值）、金额、状态（待处理/处理中/已完成/失败/已取消）、创建时间、备注
- [ ] 筛选：订单状态、订单类型
- [ ] 搜索和重置按钮
- [ ] 分页
- [ ] 查看详情按钮
- [ ] 取消订单按钮（仅待处理状态）

#### REQ-ORDER-2: 查看订单详情
**WHEN** 用户点击"查看详情"  
**THEN** 弹窗显示订单详细信息  

**验收标准**:
- [ ] 订单号、订单类型、金额、状态、创建时间、更新时间、备注
- [ ] 显示完整的描述信息

#### REQ-ORDER-3: 取消订单
**WHEN** 用户点击"取消订单"（仅待处理状态）  
**IF** 用户确认  
**THEN** 订单状态更新为"已取消"  

**验收标准**:
- [ ] 确认弹窗
- [ ] 调用后端API取消订单
- [ ] 刷新订单列表

---

### 2.8 交易记录 (REQ-TRANSACTION)

#### REQ-TRANSACTION-1: 查看交易记录
**WHEN** 用户访问交易记录页面  
**THEN** 显示所有交易明细  

**验收标准**:
- [ ] 显示交易号、类型（充值/购买/退款/返佣）、金额（+绿色/-红色）、交易前余额、交易后余额、时间、备注
- [ ] 筛选：交易类型
- [ ] 搜索和重置按钮
- [ ] 分页

---

### 2.9 管理后台 (REQ-ADMIN)

#### REQ-ADMIN-1: 管理后台入口
**WHEN** 管理员访问 `/admin-portal/login`  
**THEN** 显示管理后台登录页面  

**验收标准**:
- [ ] 独立的登录页面（与用户登录分离）
- [ ] 验证管理员角色（role='admin'）
- [ ] 登录成功后跳转到 `/admin-portal/users`

#### REQ-ADMIN-2: 用户管理
**WHEN** 管理员访问用户管理页面  
**THEN** 显示所有用户列表并支持管理操作  

**验收标准**:
- [ ] 显示用户邮箱、角色（用户/管理员）、余额、状态（活跃/停用）、注册时间
- [ ] 搜索用户（邮箱/ID）
- [ ] 筛选：角色、状态
- [ ] 编辑用户信息
- [ ] 启用/停用用户
- [ ] 删除用户（软删除，保留数据用于审计）
- [ ] 分页

#### REQ-ADMIN-3: 充值审核
**WHEN** 管理员访问充值审核页面  
**THEN** 显示所有待审核的充值申请  

**验收标准**:
- [ ] 显示用户邮箱、充值金额、支付方式、状态（待审核/已批准/已拒绝）、申请时间、备注
- [ ] 筛选：状态
- [ ] **批准充值**：全额批准（不支持部分批准）
- [ ] **拒绝充值**：填写拒绝原因
- [ ] 批准后自动更新用户余额并创建交易记录
- [ ] 分页

#### REQ-ADMIN-4: 订单管理
**WHEN** 管理员访问订单管理页面  
**THEN** 显示所有订单并支持状态管理  

**验收标准**:
- [ ] 显示订单号、用户邮箱、订单类型、金额、状态、创建时间、备注
- [ ] 筛选：订单类型、状态、用户
- [ ] 查看订单详情
- [ ] 手动更新订单状态（处理中/已完成/失败）
- [ ] 导出订单（CSV）
- [ ] 分页

#### REQ-ADMIN-5: IP管理
**WHEN** 管理员访问IP管理页面  
**THEN** 显示所有IP资源并支持批量操作  

**验收标准**:
- [ ] 显示IP地址、端口、账号、密码、国家、城市、类型（普通/原生）、状态（使用中/已释放/已过期）、到期时间、用户邮箱
- [ ] 搜索：IP地址、用户邮箱
- [ ] 筛选：国家、IP类型、状态
- [ ] **CSV导入**：批量导入IP资源（格式：IP,端口,账号,密码,国家,城市,类型,到期时间）
- [ ] **TXT导出**：导出选中IP（格式：`IP:端口:账号:密码`）
- [ ] 手动释放IP
- [ ] 分页

#### REQ-ADMIN-6: 数据统计
**WHEN** 管理员访问数据统计页面  
**THEN** 显示关键业务指标和图表  

**验收标准**:
- [ ] **统计卡片**：
  - 总用户数
  - 今日新增用户
  - 总订单数
  - 今日订单数
  - 总收入
  - 今日收入
  - 活跃IP数
  - 即将到期IP数（7天内）
- [ ] **图表**：
  - 用户增长趋势（折线图，最近30天）
  - 订单趋势（折线图，最近30天）
  - 收入趋势（折线图，最近30天）
  - IP类型分布（饼图）
  - 国家分布（饼图）
- [ ] 数据来源：Redis缓存 + PostgreSQL聚合查询
- [ ] 缓存时长：5分钟

#### REQ-ADMIN-7: 系统设置
**WHEN** 管理员访问系统设置页面  
**THEN** 可以配置系统参数  

**验收标准**:
- [ ] **基础设置**：
  - 系统名称
  - 系统Logo
  - 联系邮箱
  - Telegram客服链接
- [ ] **交易设置**：
  - USD转CNY汇率
  - 最小充值金额
  - 最大充值金额
- [ ] **985Proxy API配置**：
  - API Base URL
  - API Key
  - 超时时间
- [ ] 保存设置按钮
- [ ] 设置存储在数据库 `system_settings` 表

---

### 2.10 仪表盘 (REQ-DASHBOARD)

#### REQ-DASHBOARD-1: 用户仪表盘
**WHEN** 用户登录后访问首页  
**THEN** 显示用户仪表盘  

**验收标准**:
- [ ] **账户概览卡片**：
  - 当前余额
  - 动态代理数量
  - 静态代理数量
  - 移动代理数量
- [ ] **快捷操作按钮**：
  - 购买动态代理
  - 购买静态代理
  - 充值
  - 查看订单
- [ ] **使用概况折线图**：
  - 显示最近7天的流量使用趋势
  - X轴：日期
  - Y轴：流量（GB）
  - 支持动态/静态代理类型切换
  - 数据来源：`usage_records` 表或Mock数据
- [ ] **最近订单列表**：
  - 显示最近5条订单
  - 订单号、类型、金额、状态、创建时间
  - "查看全部"链接

---

### 2.11 国际化 (REQ-I18N)

#### REQ-I18N-1: 多语言支持
**WHEN** 用户切换语言  
**THEN** 界面文本更新为对应语言  

**验收标准**:
- [ ] 支持中文（zh-CN）和英文（en-US）
- [ ] 语言选择器（右上角下拉菜单）
- [ ] 语言偏好存储在LocalStorage
- [ ] 所有界面文本使用 `$t()` 函数
- [ ] 所有静态文本都有翻译键

---

### 2.12 国旗显示 (REQ-FLAGS)

#### REQ-FLAGS-1: 国旗图标显示
**WHEN** 界面需要显示国家  
**THEN** 显示对应的国旗图标  

**验收标准**:
- [ ] 使用 `country-flag-icons` npm包（SVG格式）
- [ ] 创建 `FlagIcon.vue` 组件
- [ ] 支持所有国家代码（ISO 3166-1 alpha-2）
- [ ] 图标尺寸可配置（默认20px）
- [ ] 如果国旗加载失败，显示国家代码文本作为后备

---

## 🎨 非功能需求

### 3.1 性能要求 (REQ-PERF)

- **REQ-PERF-1**: 首屏加载时间 < 2秒
- **REQ-PERF-2**: API响应时间(P95) < 200ms
- **REQ-PERF-3**: API响应时间(P99) < 500ms
- **REQ-PERF-4**: 支持并发用户数 1000+
- **REQ-PERF-5**: 数据库查询优化（索引、避免N+1查询）

### 3.2 安全要求 (REQ-SEC)

- **REQ-SEC-1**: 所有API使用JWT认证
- **REQ-SEC-2**: 密码使用bcrypt加密（10轮）
- **REQ-SEC-3**: HTTPS加密传输（生产环境）
- **REQ-SEC-4**: SQL注入防护（TypeORM参数化查询）
- **REQ-SEC-5**: XSS防护（输出转义）
- **REQ-SEC-6**: CSRF防护（Token验证）
- **REQ-SEC-7**: API限流（100请求/分钟/IP）

### 3.3 可用性要求 (REQ-AVAIL)

- **REQ-AVAIL-1**: 系统可用性 99.9%
- **REQ-AVAIL-2**: 数据库主从复制+自动故障转移
- **REQ-AVAIL-3**: Redis哨兵模式
- **REQ-AVAIL-4**: 每日全量备份+增量备份
- **REQ-AVAIL-5**: 日志记录和监控

### 3.4 可维护性要求 (REQ-MAINT)

- **REQ-MAINT-1**: 代码注释覆盖率 > 30%
- **REQ-MAINT-2**: 遵循TypeScript最佳实践
- **REQ-MAINT-3**: 模块化设计，职责单一
- **REQ-MAINT-4**: RESTful API设计规范
- **REQ-MAINT-5**: Git commit message规范（Conventional Commits）
- **REQ-MAINT-6**: 代码格式化（Prettier + ESLint）

### 3.5 兼容性要求 (REQ-COMPAT)

- **REQ-COMPAT-1**: 浏览器支持：Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **REQ-COMPAT-2**: 响应式设计（支持PC、平板、手机）
- **REQ-COMPAT-3**: Node.js 20 LTS
- **REQ-COMPAT-4**: PostgreSQL 15+
- **REQ-COMPAT-5**: Redis 7.0+

---

## 📦 技术约束

### 4.1 技术栈约束

**前端**:
- Vue 3.4+
- TypeScript 5.3+
- Vite 5.0+
- Element Plus 2.5+
- Vue Router 4.2+
- Pinia 2.1+
- Axios 1.6+
- ECharts 5.4+
- vue-i18n 9.8+
- dayjs 1.11+
- country-flag-icons 1.5+

**后端**:
- NestJS 10.0+
- TypeScript 5.1+
- TypeORM 0.3+
- PostgreSQL 15+
- Redis 7.0+
- Passport.js + JWT
- class-validator + class-transformer
- bcrypt 5.1+

**部署**:
- Docker + Docker Compose
- Nginx
- PM2（可选）

### 4.2 第三方服务

- **985Proxy API**: 代理IP资源提供商
- **Telegram**: 客服支持 (https://t.me/lubei12)

---

## 🚀 部署要求

### 5.1 环境配置

**开发环境**:
- Docker Desktop
- Node.js 20 LTS
- PostgreSQL 15+
- Redis 7.0+

**生产环境**:
- 腾讯云服务器（推荐）
- Docker + Docker Compose
- Nginx反向代理
- SSL证书（Let's Encrypt）
- PostgreSQL主从复制
- Redis哨兵模式

### 5.2 部署流程

1. 构建前端：`cd frontend && npm run build`
2. 构建后端：`cd backend && npm run build`
3. Docker镜像构建：`docker-compose build`
4. 启动服务：`docker-compose up -d`
5. 数据库迁移：`npm run migration:run`
6. 健康检查：`curl http://localhost/api/health`

---

## 📊 验收标准

### 6.1 功能验收

| 功能模块 | 验收标准 |
|---------|---------|
| 用户认证 | 注册、登录、登出、密码找回全部功能正常 |
| 动态代理 | 套餐显示正确、价格准确、联系客服链接可用 |
| 静态代理 | 购买流程完整、国旗显示正常、续费和导出功能正常 |
| 钱包充值 | 提交充值申请成功、CNY换算正确、历史记录显示正常 |
| 订单管理 | 列表显示正确、筛选功能有效、详情查看正常 |
| 交易记录 | 列表显示正确、金额颜色区分正确、筛选功能有效 |
| 管理后台 | 6大管理模块全部功能正常、数据统计准确、CSV导入导出正常 |
| 仪表盘 | 概览数据准确、折线图显示正常、快捷操作可用 |
| 国际化 | 中英文切换正常、所有文本都有翻译 |

### 6.2 质量验收

- [ ] 无编译错误
- [ ] 无TypeScript类型错误
- [ ] 无ESLint错误
- [ ] 无明显的UI布局问题
- [ ] 响应式设计正常（PC + 移动端）
- [ ] 所有API端点返回正确的HTTP状态码
- [ ] 错误处理完善（用户友好的错误提示）

### 6.3 性能验收

- [ ] 首屏加载时间 < 2秒
- [ ] API响应时间 < 200ms（P95）
- [ ] 数据库查询有索引优化
- [ ] Redis缓存正常工作

---

## 📅 里程碑

| 里程碑 | 交付物 | 预期时间 |
|-------|--------|---------|
| M1 | 需求文档、设计文档、任务文档 | 1天 |
| M2 | 用户认证系统、用户中心 | 2天 |
| M3 | 动态代理、静态代理购买和管理 | 3天 |
| M4 | 钱包充值、订单管理、交易记录 | 2天 |
| M5 | 管理后台6大模块 | 3天 |
| M6 | 仪表盘、国际化、国旗显示 | 2天 |
| M7 | 测试、修复、部署 | 2天 |
| **总计** | **完整可运行的ProxyHub平台** | **15天** |

---

## 🔖 参考文档

- [技术架构设计](../../../docs/01-技术架构设计.md)
- [985Proxy API文档](../../../985Proxy开放API文档.md)
- [数据库设计](../../../docs/02-数据库设计.md)
- [前端开发规范](../../../docs/05-前端开发规范.md)
- [UI设计规范](../../../docs/12-UI设计规范.md)

---

**文档版本**: v1.0  
**创建日期**: 2025-10-31  
**作者**: AI开发团队  
**审核状态**: 待审核

