<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•è®¢å•è½®è¯¢åŠŸèƒ½</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #409eff;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            background: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #66b1ff;
        }
        .btn:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-entry {
            margin: 5px 0;
        }
        .log-info { color: #3498db; }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status-processing { background: #409eff; color: white; }
        .status-completed { background: #67c23a; color: white; }
        .status-failed { background: #f56c6c; color: white; }
        input {
            padding: 8px;
            width: 100%;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
        }
        .info-box {
            background: #ecf5ff;
            border: 1px solid #d9ecff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ è®¢å•è½®è¯¢åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="info-box">
            <strong>ğŸ“ è¯´æ˜:</strong>
            <ul>
                <li>è®¢å•å·: <code>ORD-1762405269176-17OV90</code> (åˆšè´­ä¹°çš„IP)</li>
                <li>IP: <code>127.134.129.183</code></li>
                <li>é¢„è®¡åŒæ­¥æ—¶é—´: 5-10åˆ†é’Ÿ</li>
            </ul>
        </div>

        <div class="section">
            <h3>1. é…ç½®æµ‹è¯•å‚æ•°</h3>
            <label>è®¢å•å·:</label>
            <input type="text" id="orderNo" value="ORD-1762405269176-17OV90" />
            <br><br>
            <label>è½®è¯¢é—´éš” (æ¯«ç§’):</label>
            <input type="number" id="interval" value="3000" />
            <br><br>
            <label>æœ€å¤§é‡è¯•æ¬¡æ•°:</label>
            <input type="number" id="maxRetries" value="20" />
        </div>

        <div class="section">
            <h3>2. å¼€å§‹æµ‹è¯•</h3>
            <button class="btn" id="startBtn" onclick="startPolling()">â–¶ï¸ å¼€å§‹è½®è¯¢</button>
            <button class="btn" id="stopBtn" onclick="stopPolling()" disabled>â¸ï¸ åœæ­¢è½®è¯¢</button>
            <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            <br><br>
            <div>
                å½“å‰çŠ¶æ€: <span id="status" class="status status-processing">æœªå¼€å§‹</span>
            </div>
            <div>
                é‡è¯•æ¬¡æ•°: <span id="retryCount">0</span> / <span id="maxRetriesDisplay">20</span>
            </div>
        </div>

        <div class="section">
            <h3>3. å®æ—¶æ—¥å¿—</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let pollTimer = null;
        let retryCount = 0;
        const API_BASE = 'http://localhost:3000/api/v1';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(status) {
            const statusSpan = document.getElementById('status');
            statusSpan.textContent = status;
            statusSpan.className = `status status-${status}`;
        }

        function updateRetryCount(count) {
            document.getElementById('retryCount').textContent = count;
        }

        async function checkOrderStatus() {
            const orderNo = document.getElementById('orderNo').value;
            const token = localStorage.getItem('token');

            if (!token) {
                log('âŒ æœªæ‰¾åˆ°ç™»å½•Tokenï¼Œè¯·å…ˆç™»å½•', 'error');
                stopPolling();
                return;
            }

            retryCount++;
            updateRetryCount(retryCount);

            log(`ğŸ” ç¬¬ ${retryCount} æ¬¡æŸ¥è¯¢è®¢å•çŠ¶æ€...`, 'info');

            try {
                const response = await fetch(`${API_BASE}/proxy/static/order/${orderNo}/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    log(`âš ï¸ APIé”™è¯¯: ${data.message}`, 'warning');
                    
                    // å¦‚æœæ˜¯"Node does not exist"ï¼Œç»§ç»­é‡è¯•
                    if (data.message && data.message.includes('Node does not exist')) {
                        log('ğŸ“¡ IPè¿˜æœªåŒæ­¥åˆ°985Proxyç³»ç»Ÿï¼Œç»§ç»­ç­‰å¾…...', 'info');
                        scheduleNextCheck();
                        return;
                    }
                    
                    throw new Error(data.message || 'Unknown error');
                }

                log(`âœ… è·å–è®¢å•çŠ¶æ€æˆåŠŸ`, 'success');
                log(`ğŸ“¦ æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');

                const status = data.status || 'processing';
                updateStatus(status);

                if (status === 'completed') {
                    log('ğŸ‰ è®¢å•å·²å®Œæˆï¼', 'success');
                    stopPolling();
                    return;
                }

                if (status === 'failed') {
                    log('âŒ è®¢å•å¤±è´¥', 'error');
                    stopPolling();
                    return;
                }

                // ç»§ç»­è½®è¯¢
                log(`â±ï¸ çŠ¶æ€ä¸º ${status}ï¼Œç»§ç»­è½®è¯¢...`, 'info');
                scheduleNextCheck();

            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                
                const maxRetries = parseInt(document.getElementById('maxRetries').value);
                if (retryCount < maxRetries) {
                    log(`ğŸ”„ å°†åœ¨ ${document.getElementById('interval').value}ms åé‡è¯•...`, 'info');
                    scheduleNextCheck();
                } else {
                    log('â›” è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢è½®è¯¢', 'error');
                    stopPolling();
                }
            }
        }

        function scheduleNextCheck() {
            const interval = parseInt(document.getElementById('interval').value);
            const maxRetries = parseInt(document.getElementById('maxRetries').value);

            if (retryCount >= maxRetries) {
                log('â›” è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢è½®è¯¢', 'error');
                stopPolling();
                return;
            }

            pollTimer = setTimeout(checkOrderStatus, interval);
        }

        function startPolling() {
            if (pollTimer) {
                log('âš ï¸ è½®è¯¢å·²åœ¨è¿›è¡Œä¸­', 'warning');
                return;
            }

            const orderNo = document.getElementById('orderNo').value;
            if (!orderNo) {
                log('âŒ è¯·è¾“å…¥è®¢å•å·', 'error');
                return;
            }

            retryCount = 0;
            updateRetryCount(0);
            updateStatus('processing');

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('maxRetriesDisplay').textContent = 
                document.getElementById('maxRetries').value;

            log(`ğŸš€ å¼€å§‹è½®è¯¢è®¢å•: ${orderNo}`, 'success');
            log(`âš™ï¸ è½®è¯¢é—´éš”: ${document.getElementById('interval').value}ms`, 'info');
            log(`ğŸ”¢ æœ€å¤§é‡è¯•: ${document.getElementById('maxRetries').value}æ¬¡`, 'info');

            checkOrderStatus();
        }

        function stopPolling() {
            if (pollTimer) {
                clearTimeout(pollTimer);
                pollTimer = null;
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            log('â¹ï¸ è½®è¯¢å·²åœæ­¢', 'warning');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ğŸ“‹ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            log('ğŸ‘‹ è®¢å•è½®è¯¢æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
            log('ğŸ’¡ æç¤º: è¯·ç¡®ä¿å·²åœ¨å‰ç«¯ç™»å½•å¹¶è·å–Token', 'info');
            log('ğŸ“ å½“å‰APIåœ°å€: ' + API_BASE, 'info');
        });
    </script>
</body>
</html>

