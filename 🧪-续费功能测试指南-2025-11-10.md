# 🧪 续费功能测试指南 - 验证价格覆盖修复

**测试日期**: 2025-11-10  
**修复内容**: 续费功能现在正确应用用户特定价格覆盖  
**测试目的**: 验证续费时使用覆盖价格而不是默认价格

---

## 📋 测试准备

### 测试账号
- **邮箱**: `testuser2@example.com`
- **密码**: `TestUser123`
- **当前余额**: $1000.00
- **User ID**: 6

### 价格覆盖配置
此账号已设置以下价格覆盖：
| 地区 | 覆盖价格 | 默认价格 | 折扣 |
|------|----------|----------|------|
| AR / Buenos Aires | **$3/月** | $5/月 | 40% off |
| BR / Rio de Janeiro | **$4/月** | $5/月 | 20% off |
| US / Los Angeles | **$6/月** | $5/月 | +20% |

---

## 🎯 测试步骤

### 步骤1: 登录测试账号

1. 打开浏览器，访问：`http://localhost`
2. 使用测试账号登录
   - 邮箱：`testuser2@example.com`
   - 密码：`TestUser123`

---

### 步骤2: 购买一个IP（验证购买价格覆盖）

1. 点击左侧菜单：**静态住宅 → 静态住宅选购**
2. 选择IP类型：**普通**
3. 购买时长：**30天**
4. 在地区列表中找到 **AR / Buenos Aires**
5. 查看价格显示：应该是 **$3/月**（而不是$5）
6. 点击 **+** 按钮添加1个IP
7. 点击"立即购买"
8. **预期结果**：
   - ✅ 订单总价：**$3.00**
   - ✅ 余额变化：$1000.00 → $997.00

**截图位置**：
- [ ] 选购页面价格显示
- [ ] 订单确认对话框
- [ ] 购买成功提示
- [ ] 余额变化

---

### 步骤3: 查看购买的IP

1. 点击左侧菜单：**静态住宅 → 静态住宅管理**
2. 应该能看到刚才购买的IP
3. 记录IP信息：
   - IP地址：`______________`
   - 到期时间：`______________`
   - 国家/城市：AR / Buenos Aires

---

### 步骤4: 测试续费功能（核心测试）

#### 4.1 打开续费对话框

1. 在"静态住宅管理"页面
2. 找到刚才购买的AR / Buenos Aires的IP
3. 点击该IP行右侧的 **"续费"** 按钮

#### 4.2 选择续费时长

1. 在续费对话框中
2. 选择续费时长：**30天**
3. 查看显示的续费金额

⚠️ **注意**：前端显示的可能是预估价格（$5），这是已知的前端显示问题，不影响实际扣费。

#### 4.3 确认续费

1. 点击 **"确认续费"** 按钮
2. 确认续费操作

#### 4.4 检查扣费金额（关键验证）

**✅ 正确行为（修复后）**：
- 扣费金额：**$3.00**（应用价格覆盖）
- 余额变化：$997.00 → **$994.00**

**❌ 错误行为（修复前）**：
- 扣费金额：$5.00（使用默认价格）
- 余额变化：$997.00 → $992.00

#### 4.5 验证到期时间

1. 续费成功后，查看该IP的到期时间
2. **预期结果**：到期时间延长30天

**截图位置**：
- [ ] 续费对话框
- [ ] 续费成功提示
- [ ] 余额变化（重要！）
- [ ] 新的到期时间

---

## 📊 测试结果记录表

### 购买测试

| 项目 | 预期值 | 实际值 | 通过/失败 |
|------|--------|--------|-----------|
| 购买价格（AR） | $3/月 | _______ | ☐ 通过 / ☐ 失败 |
| 订单总价 | $3.00 | _______ | ☐ 通过 / ☐ 失败 |
| 余额扣除 | $3.00 | _______ | ☐ 通过 / ☐ 失败 |
| 购买后余额 | $997.00 | _______ | ☐ 通过 / ☐ 失败 |

### 续费测试（核心）

| 项目 | 预期值 | 实际值 | 通过/失败 |
|------|--------|--------|-----------|
| 续费价格（应用覆盖） | $3.00 | _______ | ☐ 通过 / ☐ 失败 |
| 余额扣除 | $3.00 | _______ | ☐ 通过 / ☐ 失败 |
| 续费后余额 | $994.00 | _______ | ☐ 通过 / ☐ 失败 |
| 到期时间延长 | +30天 | _______ | ☐ 通过 / ☐ 失败 |

---

## 🔍 深度验证（数据库检查）

如果想更彻底地验证，可以检查数据库记录：

### 查询续费交易记录

```sql
-- 进入数据库容器
docker exec -it proxyhub-postgres psql -U postgres -d proxyhub

-- 查询最新的续费交易
SELECT 
  id, 
  user_id, 
  type, 
  amount, 
  balance_before, 
  balance_after, 
  remark, 
  created_at 
FROM transactions 
WHERE user_id = 6 AND type = 'renewal' 
ORDER BY created_at DESC 
LIMIT 1;
```

**预期结果**：
```
 id | user_id | type    | amount | balance_before | balance_after | remark                     | created_at
----|---------|---------|--------|----------------|---------------|----------------------------|------------
 XX | 6       | renewal | 3.00   | 997.00         | 994.00        | 续费静态住宅IP: X.X.X.X... | 2025-11-10...
```

✅ **关键验证**：`amount` 应该是 **3.00**（而不是5.00）

### 查询用户当前余额

```sql
SELECT id, email, balance 
FROM users 
WHERE id = 6;
```

**预期结果**：
```
 id | email                    | balance
----|--------------------------|--------
 6  | testuser2@example.com    | 994.00
```

---

## 🎯 测试成功标准

### ✅ 测试通过的条件
1. 购买AR/Buenos Aires IP时，价格显示为 **$3/月**
2. 购买时扣费 **$3.00**（余额 $1000 → $997）
3. 续费时扣费 **$3.00**（余额 $997 → $994）
4. 数据库交易记录显示 `amount = 3.00`
5. IP到期时间正确延长30天

### ❌ 测试失败的条件
1. 续费扣费 **$5.00**（使用默认价格）
2. 数据库交易记录显示 `amount = 5.00`
3. 余额变化不符合预期

---

## 🐛 如果测试失败

### 检查清单
1. **Backend容器是否重启？**
   ```bash
   docker ps | grep proxyhub-backend
   # 查看CREATED时间，应该是最近重启的
   ```

2. **代码修改是否生效？**
   ```bash
   # 进入backend容器
   docker exec -it proxyhub-backend bash
   
   # 查看编译后的代码
   cat dist/src/modules/proxy/static/static-proxy.service.js | grep calculatePrice
   # 应该能看到userId参数
   ```

3. **价格覆盖配置是否存在？**
   ```sql
   SELECT * FROM price_overrides WHERE user_id = 6;
   # 应该看到3条记录（AR, BR, US）
   ```

---

## 📝 其他测试场景（可选）

### 场景2: 测试BR/Rio de Janeiro（$4/月）

1. 购买一个BR/Rio de Janeiro的IP
2. 验证购买价格：**$4/月**
3. 续费30天
4. 验证续费扣费：**$4.00**

### 场景3: 测试US/Los Angeles（$6/月，比默认贵）

1. 购买一个US/Los Angeles的IP
2. 验证购买价格：**$6/月**（比默认$5贵）
3. 续费30天
4. 验证续费扣费：**$6.00**

### 场景4: 测试无价格覆盖的地区

1. 购买一个其他地区的IP（如DE/Frankfurt）
2. 验证购买价格：**$5/月**（默认价格）
3. 续费30天
4. 验证续费扣费：**$5.00**

---

## 📸 需要的截图

请提供以下截图以验证修复：

1. ✅ 静态住宅选购页面 - AR/Buenos Aires价格显示
2. ✅ 购买订单确认对话框 - 总价$3.00
3. ✅ 购买成功后的余额显示 - $997.00
4. ✅ 静态IP管理页面 - 显示购买的IP
5. ✅ 续费对话框 - 续费信息
6. ✅ 续费成功后的余额显示 - **$994.00**（核心验证）
7. ✅ 数据库交易记录 - amount=3.00

---

## 🎉 测试完成

完成测试后，请告知结果：
- ✅ 测试通过：续费正确使用价格覆盖（$3而不是$5）
- ❌ 测试失败：续费仍使用默认价格（$5）

如果测试失败，请提供：
1. 续费后的余额变化
2. 数据库交易记录截图
3. Backend容器日志（`docker logs proxyhub-backend --tail 100`）

---

**测试指南生成时间**: 2025-11-10 09:10  
**预计测试时间**: 10-15分钟  
**难度**: ⭐⭐☆☆☆（简单）

