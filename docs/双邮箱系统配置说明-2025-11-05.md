# 📧 双邮箱系统配置说明

**日期**: 2025年11月5日 16:30  
**版本**: v2.0

---

## 🎯 功能概述

ProxyHub现已支持**双邮箱配置**，提供更高的邮件发送可靠性：

✅ **主邮箱**: Microsoft Outlook (`RobinsonKevin5468@outlook.com`)  
✅ **备用邮箱**: Gmail (`chenyuqi061245@gmail.com`)  
✅ **自动切换**: 主邮箱发送失败时自动使用备用邮箱  
✅ **完整日志**: 详细记录每次发送使用的邮箱和结果

---

## 📋 .env 配置内容

请将以下内容**完整复制**到 `backend/.env` 文件中：

```env
# ========================================
# 数据库配置
# ========================================
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=postgres
DB_DATABASE=proxyhub

# ========================================
# JWT配置
# ========================================
JWT_SECRET=your-secret-key-change-in-production-very-important-secret-key-2024
JWT_EXPIRES_IN=7200

# ========================================
# Redis配置
# ========================================
REDIS_HOST=localhost
REDIS_PORT=6379

# ========================================
# 邮件服务配置 - Microsoft Outlook（主邮箱）
# ========================================
MAIL_HOST=smtp-mail.outlook.com
MAIL_PORT=587
MAIL_USER=RobinsonKevin5468@outlook.com
MAIL_PASSWORD=ugfqftyq60695
MAIL_FROM=ProxyHub <RobinsonKevin5468@outlook.com>

# ========================================
# 邮件服务配置 - Gmail（备用邮箱）
# ========================================
MAIL_HOST_BACKUP=smtp.gmail.com
MAIL_PORT_BACKUP=587
MAIL_USER_BACKUP=chenyuqi061245@gmail.com
MAIL_PASSWORD_BACKUP=wvdgyeerdtycwxka
MAIL_FROM_BACKUP=ProxyHub <chenyuqi061245@gmail.com>

# ========================================
# Telegram Bot配置
# ========================================
TELEGRAM_BOT_TOKEN=8578437524:AAE66OfSvFJmma7va8lhaeNK70Q1Sj_HaNo
TELEGRAM_BOT_USERNAME=CannonJarvis

# ========================================
# 应用配置
# ========================================
PORT=3000
NODE_ENV=development
```

---

## 🔧 配置步骤

### 1️⃣ 更新配置文件

```bash
# 1. 打开后端.env文件
notepad backend\.env

# 2. 将上面的配置内容完整复制粘贴
# 3. 保存文件（Ctrl+S）
```

### 2️⃣ 重启后端服务

**方法1: 使用批处理脚本**
```bash
.\启动ProxyHub-最终版.bat
```

**方法2: 手动重启**
```bash
# 停止当前后端进程（Ctrl+C）
cd backend
npm run start:dev
```

### 3️⃣ 验证配置

查看后端启动日志，应该看到：

```
[Nest] LOG 主邮箱服务初始化成功: RobinsonKevin5468@outlook.com
[Nest] LOG 备用邮箱服务初始化成功: chenyuqi061245@gmail.com
```

---

## 🚀 工作原理

### 邮件发送流程

```
┌─────────────────┐
│ 发送邮件请求    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│ 尝试主邮箱（Outlook）发送   │
└────────┬────────────────────┘
         │
    成功？────YES──▶ ✅ 发送完成（主邮箱）
         │
        NO
         │
         ▼
┌─────────────────────────────┐
│ 尝试备用邮箱（Gmail）发送   │
└────────┬────────────────────┘
         │
    成功？────YES──▶ ✅ 发送完成（备用邮箱）
         │
        NO
         │
         ▼
    ❌ 所有邮箱均发送失败
```

---

## 📊 日志示例

### 成功场景1: 主邮箱发送成功
```
[EmailService] ✅ 邮件发送成功（主邮箱）: <message-id@outlook.com>
```

### 成功场景2: 备用邮箱发送成功
```
[EmailService] 主邮箱发送失败: Connection timeout，尝试备用邮箱...
[EmailService] ✅ 邮件发送成功（备用邮箱）: <message-id@gmail.com>
```

### 失败场景: 所有邮箱均失败
```
[EmailService] 主邮箱发送失败: Connection timeout，尝试备用邮箱...
[EmailService] 备用邮箱发送失败: Authentication failed
[EmailService] 所有邮箱均发送失败
```

---

## 🔍 测试清单

### ✅ 配置验证

- [ ] `.env` 文件已更新
- [ ] 主邮箱配置正确（Outlook）
- [ ] 备用邮箱配置正确（Gmail）
- [ ] 后端服务已重启
- [ ] 启动日志显示两个邮箱均初始化成功

### ✅ 功能测试

1. **验证码登录测试**
   - [ ] 访问登录页面 `http://localhost:8080`
   - [ ] 切换到"验证码登录"
   - [ ] 输入邮箱地址
   - [ ] 点击"获取验证码"
   - [ ] 倒计时60秒开始
   - [ ] 检查邮箱收到验证码（Outlook或Gmail）
   - [ ] 输入验证码登录成功

2. **验证码注册测试**
   - [ ] 访问注册页面
   - [ ] 输入邮箱地址
   - [ ] 点击"获取验证码"
   - [ ] 检查邮箱收到验证码
   - [ ] 完成注册流程

3. **邮箱收件验证**
   - [ ] Outlook邮箱收件箱
   - [ ] Gmail邮箱收件箱
   - [ ] 垃圾邮件文件夹

---

## ⚙️ 代码改动说明

### `backend/src/modules/notification/services/email.service.ts`

**新增功能:**
1. ✅ 双transporter初始化（主邮箱 + 备用邮箱）
2. ✅ 自动故障切换机制
3. ✅ 详细日志记录（标识使用的邮箱）
4. ✅ 错误处理和重试逻辑

**主要改动:**
```typescript
// 新增备用transporter
private backupTransporter: nodemailer.Transporter;

// 初始化时创建两个transporter
private initializeTransporter() {
  // 主邮箱（Outlook）
  this.transporter = nodemailer.createTransport(...);
  
  // 备用邮箱（Gmail）
  this.backupTransporter = nodemailer.createTransport(...);
}

// 发送时自动切换
async sendEmail(...) {
  // 先尝试主邮箱
  if (this.transporter) {
    try { ... } catch { /* 切换到备用 */ }
  }
  
  // 再尝试备用邮箱
  if (this.backupTransporter) {
    try { ... } catch { /* 记录失败 */ }
  }
}
```

---

## 📧 邮箱安全设置

### Microsoft Outlook
✅ **已配置**: 使用账号密码直接登录  
✅ **无需额外设置**: Outlook支持应用密码直接使用

### Gmail
⚠️ **注意**: Gmail密码已去除空格  
✅ **应用专用密码**: `wvdgyeerdtycwxka`  
✅ **两步验证**: 已启用

---

## 🎯 下一步

1. **您手动更新 `backend/.env` 文件**
2. **重启后端服务**
3. **告诉我完成后**，我将用 **Chrome DevTools MCP** 进行完整测试：
   - ✅ 验证码发送测试
   - ✅ 验证码登录测试
   - ✅ 邮件接收验证
   - ✅ 管理后台访问测试
   - ✅ 数据一致性验证

---

## 📞 技术支持

如遇到问题，请检查：
1. ✅ Outlook邮箱密码是否正确（无空格）
2. ✅ Gmail应用专用密码是否正确（无空格）
3. ✅ 网络连接是否正常
4. ✅ 防火墙是否允许SMTP连接（端口587）

---

**完成配置后请告诉我，我将立即开始Chrome DevTools测试！** 🚀

