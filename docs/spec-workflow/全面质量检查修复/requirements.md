# ProxyHub 全面质量检查和修复 - 需求文档

## 1. 项目概述

对 ProxyHub 系统进行全面的质量检查和修复，确保所有功能正常运行，数据在各个页面保持一致性，前后端 API 和路由配置正确。

## 2. 发现的问题清单

### 2.1 静态住宅管理问题

#### P0 - 续费功能未扣费
- **现象**：点击续费按钮后，系统未扣除用户余额
- **影响**：用户可以免费续费，造成业务逻辑错误
- **预期行为**：续费应扣除相应费用，并更新余额和IP到期时间

#### P0 - 释放功能未生效
- **现象**：点击释放按钮后，IP仍然显示在静态住宅管理列表中
- **影响**：用户无法释放不需要的IP，IP没有回到IP池
- **预期行为**：释放后IP应从用户列表中移除，IP回到可用池

### 2.2 价格覆盖管理问题

#### P1 - 原生IP价格修改范围错误
- **现象**：修改某个地区的原生IP价格时，所有原生IP价格都被修改
- **影响**：无法针对特定地区设置不同价格
- **预期行为**：应该支持按国家/城市单独修改原生IP价格

### 2.3 余额显示不一致

#### P0 - 支付面板余额与导航栏余额不同步
- **现象**：静态住宅选购界面支付面板显示的余额与导航栏显示的余额不一致
- **影响**：用户对自己的余额产生疑惑
- **预期行为**：所有页面显示的余额应该一致

### 2.4 购买扣费金额错误

#### P0 - 购买10美金IP但扣费5美金
- **现象**：购买标价10美金的IP，实际只扣费5美金
- **影响**：严重的业务逻辑错误，造成收入损失
- **预期行为**：扣费金额应该与显示价格一致

### 2.5 结算记录数据说明不清

#### P2 - 缺少结算记录字段说明
- **需求**：需要清楚解释结算记录中各个字段的含义（结算金额、订单数量等）
- **预期**：提供文档或界面提示说明各字段含义

### 2.6 事件日志未更新

#### P1 - 购买IP后事件日志未记录
- **现象**：购买IP后，事件日志页面没有显示购买记录
- **影响**：用户无法追踪操作历史
- **预期行为**：所有关键操作应该记录到事件日志

### 2.7 数据一致性问题

#### P0 - 全局数据一致性缺失
- **现象**：各个页面显示的数据不一致（余额、订单、IP列表等）
- **影响**：用户体验差，数据可信度低
- **预期行为**：所有页面的数据应该实时同步

### 2.8 我的代理功能

#### P3 - 功能占位符
- **现状**：购买IP后在"我的代理"显示"正在开发"
- **说明**：这是未来功能，暂时保持占位符状态即可

### 2.9 通知管理功能验证

#### P1 - 邮箱和Telegram通知未验证
- **需求**：验证通知管理功能是否真的会发送邮件和Telegram消息
- **预期**：配置后应该能够真实发送通知

### 2.10 用户管理问题

#### P0 - 角色设置未生效
- **现象**：设置其他用户为管理员后，用户角色未改变
- **影响**：无法正常管理用户权限
- **预期行为**：修改用户角色后应立即生效

#### P0 - 禁用用户未生效
- **现象**：禁用用户后，用户仍然可以登录
- **影响**：无法控制用户访问权限
- **预期行为**：禁用后用户应该无法登录

#### P1 - 筛选功能未生效
- **现象**：用户管理页面的筛选功能（角色、状态等）不起作用
- **影响**：管理员无法快速找到目标用户
- **预期行为**：筛选应该正确过滤用户列表

#### P0 - 用户数据不一致
- **现象**：admin@example.com登录后显示的价格和余额与实际不符
- **影响**：数据混乱
- **预期行为**：每个用户看到自己的真实数据

### 2.11 订单管理问题

#### P0 - 订单未实时更新
- **现象**：刚完成的操作（购买、充值等）没有立即显示在订单管理中
- **影响**：管理员无法及时查看最新订单
- **预期行为**：订单应该实时显示

#### P0 - 订单数据不一致
- **现象**：订单管理显示的数据与用户实际操作不符
- **影响**：数据可信度低
- **预期行为**：订单数据应该准确反映实际操作

### 2.12 系统设置问题

#### P1 - 调价功能未验证
- **需求**：验证系统设置中的调价功能是否生效
- **预期**：调价后应该影响所有新订单

#### P1 - 充值设置未验证
- **需求**：验证充值相关设置是否生效
- **预期**：充值设置应该影响充值流程

#### P1 - 客服设置未配置
- **需求**：验证客服设置的前后端API和路由是否配置完整
- **预期**：客服设置应该能够保存并应用

## 3. 修复优先级

### P0 - 紧急（影响核心功能和数据准确性）
1. 续费功能未扣费
2. 释放功能未生效
3. 余额显示不一致
4. 购买扣费金额错误
5. 全局数据一致性缺失
6. 用户角色设置未生效
7. 禁用用户未生效
8. 用户数据不一致
9. 订单未实时更新
10. 订单数据不一致

### P1 - 高优先级（影响用户体验）
1. 原生IP价格修改范围错误
2. 事件日志未更新
3. 筛选功能未生效
4. 通知管理功能验证
5. 调价功能验证
6. 充值设置验证
7. 客服设置配置

### P2 - 中优先级（优化改进）
1. 结算记录数据说明

### P3 - 低优先级（未来功能）
1. 我的代理功能

## 4. 功能需求

### 4.1 静态住宅管理

#### 续费功能
- **输入**：IP ID、续费时长
- **处理**：
  1. 验证用户余额是否足够
  2. 计算续费金额（根据IP类型和时长）
  3. 扣除用户余额
  4. 更新IP到期时间
  5. 创建续费订单
  6. 记录交易明细
  7. 记录事件日志
- **输出**：续费成功消息，更新后的余额和IP信息

#### 释放功能
- **输入**：IP ID
- **处理**：
  1. 验证IP归属
  2. 删除用户的静态代理记录（或标记为已释放）
  3. 将IP状态改为可用（回到IP池）
  4. 记录事件日志
- **输出**：释放成功消息，更新后的IP列表

### 4.2 价格覆盖管理

#### 单个地区价格修改
- **输入**：国家代码、城市名称、IP类型、新价格
- **处理**：
  1. 验证输入参数
  2. 创建或更新特定地区的价格覆盖记录
  3. 清除价格缓存
- **输出**：修改成功消息
- **限制**：只影响指定国家/城市/IP类型组合

### 4.3 余额同步

#### 全局余额一致性
- **要求**：
  1. 所有页面使用统一的用户状态管理（Pinia store）
  2. 任何余额变动后立即调用 `userStore.fetchUserInfo()` 更新
  3. 支付面板从 store 获取余额，而非本地计算
  4. 导航栏余额也从 store 获取

### 4.4 购买扣费修正

#### 价格计算准确性
- **要求**：
  1. 前端显示价格应该调用 `calculatePrice` API
  2. 后端计算价格应该考虑价格覆盖
  3. 扣费金额必须与计算出的总价一致
  4. 显示价格 = 实际扣费金额

### 4.5 事件日志完整性

#### 自动记录关键操作
- **需要记录的事件**：
  1. 用户登录/注册
  2. 购买静态IP
  3. 续费静态IP
  4. 释放静态IP
  5. 充值申请
  6. 充值审核通过/拒绝
  7. 修改密码
  8. 生成/重置API密钥
  9. 用户角色变更（管理员操作）
  10. 用户状态变更（管理员操作）

### 4.6 用户管理功能

#### 角色设置
- **输入**：用户ID、新角色
- **处理**：
  1. 验证操作权限（只有管理员可以）
  2. 更新用户角色
  3. 记录事件日志
- **输出**：角色更新成功，用户列表刷新

#### 禁用用户
- **输入**：用户ID、状态（active/disabled）
- **处理**：
  1. 验证操作权限
  2. 更新用户状态
  3. 如果是禁用，应该撤销用户的所有有效会话（Token）
  4. 记录事件日志
- **输出**：状态更新成功，用户列表刷新

#### 筛选功能
- **支持筛选条件**：
  1. 用户角色（普通用户/管理员）
  2. 用户状态（正常/禁用）
  3. 用户邮箱（搜索）
- **实现**：前端筛选或后端API支持筛选参数

### 4.7 订单管理功能

#### 实时更新
- **要求**：
  1. 页面加载时获取最新订单
  2. 提供手动刷新功能
  3. 订单列表按创建时间倒序排列

#### 数据准确性
- **要求**：
  1. 订单详情必须准确反映实际操作
  2. 订单状态应该与实际状态一致
  3. 订单金额应该与扣费金额一致

### 4.8 系统设置功能

#### 调价设置
- **要求**：
  1. 支持修改基础价格配置
  2. 修改后应该影响所有新订单
  3. 提供价格历史记录

#### 充值设置
- **要求**：
  1. 支持设置充值相关参数
  2. 设置应该影响充值流程

#### 客服设置
- **要求**：
  1. 前后端API完整配置
  2. 支持保存客服联系方式
  3. 用户端能够看到客服信息

## 5. 非功能需求

### 5.1 数据一致性
- 所有页面的数据必须实时同步
- 使用统一的数据源（API + Pinia Store）
- 任何数据变动后立即刷新相关页面

### 5.2 API 和路由完整性
- 所有前端API调用必须有对应的后端路由
- 所有后端路由必须有适当的权限控制
- API响应格式统一

### 5.3 用户体验
- 操作反馈及时（加载提示、成功/失败消息）
- 错误提示清晰
- 数据加载使用骨架屏或加载动画

### 5.4 可交付性
- 所有核心功能正常运行
- 没有明显的bug
- 数据准确性100%
- 提供完整的测试报告

## 6. 验收标准

### 6.1 功能验收
- [ ] 续费功能正确扣费并更新IP到期时间
- [ ] 释放功能正确移除IP并回到IP池
- [ ] 价格覆盖支持单个地区修改
- [ ] 所有页面余额显示一致
- [ ] 购买扣费金额与显示价格一致
- [ ] 所有关键操作都记录到事件日志
- [ ] 用户角色设置立即生效
- [ ] 禁用用户后无法登录
- [ ] 筛选功能正确工作
- [ ] 订单实时更新
- [ ] 系统设置功能完整

### 6.2 数据一致性验收
- [ ] 购买IP后，余额、订单、IP列表、事件日志全部同步更新
- [ ] 续费IP后，余额、订单、IP到期时间、事件日志全部同步更新
- [ ] 释放IP后，IP列表、事件日志全部同步更新
- [ ] 充值审核后，余额、充值订单、交易明细、事件日志全部同步更新

### 6.3 API/路由验收
- [ ] 所有前端页面的API调用都能成功
- [ ] 所有后端API都有适当的权限控制
- [ ] 没有404或500错误

## 7. 测试计划

### 7.1 功能测试
1. 静态住宅管理：续费、释放
2. 价格覆盖管理：单个地区价格修改
3. 购买流程：价格显示、扣费金额、余额更新
4. 用户管理：角色设置、禁用用户、筛选
5. 订单管理：实时更新、数据准确性
6. 系统设置：调价、充值设置、客服设置

### 7.2 数据一致性测试
1. 购买IP端到端测试
2. 续费IP端到端测试
3. 释放IP端到端测试
4. 充值审核端到端测试

### 7.3 API/路由测试
1. 检查所有前端API调用
2. 检查所有后端路由配置
3. 检查权限控制

## 8. 交付物

1. 修复后的代码（前端 + 后端）
2. 完整的测试报告
3. 结算记录字段说明文档
4. 部署和启动指南
5. 已知限制和未来改进建议


