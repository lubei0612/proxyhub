# Phase 1 已修复功能测试指南

## 前置条件

### 1. 启动服务
```bash
# 后端已在后台运行 (http://localhost:3000)
# 前端应该在 http://localhost:8080

# 如果前端未启动，请运行：
cd D:\Users\Desktop\proxyhub\frontend
npm run dev
```

### 2. 测试账号
- **管理员账号**: admin@example.com / admin123
- **普通用户账号**: user@example.com / user123
- **用户初始余额**: $1000

---

## 测试 1: 支付面板余额显示一致性 ✅

### 测试目的
验证静态住宅选购页面的支付面板显示的余额与导航栏一致

### 测试步骤
1. 使用 `user@example.com` 登录
2. 导航到 **静态住宅代理 → 静态住宅选购**
3. **观察点1**: 查看页面右上角导航栏显示的余额（例如：$1000.00）
4. 在左侧选择任意IP（例如：美国-Los Angeles，数量1）
5. **观察点2**: 查看右侧支付面板中的"钱包余额"
6. **验证**: 两处显示的余额应该完全一致

### 预期结果
✅ 导航栏余额 = 支付面板余额 = $1000.00

### 失败标志
❌ 两处显示的余额不一致

---

## 测试 2: 购买扣费金额准确性 ✅

### 测试目的
验证购买IP时扣费金额与显示价格一致

### 测试前准备
1. 登录管理员账号 `admin@example.com`
2. 导航到 **价格覆盖管理**
3. 找到 **美国-Chicago-原生IP** 卡片
4. 修改价格为 **$10.00**
5. 点击 **保存修改**

### 测试步骤（使用普通用户账号）
1. 使用 `user@example.com` 登录
2. 记录当前余额（例如：$1000.00）
3. 导航到 **静态住宅代理 → 静态住宅选购**
4. 选择IP类型：**原生**（Premium）
5. 时长：**30天**
6. 选择 **美国-Chicago**，数量 **1**
7. **观察点1**: 支付详情中显示的单价应该是 **$10.00/月**
8. **观察点2**: 总计费用应该是 **$10.00**
9. 点击 **钱包余额支付**
10. 打开浏览器开发者工具（F12）→ Network 标签
11. 过滤 `purchase` 请求
12. **观察点3**: 查看请求响应中的 `newBalance` 字段
13. **计算**: 新余额应该 = 原余额 - $10.00
14. **观察点4**: 导航栏余额立即更新

### 预期结果
✅ 显示价格: $10.00
✅ 实际扣费: $10.00
✅ 新余额 = $1000.00 - $10.00 = $990.00
✅ 导航栏余额立即更新为 $990.00

### Chrome DevTools 验证
```
Network → purchase 请求 → Response:
{
  "success": true,
  "message": "成功购买 1 个静态IP",
  "order": {
    "totalPrice": 10,
    ...
  },
  "newBalance": "990.00"
}
```

---

## 测试 3: 续费功能 ✅

### 测试目的
验证续费功能正确扣费并更新IP到期时间

### 测试前准备
确保用户已购买至少1个IP（可以使用测试2的结果）

### 测试步骤
1. 使用 `user@example.com` 登录
2. 记录当前余额（例如：$990.00）
3. 导航到 **静态住宅代理 → 静态住宅管理**
4. 在IP列表中找到刚购买的IP（美国-Chicago）
5. 记录当前 **到期时间**（例如：2025-12-04）
6. 点击该IP的 **续费** 按钮
7. 在续费对话框中选择 **30天**
8. **观察点1**: 续费金额显示（应该基于IP类型和地区价格）
9. 点击 **确认续费**
10. 打开浏览器开发者工具 → Network
11. 过滤 `renew` 请求
12. **观察点2**: 查看响应中的 `renewalPrice` 和 `newBalance`
13. **观察点3**: 页面自动刷新后，查看导航栏余额
14. **观察点4**: 查看IP列表中该IP的到期时间是否延长30天

### 预期结果
✅ 续费价格正确计算（原生IP $10.00）
✅ 余额扣除正确：$990.00 - $10.00 = $980.00
✅ 导航栏余额立即更新为 $980.00
✅ IP到期时间延长30天（2025-12-04 → 2026-01-03）
✅ 列表自动刷新

### Chrome DevTools 验证
```
Network → renew 请求 → Response:
{
  "success": true,
  "message": "续费成功",
  "proxy": {
    "id": 123,
    "ip": "66.9.178.60",
    "expiresAt": "2026-01-03T..."
  },
  "newBalance": "980.00",
  "renewalPrice": 10
}
```

### 后端日志验证
```
[StaticProxyService] [Renew Static Proxy] User: 1, Proxy: 123, Duration: 30 days
[StaticProxyService] [Renew] Price: $10 (30 days)
[StaticProxyService] [Renew] Success! Proxy: 66.9.178.60, New Expiry: 2026-01-03...
```

---

## 测试 4: 释放功能 ✅

### 测试目的
验证释放功能正确删除IP并从列表中移除

### 测试步骤
1. 使用 `user@example.com` 登录
2. 导航到 **静态住宅代理 → 静态住宅管理**
3. 记录当前IP列表数量（例如：1个）
4. 选择一个不需要的IP
5. 点击 **释放** 按钮
6. 在确认对话框中点击 **确认**
7. 打开浏览器开发者工具 → Network
8. 过滤 `DELETE` 请求
9. **观察点1**: 查看响应状态码（应该是200）
10. **观察点2**: 页面自动刷新后，该IP从列表中消失
11. **观察点3**: IP总数减1

### 预期结果
✅ 确认对话框正确显示
✅ DELETE请求成功（200 OK）
✅ IP从列表中移除
✅ 列表自动刷新
✅ 成功提示消息显示

### Chrome DevTools 验证
```
Network → DELETE /api/v1/proxy/static/123 → Response:
{
  "success": true,
  "message": "释放成功"
}
```

### 后端日志验证
```
[StaticProxyService] [Release Static Proxy] User: 1, Proxy: 123
[StaticProxyService] [Release] Success! Proxy: 66.9.178.60 (US/Chicago)
[EventLogService] [Create Log] Type: IP释放, Content: 释放静态IP: 66.9.178.60 (US/Chicago)
```

---

## 测试 5: 事件日志记录（附加验证）

### 测试目的
验证续费和释放操作是否记录到事件日志

### 测试步骤
1. 完成测试3（续费）和测试4（释放）后
2. 导航到 **账户管理 → 事件日志**
3. **观察点1**: 查找续费操作记录
   - 类型：IP续费
   - 内容：续费静态IP: {ip}, 时长: 30天, 金额: $10.00
4. **观察点2**: 查找释放操作记录
   - 类型：IP释放
   - 内容：释放静态IP: {ip} (US/Chicago)

### 预期结果
✅ 事件日志中存在续费记录
✅ 事件日志中存在释放记录
✅ 记录时间准确
✅ 记录内容详细

---

## 数据一致性检查清单

完成所有测试后，请验证以下数据一致性：

### 余额一致性
- [ ] 导航栏余额
- [ ] 支付面板余额
- [ ] 账户中心余额
- [ ] 所有显示的余额完全一致

### 订单一致性
- [ ] 购买IP后，订单管理中有新订单
- [ ] 续费后，订单管理中有续费订单
- [ ] 订单金额与实际扣费一致
- [ ] 订单状态正确（已完成）

### IP列表一致性
- [ ] 购买后，静态住宅管理中显示新IP
- [ ] 续费后，IP到期时间正确更新
- [ ] 释放后，IP从列表中移除
- [ ] IP数量统计准确

### 交易明细一致性
- [ ] 购买操作有对应的交易记录
- [ ] 续费操作有对应的交易记录
- [ ] 交易金额准确
- [ ] 余额前后值正确

---

## 测试报告模板

请在测试完成后填写以下报告：

```markdown
# Phase 1 修复功能测试报告

测试时间：2025-11-04
测试人员：[您的名字]
后端版本：最新（包含续费/释放功能）
前端版本：最新（包含余额统一获取）

## 测试结果摘要

- ✅/❌ 测试1: 支付面板余额显示一致性
- ✅/❌ 测试2: 购买扣费金额准确性
- ✅/❌ 测试3: 续费功能
- ✅/❌ 测试4: 释放功能
- ✅/❌ 测试5: 事件日志记录

## 发现的问题

1. [问题描述]
   - 严重程度：P0/P1/P2
   - 复现步骤：...
   - 预期结果：...
   - 实际结果：...
   - 截图/日志：...

## 建议

[您的建议]

## 下一步

- [ ] 修复发现的问题
- [ ] 继续修复剩余的10个问题
- [ ] 进行完整的端到端测试
```

---

## Chrome DevTools 使用提示

### 打开开发者工具
- Windows: `F12` 或 `Ctrl + Shift + I`
- Mac: `Cmd + Option + I`

### Network 标签使用
1. 切换到 Network 标签
2. 勾选 "Preserve log"（保留日志）
3. 在过滤框中输入关键词（如 `purchase`, `renew`, `delete`）
4. 执行操作
5. 点击请求查看详细信息
6. 切换到 "Response" 查看响应数据

### Console 标签使用
1. 切换到 Console 标签
2. 查看是否有错误信息（红色）
3. 查看 API 调用日志（蓝色）

---

**准备好开始测试了吗？**

如果需要我使用Chrome DevTools帮您测试，请：
1. 在浏览器中打开 `http://localhost:8080`
2. 确保Chrome DevTools MCP已连接
3. 告诉我开始测试

或者您可以按照本指南手动测试，并将结果告诉我！


