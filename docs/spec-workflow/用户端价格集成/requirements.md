# 用户端价格API集成 - 需求文档

**创建日期**: 2025-11-04  
**优先级**: P0 - 阻塞核心功能  
**预计工时**: 1小时  

---

## 📋 需求概述

### 背景
管理员在"价格覆盖管理"页面设置的价格覆盖，在用户端"静态住宅选购"页面无法生效。用户看到的仍是硬编码的默认价格（普通$5，原生$8），而不是管理员设置的实际价格。

### 目标
集成后端价格计算API到用户端，使价格覆盖配置能够正确显示给用户。

---

## 🎯 功能需求

### FR1: 价格API集成
**优先级**: P0  
**描述**: 用户端调用后端`POST /api/v1/price/calculate` API获取实际价格

**验收标准**:
- [ ] 页面加载时调用价格API获取所有地区价格
- [ ] 切换IP类型时重新获取价格
- [ ] 切换时长时重新计算价格
- [ ] API调用失败时显示默认价格作为fallback

### FR2: 价格缓存机制
**优先级**: P0  
**描述**: 实现价格缓存避免重复API调用

**验收标准**:
- [ ] 使用Map存储价格缓存
- [ ] 缓存key格式: `${country}-${city}-${ipType}`
- [ ] IP类型/时长变化时清除并重新加载缓存

### FR3: 混合加载策略
**优先级**: P0  
**描述**: 首次显示基础价格，后台异步更新实际价格

**验收标准**:
- [ ] 页面立即显示（使用基础价格）
- [ ] 后台异步加载实际价格
- [ ] 价格更新时无闪烁
- [ ] 显示加载状态指示器

### FR4: 错误处理
**优先级**: P1  
**描述**: API调用失败时的降级处理

**验收标准**:
- [ ] 网络错误时使用基础价格
- [ ] 显示错误提示消息
- [ ] 不影响页面正常使用
- [ ] 记录错误日志

---

## 🔧 技术需求

### TR1: API调用
- 使用已有的`@/api/modules/pricing`模块
- 调用`calculatePrice()`函数
- 处理Promise异步响应

### TR2: 响应式更新
- 使用Vue 3的`ref`和`computed`
- 监听`ipType`和`duration`变化
- 自动触发价格重新加载

### TR3: 性能优化
- 批量请求所有地区价格（一次API调用）
- 避免单个地区单独请求
- 使用缓存减少重复计算

---

## 📊 测试需求

### 单元测试
- [ ] 价格缓存get/set功能
- [ ] 价格计算逻辑
- [ ] API调用参数构造

### 集成测试
- [ ] 完整的价格加载流程
- [ ] IP类型切换后价格更新
- [ ] 时长切换后价格更新

### 端到端测试 (Chrome DevTools)
- [ ] 页面加载验证价格API调用
- [ ] 日本Tokyo原生IP显示$10/月
- [ ] 其他地区价格正确显示
- [ ] 切换IP类型价格正确更新
- [ ] 网络错误时降级到基础价格

---

## 🚫 非功能需求

### 性能要求
- 首屏渲染时间 < 1秒（显示基础价格）
- 价格API响应时间 < 500ms
- 价格更新无明显延迟

### 兼容性要求
- 支持Chrome/Edge/Firefox/Safari最新版本
- 移动端浏览器正常显示

### 可维护性要求
- 代码结构清晰
- 添加适当注释
- 错误处理完善

---

## 📝 约束条件

### 技术约束
- 必须使用现有的pricing API
- 不修改后端代码
- 兼容现有的UI组件

### 业务约束
- 不影响现有购买流程
- 价格必须与管理后台一致
- 支持所有26个地区

---

## 🔄 依赖关系

### 依赖项
- ✅ 后端价格计算API已实现
- ✅ 价格覆盖管理功能已完成
- ✅ 数据库配置已初始化

### 被依赖项
- 用户购买功能依赖准确的价格显示
- 订单金额计算依赖价格API

---

## 📅 里程碑

| 里程碑 | 预计时间 | 状态 |
|--------|----------|------|
| 需求文档完成 | 10分钟 | ✅ |
| 设计方案确定 | 10分钟 | ⏳ |
| 代码实现 | 30分钟 | ⏳ |
| 测试验证 | 15分钟 | ⏳ |
| 文档更新 | 5分钟 | ⏳ |

**总计**: 约1小时

