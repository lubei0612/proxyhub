# åŠ¨æ€ä»£ç†å’Œé€šçŸ¥ç³»ç»Ÿ - è®¾è®¡æ–‡æ¡£

## ğŸ“ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (Vue 3)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŠ¨æ€ä»£ç†ç®¡ç†      â”‚  é€šçŸ¥è®¾ç½®é¡µé¢     â”‚  Telegramç»‘å®šé¡µé¢   â”‚
â”‚ - é€šé“åˆ—è¡¨        â”‚  - é‚®ä»¶é€šçŸ¥å¼€å…³   â”‚  - ç»‘å®šæµç¨‹          â”‚
â”‚ - æ·»åŠ /ç¼–è¾‘é€šé“   â”‚  - Telegramå¼€å…³   â”‚  - ç»‘å®šç ç”Ÿæˆ        â”‚
â”‚ - æµé‡ç»Ÿè®¡        â”‚  - é€šçŸ¥å†å²       â”‚  - çŠ¶æ€æ˜¾ç¤º          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIå±‚ (NestJS)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŠ¨æ€ä»£ç†æ¨¡å—      â”‚  é€šçŸ¥æ¨¡å—         â”‚  Telegramæ¨¡å—       â”‚
â”‚ - ChannelService â”‚  - NotifyService  â”‚  - TelegramService  â”‚
â”‚ - UsageService   â”‚  - EmailService   â”‚  - WebhookHandler   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å±‚ (PostgreSQL)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ dynamic_channels â”‚  notifications   â”‚  notification_       â”‚
â”‚ dynamic_usage    â”‚  notification_   â”‚  settings            â”‚
â”‚                  â”‚  templates       â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤–éƒ¨æœåŠ¡                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SMTPæœåŠ¡å™¨        â”‚  Telegram Bot    â”‚  (æœªæ¥) 985Proxy    â”‚
â”‚ - Gmail/SendGrid â”‚  - Bot API       â”‚  - çœŸå®APIå¯¹æ¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. åŠ¨æ€ä»£ç†é€šé“è¡¨ (dynamic_channels)

```sql
CREATE TABLE dynamic_channels (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  channel_name VARCHAR(100) NOT NULL,
  price_per_gb DECIMAL(10, 2) NOT NULL DEFAULT 4.5,
  concurrent_limit INTEGER NOT NULL DEFAULT 1000,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  total_traffic DECIMAL(15, 3) NOT NULL DEFAULT 0,
  total_cost DECIMAL(10, 2) NOT NULL DEFAULT 0,
  remark TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT channels_status_check CHECK (status IN ('active', 'paused', 'disabled'))
);

CREATE INDEX idx_channels_user_id ON dynamic_channels(user_id);
CREATE INDEX idx_channels_status ON dynamic_channels(status);
```

### 2. åŠ¨æ€ä»£ç†æµé‡ä½¿ç”¨è¡¨ (dynamic_usage)

```sql
CREATE TABLE dynamic_usage (
  id SERIAL PRIMARY KEY,
  channel_id INTEGER NOT NULL REFERENCES dynamic_channels(id) ON DELETE CASCADE,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  requests INTEGER NOT NULL DEFAULT 0,
  success_rate DECIMAL(5, 2) NOT NULL DEFAULT 0,
  traffic DECIMAL(10, 3) NOT NULL DEFAULT 0,
  cost DECIMAL(10, 2) NOT NULL DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT usage_unique_channel_date UNIQUE (channel_id, date)
);

CREATE INDEX idx_usage_channel_id ON dynamic_usage(channel_id);
CREATE INDEX idx_usage_user_id ON dynamic_usage(user_id);
CREATE INDEX idx_usage_date ON dynamic_usage(date);
```

### 3. é€šçŸ¥è¡¨ (notifications)

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type VARCHAR(20) NOT NULL,
  category VARCHAR(50) NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  is_read BOOLEAN NOT NULL DEFAULT FALSE,
  read_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT notifications_type_check CHECK (type IN ('success', 'info', 'warning', 'error')),
  CONSTRAINT notifications_category_check CHECK (category IN ('order', 'recharge', 'expiration', 'balance', 'system', 'proxy'))
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
```

### 4. é€šçŸ¥è®¾ç½®è¡¨ (notification_settings)

```sql
CREATE TABLE notification_settings (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  email_enabled BOOLEAN NOT NULL DEFAULT TRUE,
  telegram_enabled BOOLEAN NOT NULL DEFAULT FALSE,
  order_notification BOOLEAN NOT NULL DEFAULT TRUE,
  recharge_notification BOOLEAN NOT NULL DEFAULT TRUE,
  expiration_notification BOOLEAN NOT NULL DEFAULT TRUE,
  low_balance_notification BOOLEAN NOT NULL DEFAULT TRUE,
  low_balance_threshold DECIMAL(10, 2) NOT NULL DEFAULT 50,
  system_notification BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notification_settings_user_id ON notification_settings(user_id);
```

### 5. é‚®ä»¶æ¨¡æ¿è¡¨ (email_templates)

```sql
CREATE TABLE email_templates (
  id SERIAL PRIMARY KEY,
  template_key VARCHAR(50) NOT NULL UNIQUE,
  subject VARCHAR(200) NOT NULL,
  html_content TEXT NOT NULL,
  text_content TEXT,
  variables JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é¢„è®¾æ¨¡æ¿æ•°æ®
INSERT INTO email_templates (template_key, subject, html_content, variables) VALUES
('order_success', 'ProxyHub - è®¢å•è´­ä¹°æˆåŠŸ', '<html>...</html>', '{"orderNo", "amount", "details"}'),
('recharge_approved', 'ProxyHub - å……å€¼å®¡æ ¸é€šè¿‡', '<html>...</html>', '{"amount", "balance"}'),
('ip_expiring', 'ProxyHub - IPå³å°†åˆ°æœŸæé†’', '<html>...</html>', '{"ipAddress", "expiryDate"}');
```

### 6. usersè¡¨æ–°å¢å­—æ®µ

```sql
ALTER TABLE users ADD COLUMN telegram_chat_id VARCHAR(50);
ALTER TABLE users ADD COLUMN telegram_username VARCHAR(100);
ALTER TABLE users ADD COLUMN telegram_bind_at TIMESTAMP;
ALTER TABLE users ADD COLUMN telegram_bind_code VARCHAR(20);

CREATE INDEX idx_users_telegram_chat_id ON users(telegram_chat_id);
CREATE INDEX idx_users_telegram_bind_code ON users(telegram_bind_code);
```

---

## ğŸ—ï¸ åç«¯æ¶æ„è®¾è®¡

### æ¨¡å—åˆ’åˆ†

#### 1. DynamicProxyModule

**èŒè´£**: åŠ¨æ€ä»£ç†é€šé“å’Œæµé‡ç®¡ç†

**å®ä½“**:
- `DynamicChannel` - é€šé“å®ä½“
- `DynamicUsage` - æµé‡ä½¿ç”¨å®ä½“

**æœåŠ¡**:
```typescript
@Injectable()
export class DynamicChannelService {
  // é€šé“ç®¡ç†
  async createChannel(userId: number, dto: CreateChannelDto): Promise<DynamicChannel>
  async updateChannel(id: number, userId: number, dto: UpdateChannelDto): Promise<DynamicChannel>
  async deleteChannel(id: number, userId: number): Promise<void>
  async toggleChannelStatus(id: number, userId: number): Promise<DynamicChannel>
  async getChannels(userId: number, filters: ChannelFiltersDto): Promise<PaginatedResult<DynamicChannel>>
  async getChannelStatistics(userId: number): Promise<ChannelStatistics>
}

@Injectable()
export class DynamicUsageService {
  // æµé‡ä½¿ç”¨ç®¡ç†
  async recordUsage(channelId: number, dto: RecordUsageDto): Promise<DynamicUsage>
  async getUsageHistory(channelId: number, filters: UsageFiltersDto): Promise<PaginatedResult<DynamicUsage>>
  async getUsageStatistics(userId: number, dateRange: DateRangeDto): Promise<UsageStatistics>
  
  // å®šæ—¶ä»»åŠ¡ï¼šæ¨¡æ‹Ÿæµé‡ä½¿ç”¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  @Cron('0 0 * * *') // æ¯å¤©å‡Œæ™¨
  async generateMockUsage(): Promise<void>
}
```

**æ§åˆ¶å™¨**:
```typescript
@Controller('proxy/dynamic')
@UseGuards(JwtAuthGuard)
export class DynamicProxyController {
  @Get('channels')
  async getChannels(@Request() req, @Query() filters: ChannelFiltersDto) {}
  
  @Post('channels')
  async createChannel(@Request() req, @Body() dto: CreateChannelDto) {}
  
  @Put('channels/:id')
  async updateChannel(@Param('id') id: string, @Request() req, @Body() dto: UpdateChannelDto) {}
  
  @Delete('channels/:id')
  async deleteChannel(@Param('id') id: string, @Request() req) {}
  
  @Patch('channels/:id/toggle')
  async toggleStatus(@Param('id') id: string, @Request() req) {}
  
  @Get('usage')
  async getUsage(@Request() req, @Query() filters: UsageFiltersDto) {}
  
  @Get('statistics')
  async getStatistics(@Request() req, @Query() dateRange: DateRangeDto) {}
}
```

#### 2. NotificationModule

**èŒè´£**: é€šçŸ¥åˆ›å»ºã€å‘é€ã€å†å²ç®¡ç†

**å®ä½“**:
- `Notification` - é€šçŸ¥å®ä½“
- `NotificationSetting` - é€šçŸ¥è®¾ç½®å®ä½“
- `EmailTemplate` - é‚®ä»¶æ¨¡æ¿å®ä½“

**æœåŠ¡**:
```typescript
@Injectable()
export class NotificationService {
  constructor(
    @InjectRepository(Notification) private notificationRepo: Repository<Notification>,
    @InjectRepository(NotificationSetting) private settingsRepo: Repository<NotificationSetting>,
    private emailService: EmailService,
    private telegramService: TelegramService,
  ) {}
  
  // é€šçŸ¥åˆ›å»º
  async createNotification(dto: CreateNotificationDto): Promise<Notification> {
    const notification = await this.notificationRepo.save(dto);
    
    // è·å–ç”¨æˆ·é€šçŸ¥è®¾ç½®
    const settings = await this.getSettings(dto.userId);
    
    // æ ¹æ®è®¾ç½®å‘é€é€šçŸ¥
    if (settings.emailEnabled && this.shouldSendEmail(settings, dto.category)) {
      await this.emailService.sendNotification(dto.userId, notification);
    }
    
    if (settings.telegramEnabled && this.shouldSendTelegram(settings, dto.category)) {
      await this.telegramService.sendNotification(dto.userId, notification);
    }
    
    return notification;
  }
  
  // é€šçŸ¥å†å²
  async getNotifications(userId: number, filters: NotificationFiltersDto): Promise<PaginatedResult<Notification>>
  async markAsRead(id: string, userId: number): Promise<Notification>
  async markAllAsRead(userId: number): Promise<void>
  async deleteNotification(id: string, userId: number): Promise<void>
  
  // é€šçŸ¥è®¾ç½®
  async getSettings(userId: number): Promise<NotificationSetting>
  async updateSettings(userId: number, dto: UpdateSettingsDto): Promise<NotificationSetting>
}

@Injectable()
export class EmailService {
  private transporter: nodemailer.Transporter;
  
  constructor(private configService: ConfigService) {
    this.transporter = nodemailer.createTransport({
      host: this.configService.get('MAIL_HOST'),
      port: this.configService.get('MAIL_PORT'),
      secure: false,
      auth: {
        user: this.configService.get('MAIL_USER'),
        pass: this.configService.get('MAIL_PASSWORD'),
      },
    });
  }
  
  async sendNotification(userId: number, notification: Notification): Promise<void> {
    const user = await this.getUserWithEmail(userId);
    const template = await this.getTemplate(notification.category);
    
    const html = this.renderTemplate(template.htmlContent, notification);
    
    await this.transporter.sendMail({
      from: this.configService.get('MAIL_FROM'),
      to: user.email,
      subject: notification.title,
      html,
    });
  }
  
  async sendCustomEmail(to: string, subject: string, html: string): Promise<void>
}
```

#### 3. TelegramModule

**èŒè´£**: Telegram Botäº¤äº’ã€é€šçŸ¥æ¨é€

**æœåŠ¡**:
```typescript
@Injectable()
export class TelegramService {
  private bot: TelegramBot;
  
  constructor(
    private configService: ConfigService,
    @InjectRepository(User) private userRepo: Repository<User>,
  ) {
    const token = this.configService.get('TELEGRAM_BOT_TOKEN');
    this.bot = new TelegramBot(token, { polling: true });
    
    this.setupCommands();
  }
  
  private setupCommands() {
    // /start - ç»‘å®šæµç¨‹
    this.bot.onText(/\/start/, async (msg) => {
      const chatId = msg.chat.id;
      await this.bot.sendMessage(chatId, 
        'æ¬¢è¿ä½¿ç”¨ProxyHubé€šçŸ¥æœåŠ¡ï¼\n\n' +
        'è¯·è¾“å…¥æ‚¨çš„ç»‘å®šç ï¼ˆæ ¼å¼: XXXX-XXXXï¼‰\n' +
        'åœ¨ProxyHubç½‘ç«™çš„"è´¦æˆ·è®¾ç½®"ä¸­è·å–ç»‘å®šç '
      );
    });
    
    // /balance - æŸ¥è¯¢ä½™é¢
    this.bot.onText(/\/balance/, async (msg) => {
      const user = await this.getUserByChatId(msg.chat.id.toString());
      if (!user) {
        await this.bot.sendMessage(msg.chat.id, 'è¯·å…ˆç»‘å®šè´¦æˆ·');
        return;
      }
      await this.bot.sendMessage(msg.chat.id, 
        `ğŸ’° å½“å‰ä½™é¢: $${user.balance.toFixed(2)}\n` +
        `ğŸ èµ é€é‡‘é¢: $${user.giftBalance.toFixed(2)}`
      );
    });
    
    // /unbind - è§£ç»‘
    this.bot.onText(/\/unbind/, async (msg) => {
      await this.unbindTelegram(msg.chat.id.toString());
      await this.bot.sendMessage(msg.chat.id, 'å·²è§£ç»‘æˆåŠŸ');
    });
    
    // å¤„ç†ç»‘å®šç 
    this.bot.on('message', async (msg) => {
      if (msg.text && /^[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(msg.text)) {
        await this.handleBindCode(msg.chat.id.toString(), msg.text, msg.from?.username);
      }
    });
  }
  
  async generateBindCode(userId: number): Promise<string> {
    const code = this.randomCode();
    await this.userRepo.update(userId, {
      telegramBindCode: code,
    });
    return code;
  }
  
  async handleBindCode(chatId: string, code: string, username?: string): Promise<void> {
    const user = await this.userRepo.findOne({
      where: { telegramBindCode: code },
    });
    
    if (!user) {
      await this.bot.sendMessage(chatId, 'âŒ ç»‘å®šç æ— æ•ˆæˆ–å·²è¿‡æœŸ');
      return;
    }
    
    await this.userRepo.update(user.id, {
      telegramChatId: chatId,
      telegramUsername: username,
      telegramBindAt: new Date(),
      telegramBindCode: null,
    });
    
    await this.bot.sendMessage(chatId, 
      `âœ… ç»‘å®šæˆåŠŸï¼\n\n` +
      `è´¦æˆ·: ${user.email}\n` +
      `ä½™é¢: $${user.balance.toFixed(2)}\n\n` +
      `æ‚¨å°†æ”¶åˆ°è®¢å•ã€å……å€¼ç­‰é‡è¦é€šçŸ¥`
    );
  }
  
  async sendNotification(userId: number, notification: Notification): Promise<void> {
    const user = await this.userRepo.findOne({ where: { id: userId } });
    if (!user?.telegramChatId) return;
    
    const emoji = this.getEmoji(notification.type);
    const message = `${emoji} ${notification.title}\n\n${notification.content}`;
    
    await this.bot.sendMessage(user.telegramChatId, message);
  }
  
  async unbindTelegram(chatId: string): Promise<void> {
    await this.userRepo.update(
      { telegramChatId: chatId },
      {
        telegramChatId: null,
        telegramUsername: null,
        telegramBindAt: null,
      }
    );
  }
  
  private randomCode(): string {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 8; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
      if (i === 3) code += '-';
    }
    return code;
  }
  
  private getEmoji(type: string): string {
    const map = {
      success: 'âœ…',
      info: 'â„¹ï¸',
      warning: 'âš ï¸',
      error: 'âŒ',
    };
    return map[type] || 'â„¹ï¸';
  }
}
```

**æ§åˆ¶å™¨**:
```typescript
@Controller('notifications')
@UseGuards(JwtAuthGuard)
export class NotificationController {
  @Get()
  async getNotifications(@Request() req, @Query() filters: NotificationFiltersDto) {}
  
  @Get('settings')
  async getSettings(@Request() req) {}
  
  @Put('settings')
  async updateSettings(@Request() req, @Body() dto: UpdateSettingsDto) {}
  
  @Patch(':id/read')
  async markAsRead(@Param('id') id: string, @Request() req) {}
  
  @Patch('read-all')
  async markAllAsRead(@Request() req) {}
  
  @Delete(':id')
  async deleteNotification(@Param('id') id: string, @Request() req) {}
  
  @Post('telegram/bind-code')
  async generateBindCode(@Request() req) {}
  
  @Delete('telegram/unbind')
  async unbindTelegram(@Request() req) {}
}
```

---

## ğŸ¨ å‰ç«¯è®¾è®¡

### 1. åŠ¨æ€ä»£ç†ç®¡ç†é¡µé¢

**ç»„ä»¶è·¯å¾„**: `frontend/src/views/proxy/DynamicChannels.vue`

**æ ¸å¿ƒåŠŸèƒ½**:
```vue
<script setup lang="ts">
import { ref, onMounted, computed } from 'vue';
import { ElMessage, ElMessageBox } from 'element-plus';
import * as dynamicApi from '@/api/modules/dynamic';

// çŠ¶æ€ç®¡ç†
const loading = ref(false);
const channels = ref<any[]>([]);
const statistics = ref({ totalChannels: 0, totalTraffic: 0, totalCost: 0 });

// ç­›é€‰
const filters = ref({
  channelName: '',
  status: '',
});

// å¯¹è¯æ¡†
const dialogVisible = ref(false);
const dialogMode = ref<'create' | 'edit'>('create');
const formData = ref({
  channelName: '',
  pricePerGb: 4.5,
  concurrentLimit: 1000,
  status: 'active',
  remark: '',
});

// åŠ è½½æ•°æ®
const loadData = async () => {
  loading.value = true;
  try {
    const [channelsRes, statsRes] = await Promise.all([
      dynamicApi.getChannels(filters.value),
      dynamicApi.getStatistics(),
    ]);
    channels.value = channelsRes.data;
    statistics.value = statsRes;
  } catch (error: any) {
    ElMessage.error('åŠ è½½å¤±è´¥ï¼š' + error.message);
  } finally {
    loading.value = false;
  }
};

// CRUDæ“ä½œ
const handleCreate = () => {
  dialogMode.value = 'create';
  formData.value = { /* é»˜è®¤å€¼ */ };
  dialogVisible.value = true;
};

const handleEdit = (row: any) => {
  dialogMode.value = 'edit';
  formData.value = { ...row };
  dialogVisible.value = true;
};

const handleSave = async () => {
  try {
    if (dialogMode.value === 'create') {
      await dynamicApi.createChannel(formData.value);
      ElMessage.success('åˆ›å»ºæˆåŠŸ');
    } else {
      await dynamicApi.updateChannel(formData.value.id, formData.value);
      ElMessage.success('æ›´æ–°æˆåŠŸ');
    }
    dialogVisible.value = false;
    loadData();
  } catch (error: any) {
    ElMessage.error('æ“ä½œå¤±è´¥ï¼š' + error.message);
  }
};

const handleDelete = async (row: any) => {
  try {
    await ElMessageBox.confirm(`ç¡®è®¤åˆ é™¤é€šé“ "${row.channelName}" å—ï¼Ÿ`, 'ç¡®è®¤æ“ä½œ', {
      confirmButtonText: 'ç¡®è®¤',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning',
    });
    await dynamicApi.deleteChannel(row.id);
    ElMessage.success('åˆ é™¤æˆåŠŸ');
    loadData();
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error('åˆ é™¤å¤±è´¥ï¼š' + error.message);
    }
  }
};

const handleToggle = async (row: any) => {
  try {
    await dynamicApi.toggleChannelStatus(row.id);
    ElMessage.success('çŠ¶æ€å·²æ›´æ–°');
    loadData();
  } catch (error: any) {
    ElMessage.error('æ“ä½œå¤±è´¥ï¼š' + error.message);
  }
};

onMounted(() => {
  loadData();
});
</script>
```

### 2. é€šçŸ¥è®¾ç½®é¡µé¢

**ç»„ä»¶è·¯å¾„**: `frontend/src/views/account/Notifications.vue`

**APIå¯¹æ¥æ”¹é€ **:
```typescript
// æ›¿æ¢ saveEmailSettings
const saveEmailSettings = async () => {
  try {
    saving.value = true;
    await notificationApi.updateSettings({
      emailEnabled: true,
      ...emailSettings.value,
    });
    ElMessage.success('é‚®ä»¶è®¾ç½®ä¿å­˜æˆåŠŸ');
  } catch (error: any) {
    ElMessage.error('ä¿å­˜å¤±è´¥ï¼š' + error.message);
  } finally {
    saving.value = false;
  }
};

// æ›¿æ¢ recentNotifications
const loadNotifications = async () => {
  try {
    const response = await notificationApi.getNotifications({ limit: 10 });
    recentNotifications.value = response.data;
  } catch (error: any) {
    ElMessage.error('åŠ è½½é€šçŸ¥å¤±è´¥ï¼š' + error.message);
  }
};

// æ›¿æ¢ markAllAsRead
const markAllAsRead = async () => {
  try {
    await notificationApi.markAllAsRead();
    recentNotifications.value.forEach((n) => (n.isRead = true));
    ElMessage.success('å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»');
  } catch (error: any) {
    ElMessage.error('æ“ä½œå¤±è´¥ï¼š' + error.message);
  }
};
```

### 3. Telegramç»‘å®šé¡µé¢

**ç»„ä»¶è·¯å¾„**: `frontend/src/views/account/TelegramBind.vue`

**æ–°å»ºé¡µé¢**:
```vue
<template>
  <el-card>
    <template #header>
      <div class="card-header">
        <span>Telegramç»‘å®š</span>
      </div>
    </template>
    
    <div class="bind-content">
      <el-alert
        title="ç»‘å®šTelegramåï¼Œæ‚¨å¯ä»¥æ¥æ”¶é‡è¦é€šçŸ¥"
        type="info"
        :closable="false"
        style="margin-bottom: 20px"
      />
      
      <!-- æœªç»‘å®šçŠ¶æ€ -->
      <div v-if="!isBound" class="bind-steps">
        <el-steps :active="currentStep" finish-status="success" align-center>
          <el-step title="ç”Ÿæˆç»‘å®šç " />
          <el-step title="æ‰“å¼€Telegram Bot" />
          <el-step title="å‘é€ç»‘å®šç " />
          <el-step title="å®Œæˆç»‘å®š" />
        </el-steps>
        
        <div class="bind-code" v-if="bindCode">
          <p>æ‚¨çš„ç»‘å®šç :</p>
          <h2>{{ bindCode }}</h2>
          <el-button @click="copyBindCode">å¤åˆ¶ç»‘å®šç </el-button>
        </div>
        
        <div class="bind-instructions">
          <h3>ç»‘å®šæ­¥éª¤:</h3>
          <ol>
            <li>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆç»‘å®šç </li>
            <li>åœ¨Telegramæœç´¢ <code>@ProxyHubBot</code></li>
            <li>å‘é€ <code>/start</code> å‘½ä»¤</li>
            <li>å‘é€æ‚¨çš„ç»‘å®šç </li>
            <li>ç­‰å¾…ç»‘å®šç¡®è®¤</li>
          </ol>
        </div>
        
        <el-button type="primary" @click="generateBindCode" :loading="loading">
          ç”Ÿæˆç»‘å®šç 
        </el-button>
      </div>
      
      <!-- å·²ç»‘å®šçŠ¶æ€ -->
      <div v-else class="bind-success">
        <el-result icon="success" title="å·²ç»‘å®šTelegram">
          <template #sub-title>
            <p>Telegramç”¨æˆ·å: @{{ telegramUsername }}</p>
            <p>ç»‘å®šæ—¶é—´: {{ bindTime }}</p>
          </template>
          <template #extra>
            <el-button type="danger" @click="handleUnbind">è§£ç»‘Telegram</el-button>
          </template>
        </el-result>
      </div>
    </div>
  </el-card>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { ElMessage, ElMessageBox } from 'element-plus';
import * as notificationApi from '@/api/modules/notification';
import { useUserStore } from '@/stores/user';
import dayjs from 'dayjs';

const userStore = useUserStore();
const loading = ref(false);
const bindCode = ref('');
const currentStep = ref(0);

const isBound = computed(() => !!userStore.user?.telegramUsername);
const telegramUsername = computed(() => userStore.user?.telegramUsername);
const bindTime = computed(() => 
  userStore.user?.telegramBindAt 
    ? dayjs(userStore.user.telegramBindAt).format('YYYY-MM-DD HH:mm') 
    : ''
);

const generateBindCode = async () => {
  loading.value = true;
  try {
    const response = await notificationApi.generateBindCode();
    bindCode.value = response.code;
    currentStep.value = 1;
    ElMessage.success('ç»‘å®šç å·²ç”Ÿæˆï¼Œè¯·æŒ‰æ­¥éª¤æ“ä½œ');
  } catch (error: any) {
    ElMessage.error('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
  } finally {
    loading.value = false;
  }
};

const copyBindCode = () => {
  navigator.clipboard.writeText(bindCode.value);
  ElMessage.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
};

const handleUnbind = async () => {
  try {
    await ElMessageBox.confirm('ç¡®è®¤è§£ç»‘Telegramå—ï¼Ÿ', 'ç¡®è®¤æ“ä½œ', {
      confirmButtonText: 'ç¡®è®¤',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning',
    });
    
    await notificationApi.unbindTelegram();
    await userStore.fetchUserInfo();
    ElMessage.success('è§£ç»‘æˆåŠŸ');
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error('è§£ç»‘å¤±è´¥ï¼š' + error.message);
    }
  }
};

onMounted(() => {
  // å¦‚æœå·²ç»‘å®šï¼Œæ˜¾ç¤ºç»‘å®šä¿¡æ¯
  if (isBound.value) {
    currentStep.value = 4;
  }
});
</script>
```

---

## ğŸ“¡ APIè®¾è®¡

### DTOå®šä¹‰

```typescript
// åŠ¨æ€ä»£ç†DTOs
export class CreateChannelDto {
  @IsString()
  @IsNotEmpty()
  channelName: string;
  
  @IsNumber()
  @Min(0)
  pricePerGb: number;
  
  @IsNumber()
  @Min(1)
  concurrentLimit: number;
  
  @IsEnum(['active', 'paused'])
  status: string;
  
  @IsOptional()
  @IsString()
  remark?: string;
}

export class ChannelFiltersDto {
  @IsOptional()
  @IsString()
  channelName?: string;
  
  @IsOptional()
  @IsEnum(['active', 'paused', 'disabled'])
  status?: string;
  
  @IsOptional()
  @IsNumber()
  page?: number;
  
  @IsOptional()
  @IsNumber()
  limit?: number;
}

// é€šçŸ¥DTOs
export class CreateNotificationDto {
  @IsNumber()
  userId: number;
  
  @IsEnum(['success', 'info', 'warning', 'error'])
  type: string;
  
  @IsEnum(['order', 'recharge', 'expiration', 'balance', 'system', 'proxy'])
  category: string;
  
  @IsString()
  title: string;
  
  @IsString()
  content: string;
}

export class UpdateSettingsDto {
  @IsOptional()
  @IsBoolean()
  emailEnabled?: boolean;
  
  @IsOptional()
  @IsBoolean()
  telegramEnabled?: boolean;
  
  @IsOptional()
  @IsBoolean()
  orderNotification?: boolean;
  
  // ... å…¶ä»–å­—æ®µ
}
```

---

## ğŸ” å®‰å…¨è®¾è®¡

### 1. Telegram Botå®‰å…¨
- âœ… ç»‘å®šç ä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œè¿‡æœŸæ—¶é—´24å°æ—¶
- âœ… Chat IDéªŒè¯ï¼Œé˜²æ­¢å†’ç”¨
- âœ… Webhookç­¾åéªŒè¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### 2. é‚®ä»¶å®‰å…¨
- âœ… é€Ÿç‡é™åˆ¶ï¼ˆæ¯ç”¨æˆ·æ¯å°æ—¶æœ€å¤š10å°ï¼‰
- âœ… é‚®ä»¶æ¨¡æ¿XSSé˜²æŠ¤
- âœ… é‚®ç®±éªŒè¯

### 3. æ•°æ®å®‰å…¨
- âœ… Chat IDåŠ å¯†å­˜å‚¨
- âœ… é€šçŸ¥å†…å®¹æ•æ„Ÿä¿¡æ¯è„±æ•
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸé€šçŸ¥ï¼ˆ30å¤©ï¼‰

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. é‚®ä»¶å‘é€ç›‘æ§
```typescript
@Injectable()
export class EmailMonitorService {
  private successCount = 0;
  private failureCount = 0;
  
  recordSuccess() {
    this.successCount++;
  }
  
  recordFailure(error: Error) {
    this.failureCount++;
    this.logger.error('é‚®ä»¶å‘é€å¤±è´¥', error);
  }
  
  getMetrics() {
    return {
      success: this.successCount,
      failure: this.failureCount,
      successRate: this.successCount / (this.successCount + this.failureCount),
    };
  }
}
```

### 2. Telegram Botç›‘æ§
- âœ… Botåœ¨çº¿çŠ¶æ€æ£€æµ‹
- âœ… æ¶ˆæ¯å‘é€æˆåŠŸç‡
- âœ… ç»‘å®š/è§£ç»‘ç»Ÿè®¡

---

## ğŸš€ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡ç¤ºä¾‹

```env
# é‚®ä»¶é…ç½®
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=proxyhub@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_FROM=ProxyHub <noreply@proxyhub.com>

# Telegramé…ç½®
TELEGRAM_BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
TELEGRAM_BOT_USERNAME=ProxyHubBot
TELEGRAM_WEBHOOK_URL=https://api.proxyhub.com/api/telegram/webhook
```

### Nginxé…ç½®ï¼ˆTelegram Webhookï¼‰

```nginx
location /api/telegram/webhook {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    
    # Telegram IPç™½åå•
    allow 149.154.160.0/20;
    allow 91.108.4.0/22;
    deny all;
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-04  
**è´Ÿè´£äºº**: AI Assistant


