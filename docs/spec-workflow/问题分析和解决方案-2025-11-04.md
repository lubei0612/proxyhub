# ProxyHub 问题分析和解决方案

**日期**：2025-11-04  
**使用框架**：Spec-Workflow

---

## 📋 需求分析 (Requirements)

### 问题1：余额变化验证
**描述**：用户购买$5 IP后，余额从$10050.00变为$10045.00
**疑问**：用户认为"不降反增"
**实际**：余额正确降低了$5
**需要**：验证完整的购买流程和余额变化记录

### 问题2：支付方式显示优化
**当前状态**：
```
微信支付
已停支付，即时到账
```
**期望状态**：一行展示
```
微信支付 - 已停支付，即时到账
```

### 问题3：充值申请未在后台显示
**描述**：用户提交充值申请后，管理后台"待审核：0"
**可能原因**：
1. 充值申请创建失败
2. 充值申请状态不是"pending"
3. 充值申请的userId不匹配
4. 前端/后端筛选条件问题

### 问题4：价格覆盖管理重新设计
**当前方案**：手动添加国家/城市的价格覆盖
```
韩国 - 普通IP - 30天价格: $5
日本 - 原生IP - 30天价格: $8
```

**新需求**：
- 从985proxy IP池动态获取可用的国家/城市
- 显示所有可用IP选项（国家、城市、IP类型）
- 允许选择并设置覆盖价格
- 不需要手动输入国家/城市信息

---

## 🎨 设计方案 (Design)

### 1. 余额变化追踪
**方案**：
- 记录每次购买前后的余额
- 在Transaction表中增加完整的余额变动信息
- 前端显示余额变动历史

### 2. 支付方式显示优化
**前端修改**：
```vue
<!-- 修改前 -->
<div class="payment-title">微信支付</div>
<div class="payment-desc">已停支付，即时到账</div>

<!-- 修改后 -->
<div class="payment-info">微信支付 - 已停支付，即时到账</div>
```

**CSS调整**：
```scss
.payment-info {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
```

### 3. 充值申请调试方案
**检查点**：
1. 检查API请求是否成功返回
2. 检查数据库recharges表中的记录
3. 检查管理员获取列表的筛选条件
4. 验证userId和status字段

### 4. 价格覆盖管理重新设计
**架构变更**：

#### 4.1 数据流
```
985Proxy API → 获取可用国家/城市列表 → 缓存
↓
管理员选择国家/城市/IP类型 → 设置覆盖价格
↓
保存到price_overrides表
```

#### 4.2 新增API端点
```typescript
// 获取985proxy可用的IP池信息
GET /api/v1/price/available-locations
Response: {
  countries: [
    {
      code: 'US',
      name: '美国',
      cities: ['Los Angeles', 'New York', 'Chicago'],
      ipTypes: ['residential', 'native'],
      defaultPrice: { 30: 5, 60: 9, 90: 13 }
    },
    {
      code: 'CA',
      name: '加拿大',
      cities: ['Toronto', 'Vancouver'],
      ipTypes: ['residential'],
      defaultPrice: { 30: 5, 60: 9, 90: 13 }
    }
  ]
}
```

#### 4.3 前端UI重新设计
**新的价格覆盖管理页面**：
```
┌─────────────────────────────────────────────────────┐
│ 价格覆盖管理                        [刷新IP池数据]  │
├─────────────────────────────────────────────────────┤
│                                                      │
│ 筛选：[所有地区 ▼] [所有IP类型 ▼]  [搜索]         │
│                                                      │
│ ┌──────────────────────────────────────────────┐   │
│ │ 国家/地区    城市        IP类型   30天  操作  │   │
│ ├──────────────────────────────────────────────┤   │
│ │ 🇺🇸 美国   Los Angeles  普通IP   $5  [设置]  │   │
│ │ 🇺🇸 美国   New York     普通IP   $5  [设置]  │   │
│ │ 🇨🇦 加拿大  Toronto      普通IP   $5  [设置]  │   │
│ │ 🇯🇵 日本   Tokyo        原生IP   $8  [已覆盖] │   │
│ └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

**设置覆盖价格对话框**：
```
┌────────────────────────────────┐
│ 设置价格覆盖                    │
├────────────────────────────────┤
│ 地区：🇺🇸 美国 - Los Angeles     │
│ IP类型：普通IP                   │
│                                 │
│ 默认价格：                       │
│  30天: $5  60天: $9  90天: $13  │
│                                 │
│ 覆盖价格：                       │
│  30天: [    ] 60天: [    ]      │
│  90天: [    ] 180天: [    ]     │
│                                 │
│      [取消]  [保存覆盖价格]      │
└────────────────────────────────┘
```

---

## 📝 任务列表 (Tasks)

### 优先级1：立即修复
- [ ] 1.1 使用Chrome DevTools测试购买流程和余额变化
- [ ] 1.2 调试充值申请未显示问题
- [ ] 1.3 修复支付方式显示为一行

### 优先级2：功能重构
- [ ] 2.1 后端：创建获取985proxy IP池的API
- [ ] 2.2 后端：修改价格覆盖API支持location-based查询
- [ ] 2.3 前端：重新设计价格覆盖管理UI
- [ ] 2.4 前端：实现IP池选择和价格设置功能

---

## 🔨 实施计划 (Implementation)

### 阶段1：问题调试（立即执行）
1. Chrome DevTools测试余额变化
2. 检查充值申请API和数据库
3. 修复支付方式显示

### 阶段2：价格覆盖重构（后续）
1. 分析985proxy API文档
2. 设计新的数据结构
3. 实现后端API
4. 重构前端UI
5. 测试完整流程

---

## 📊 测试计划

### 测试1：购买流程验证
- [x] 登录admin账户
- [ ] 查看当前余额
- [ ] 购买1个IP
- [ ] 验证余额变化
- [ ] 检查交易记录

### 测试2：充值申请验证
- [ ] 提交充值申请
- [ ] 检查API响应
- [ ] 查询数据库记录
- [ ] 验证后台显示

### 测试3：价格覆盖管理测试
- [ ] 访问价格覆盖管理页面
- [ ] 验证当前功能
- [ ] 确认重构需求

---

## 🎯 预期结果

1. **余额变化**：清晰展示购买前后余额变化
2. **支付方式**：一行展示，不换行
3. **充值审核**：提交后立即在后台显示
4. **价格覆盖**：从IP池选择，简化操作流程

