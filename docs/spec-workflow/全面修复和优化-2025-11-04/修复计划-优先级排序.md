# ProxyHub 修复计划 - 优先级排序

**创建时间**: 2025-11-04  
**预计总工作量**: 15-20小时

---

## 🎯 修复策略

### 原则
1. **先修P0**：关键bug影响核心功能
2. **批量修P1**：筛选功能可以统一处理
3. **评估P2**：体验优化等用户确认后再做

---

## 📊 任务分解

### P0 - 关键Bug（预计4-5小时）

#### Task 1: 修复订单管理路由问题
**时间**: 30分钟  
**文件**: 
- `frontend/src/router/index.ts`
- `frontend/src/views/order/Index.vue`
- `frontend/src/views/billing/Orders.vue`

**步骤**:
1. 检查路由配置
2. 确保`/orders`指向正确组件
3. 修复导航守卫问题

---

#### Task 2: 修复续费功能Bug
**时间**: 1.5小时  
**文件**:
- `backend/src/modules/proxy/static/static-proxy.service.ts`
- `frontend/src/views/proxy/StaticManage.vue`

**问题**:
1. 时间只增加2秒 → 修复时间计算（应该+30天）
2. 所有IP时间都增加 → 只更新当前IP
3. 续费金额NaN → 修复价格计算

**修复**:
```typescript
// 后端修复
const newExpiresAt = new Date(proxy.expiresAt);
newExpiresAt.setDate(newExpiresAt.getDate() + duration);  // duration=30

// 前端修复
const price = await calculatePrice(...);  // 使用API
```

---

#### Task 3: 修复充值订单不显示
**时间**: 30分钟  
**文件**:
- `backend/src/modules/admin/admin.service.ts`
- `frontend/src/views/admin/Recharges.vue`

**检查**:
1. API返回数据是否包含最新充值
2. 前端筛选条件是否过滤掉了数据
3. 刷新机制是否正常

---

#### Task 4: 对接管理后台仪表盘真实数据
**时间**: 2小时  
**文件**:
- `backend/src/modules/admin/admin.controller.ts` (新增端点)
- `backend/src/modules/admin/admin.service.ts`
- `frontend/src/views/admin/Dashboard.vue`

**新增API**:
- `GET /admin/pending-items` - 待处理事项
- `GET /admin/recent-orders` - 最近订单

**数据**:
```typescript
{
  pendingRecharges: 5,  // 实际待审核数量
  abnormalOrders: 2,    // 异常订单数量
  systemNotifications: 3,  // 系统消息数量
  recentOrders: [...]  // 最近10条订单
}
```

---

### P1 - 筛选功能（预计3-4小时）

#### Task 5: 统一实现筛选功能
**时间**: 3-4小时  
**策略**: 创建通用筛选Mixin/Composable

**受影响页面**:
1. 用户管理（搜索、角色、状态）
2. 充值审核（支付方式、邮箱）
3. 订单管理（所有筛选）
4. 交易明细（时间、类型）
5. 事件日志（类型、时间）

**通用方案**:
```typescript
// composables/useTableFilters.ts
export function useTableFilters(loadDataFn) {
  const filters = reactive({});
  const loading = ref(false);
  
  const applyFilters = async () => {
    loading.value = true;
    await loadDataFn(filters);
    loading.value = false;
  };
  
  const resetFilters = () => {
    Object.keys(filters).forEach(key => {
      filters[key] = '';
    });
    applyFilters();
  };
  
  return { filters, loading, applyFilters, resetFilters };
}
```

---

#### Task 6: 添加用户管理功能
**时间**: 1.5小时  

##### 6.1 取消管理员权限
**后端**: 
```typescript
// admin.service.ts
async updateUserRole(userId, role) {
  // 允许设置为: 'user', 'admin'
  // 从admin → user 即为取消管理员
}
```

**前端**:
```vue
<el-button 
  v-if="row.role === 'admin'"
  @click="handleCancelAdmin(row)"
>
  取消管理员
</el-button>
```

##### 6.2 赠送余额功能
**后端**: 新增API
```typescript
// admin.controller.ts
@Post('users/:id/gift-balance')
async giftBalance(
  @Param('id') userId: number,
  @Body() dto: GiftBalanceDto
) {
  return this.adminService.giftBalance(userId, dto);
}
```

**前端**: 弹出对话框
```vue
<el-dialog title="赠送余额">
  <el-form-item label="赠送金额">
    <el-input-number v-model="giftAmount" :min="0" />
  </el-form-item>
  <el-form-item label="赠送原因">
    <el-input type="textarea" v-model="giftReason" />
  </el-form-item>
</el-dialog>
```

---

#### Task 7: 时间显示修复（UTC → 北京时间）
**时间**: 30分钟  

**工具函数**:
```typescript
// utils/time.ts
export function toBeijingTime(utcTime: string): string {
  const date = new Date(utcTime);
  const beijingTime = new Date(date.getTime() + 8 * 60 * 60 * 1000);
  return beijingTime.toLocaleString('zh-CN');
}
```

**应用到所有时间显示**:
- 交易明细
- 订单列表
- 用户注册时间
- 等等...

---

#### Task 8: IP释放验证
**时间**: 1小时  

**验证点**:
1. 释放IP后，数据库记录是否删除
2. 释放的IP是否可以再次购买
3. 到期IP是否自动失效（定时任务）

**实现到期检查**:
```typescript
// static-proxy.service.ts
@Cron(CronExpression.EVERY_HOUR)
async checkExpiredProxies() {
  const expired = await this.proxyRepo.find({
    where: {
      expiresAt: LessThan(new Date()),
      status: 'active'
    }
  });
  
  for (const proxy of expired) {
    proxy.status = 'expired';
    await this.proxyRepo.save(proxy);
    // 可选：发送到期通知
  }
}
```

---

### P2 - 体验优化（待确认）

#### Task 9: 用户仪表盘图表数据
**时间**: 2小时  
**状态**: 等待用户确认优先级

#### Task 10: 中英文切换
**时间**: 4-6小时  
**状态**: 等待用户确认优先级

#### Task 11: 手机端适配
**时间**: 根据方案而定
- 方案A（完整）: 10-15小时
- 方案B（基础）: 3-5小时
- 方案C（关键页面）: 6-8小时
**状态**: 等待用户选择方案

---

## 📅 建议执行顺序

### Day 1: P0修复（4-5小时）
1. ✅ 修复订单管理路由（30min）
2. ✅ 修复续费功能（1.5h）
3. ✅ 修复充值订单显示（30min）
4. ✅ 对接仪表盘真实数据（2h）

### Day 2: P1功能完善（4-5小时）
1. ✅ 统一实现筛选功能（3-4h）
2. ✅ 添加用户管理功能（1.5h）

### Day 3: P1修复和验证（2-3小时）
1. ✅ 时间显示修复（30min）
2. ✅ IP释放验证（1h）
3. ✅ 完整测试所有功能（1-1.5h）

### Day 4+: P2优化（待确认）
根据用户选择决定

---

## ✅ 验收清单

### P0验收
- [ ] 订单管理路由正常，可跳转其他页面
- [ ] 续费30天增加30天，只影响单个IP，金额正确显示
- [ ] 充值订单提交后立即出现在审核列表
- [ ] 仪表盘待处理事项和最近订单显示真实数据

### P1验收
- [ ] 用户管理所有筛选生效
- [ ] 充值审核所有筛选生效
- [ ] 订单管理所有筛选生效
- [ ] 交易明细所有筛选生效
- [ ] 事件日志所有筛选生效
- [ ] 可以设置/取消管理员
- [ ] 可以赠送余额
- [ ] 所有时间显示为北京时间
- [ ] IP释放后可以再次购买

---

## 💬 立即开始？

我已经准备好修复计划，现在可以：

**选项A**: 立即开始修复P0任务（关键bug）
**选项B**: 先确认手机端UI方案（3个方案选1）
**选项C**: 调整任务优先级

**您希望我现在做什么？**


