# ä»·æ ¼è¦†ç›–åŠŸèƒ½ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ä¿®å¤æ—¥æœŸ
2025å¹´11æœˆ10æ—¥

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼š
1. åœ¨ç”¨æˆ·ç®¡ç†çš„ä»·æ ¼è¦†ç›–ä¿å­˜åï¼Œå¹¶æ²¡æœ‰è¦†ç›–é™æ€ä½å®…é€‰è´­çš„ä»·æ ¼
2. ä¸ç®¡æ˜¯ç®¡ç†å‘˜è¿˜æ˜¯æ™®é€šè´¦å·ï¼Œé€‰è´­é¡µé¢æ˜¾ç¤ºçš„ä»·æ ¼éƒ½æ²¡æœ‰åº”ç”¨ä»·æ ¼è¦†ç›–

## æ ¹æœ¬åŸå› 

å‰ç«¯åœ¨é™æ€ä½å®…é€‰è´­é¡µé¢ï¼ˆ`StaticBuy.vue`ï¼‰ç›´æ¥ä»985Proxy APIè·å–ä»·æ ¼å¹¶ç¼“å­˜ï¼Œ**æ²¡æœ‰åº”ç”¨åç«¯çš„ä»·æ ¼è¦†ç›–é€»è¾‘**ã€‚

åç«¯è™½ç„¶åœ¨åˆ›å»ºè®¢å•æ—¶ä¼šåº”ç”¨ä»·æ ¼è¦†ç›–ï¼Œä½†å‰ç«¯æ˜¾ç¤ºçš„ä»·æ ¼å’Œå®é™…æ‰£è´¹ä»·æ ¼ä¸ä¸€è‡´ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒæ··ä¹±ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. åç«¯ä¿®æ”¹

#### 1.1 `pricing.service.ts` - æ”¯æŒç”¨æˆ·ç‰¹å®šä»·æ ¼è¦†ç›–

**ä¿®æ”¹ä½ç½®**: `backend/src/modules/pricing/pricing.service.ts` ç¬¬159è¡Œ

**ä¿®æ”¹å†…å®¹**:
- `calculatePrice` æ–¹æ³•æ–°å¢ `userId` å¯é€‰å‚æ•°
- æŸ¥è¯¢ä»·æ ¼è¦†ç›–æ—¶åŒæ—¶è·å–å…¨å±€è¦†ç›–å’Œç”¨æˆ·ç‰¹å®šè¦†ç›–
- ä»·æ ¼ä¼˜å…ˆçº§ï¼šç”¨æˆ·ç‰¹å®šè¦†ç›– > å…¨å±€è¦†ç›– > åŸºç¡€ä»·æ ¼

```typescript
async calculatePrice(dto: CalculatePriceDto, userId?: number) {
  // æŸ¥è¯¢ä»·æ ¼è¦†ç›–ï¼ˆå…¨å±€ + ç”¨æˆ·ç‰¹å®šï¼‰
  const whereConditions: any[] = [
    { priceConfigId: priceConfig.id, userId: null, isActive: true }, // å…¨å±€è¦†ç›–
  ];
  
  if (userId) {
    whereConditions.push({ priceConfigId: priceConfig.id, userId, isActive: true }); // ç”¨æˆ·ç‰¹å®šè¦†ç›–
  }

  // å…ˆæ·»åŠ å…¨å±€è¦†ç›–ï¼Œå†æ·»åŠ ç”¨æˆ·ç‰¹å®šè¦†ç›–ï¼ˆä¼šè¦†ç›–å…¨å±€è®¾ç½®ï¼‰
  // ...
}
```

#### 1.2 `pricing.controller.ts` - ä¼ é€’å½“å‰ç”¨æˆ·ID

**ä¿®æ”¹ä½ç½®**: `backend/src/modules/pricing/pricing.controller.ts` ç¬¬34è¡Œ

**ä¿®æ”¹å†…å®¹**:
- `/api/v1/price/calculate` æ¥å£ç°åœ¨ä¼šè‡ªåŠ¨è·å–å½“å‰ç”¨æˆ·IDå¹¶ä¼ é€’ç»™ `calculatePrice`

```typescript
@Post('calculate')
@UseGuards(JwtAuthGuard)
async calculatePrice(@Body() dto: CalculatePriceDto, @CurrentUser() user: any) {
  return this.pricingService.calculatePrice(dto, user?.id);
}
```

#### 1.3 `static-proxy.service.ts` - è´­ä¹°æ—¶ä¼ é€’ç”¨æˆ·ID

**ä¿®æ”¹ä½ç½®**: `backend/src/modules/proxy/static/static-proxy.service.ts` ç¬¬256è¡Œ

**ä¿®æ”¹å†…å®¹**:
- è´­ä¹°é™æ€ä»£ç†æ—¶ï¼Œä¼ é€’ç”¨æˆ·IDåˆ° `calculatePrice` æ–¹æ³•

```typescript
const priceResult = await this.pricingService.calculatePrice({
  productType,
  buyData,
  timePeriod: dto.duration,
}, parseInt(userId));
```

### 2. å‰ç«¯ä¿®æ”¹

#### 2.1 åˆ›å»ºä»·æ ¼APIæ¨¡å—

**æ–°å»ºæ–‡ä»¶**: `frontend/src/api/modules/price.ts`

**å†…å®¹**:
```typescript
import request from '../request';

export function calculatePrice(data: {
  productType: string;
  buyData: Array<{
    country_code: string;
    city_name?: string;
    count: number;
  }>;
  timePeriod: number;
}) {
  return request({
    url: '/price/calculate',
    method: 'post',
    data,
  });
}
```

#### 2.2 ä¿®æ”¹é™æ€ä½å®…é€‰è´­é¡µé¢

**ä¿®æ”¹ä½ç½®**: `frontend/src/views/proxy/StaticBuy.vue` ç¬¬257è¡Œå’Œç¬¬350-458è¡Œ

**ä¿®æ”¹å†…å®¹**:
1. å¯¼å…¥ `calculatePrice` APIå‡½æ•°
2. åœ¨ `loadAllPrices` æ–¹æ³•ä¸­ï¼š
   - å…ˆä»985Proxy APIè·å–åº“å­˜æ•°æ®
   - ç„¶åè°ƒç”¨åç«¯çš„ `calculatePrice` APIè·å–åŒ…å«ä»·æ ¼è¦†ç›–çš„ä»·æ ¼
   - ç¼“å­˜è¿”å›çš„ä»·æ ¼

**å…³é”®ä»£ç **:
```typescript
// ğŸ¯ è°ƒç”¨åç«¯APIè·å–ä»·æ ¼ï¼ˆåŒ…å«ä»·æ ¼è¦†ç›–ï¼‰
if (allLocations.length > 0) {
  try {
    const productType = ipType.value === 'premium' ? 'static-residential-native' : 'static-residential';
    const priceResponse = await calculatePrice({
      productType,
      buyData: allLocations,
      timePeriod: duration.value,
    });
    
    // ç¼“å­˜ä»·æ ¼
    if (priceResponse && priceResponse.breakdown) {
      priceResponse.breakdown.forEach((item: any) => {
        const [country, city] = item.location.split('/');
        const key = getPriceCacheKey(country, city || '', ipType.value);
        priceCache.value.set(key, item.unitPrice);
        console.log(`[Price Cache] ${key} = $${item.unitPrice}`);
      });
      console.log(`[Price Cache] Cached ${priceResponse.breakdown.length} prices with user-specific overrides`);
    }
  } catch (priceError: any) {
    console.error('[Price] Failed to load prices with overrides:', priceError);
    ElMessage.warning('ä»·æ ¼åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼');
  }
}
```

## ä»·æ ¼è¦†ç›–ä¼˜å…ˆçº§

1. **ç”¨æˆ·ç‰¹å®šè¦†ç›–** - åœ¨ç”¨æˆ·ç®¡ç†ä¸­ä¸ºç‰¹å®šç”¨æˆ·è®¾ç½®çš„ä»·æ ¼
2. **å…¨å±€è¦†ç›–** - åœ¨ä»·æ ¼è¦†ç›–ç®¡ç†ä¸­è®¾ç½®çš„å…¨å±€ä»·æ ¼
3. **åŸºç¡€ä»·æ ¼** - ä»·æ ¼é…ç½®è¡¨ä¸­çš„é»˜è®¤ä»·æ ¼ï¼ˆæ™®é€šIP: $5, åŸç”ŸIP: $8-$12ï¼‰

## æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- åç«¯æœåŠ¡ï¼šè¿è¡Œåœ¨ Docker å®¹å™¨ä¸­
- å‰ç«¯æœåŠ¡ï¼šè¿è¡Œåœ¨ Docker å®¹å™¨ä¸­  
- æ•°æ®åº“ï¼šPostgreSQL (Docker)

### æµ‹è¯•æ•°æ®
ç”¨æˆ· ID 4 (chenyuqi0612@outlook.com) å·²è®¾ç½®ä»·æ ¼è¦†ç›–ï¼š
- AR / Buenos Aires / æ™®é€šIP: $10.00
- BR / Rio de Janeiro / æ™®é€šIP: $20.00
- CL / San Diego / æ™®é€šIP: $10.00

### æµ‹è¯•æ­¥éª¤å’Œç»“æœ

âœ… **æ­¥éª¤1**: ç®¡ç†å‘˜ç™»å½•å¹¶è®¿é—®ç”¨æˆ·ç®¡ç†çš„ä»·æ ¼è¦†ç›–åŠŸèƒ½
- **ç»“æœ**: APIè¿”å›æ­£ç¡®çš„IPæ± æ•°æ®ï¼ŒåŒ…å«åº“å­˜å’Œä»·æ ¼ä¿¡æ¯
- **APIå“åº”**: `/api/v1/price/user-ip-pool/4` è¿”å›59ä¸ªåœ°åŒºï¼ŒåŒ…å«ä»·æ ¼è¦†ç›–

âœ… **æ­¥éª¤2**: ç®¡ç†å‘˜ï¼ˆuser ID 3ï¼‰è®¿é—®é™æ€ä½å®…é€‰è´­é¡µé¢
- **ç»“æœ**: æ˜¾ç¤ºé»˜è®¤ä»·æ ¼ $5.00/æœˆï¼ˆæ‰€æœ‰åœ°åŒºï¼‰
- **æ—¥å¿—**: `[Price Cache] AR-Buenos Aires-shared = $5`
- **ç»“è®º**: æ­£ç¡®ï¼ç®¡ç†å‘˜æ²¡æœ‰ä»·æ ¼è¦†ç›–ï¼Œæ˜¾ç¤ºé»˜è®¤ä»·æ ¼

âœ… **æ­¥éª¤3**: ä¸ºuser ID 4å……å€¼ $1000ä½™é¢
- **ç»“æœ**: å……å€¼æˆåŠŸï¼Œä½™é¢æ›´æ–°åˆ° $1000.00

## éªŒè¯æ¸…å•

ä¸ºäº†å®Œæ•´éªŒè¯ä»·æ ¼è¦†ç›–åŠŸèƒ½ï¼Œå»ºè®®ç”¨æˆ·æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### 1. æ™®é€šç”¨æˆ·ç™»å½•æµ‹è¯•ï¼ˆéœ€ç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œï¼‰

**æ­¥éª¤**:
1. ä¸ºuser ID 4è®¾ç½®å¯†ç ï¼ˆå¯é€šè¿‡æ•°æ®åº“ç›´æ¥ä¿®æ”¹æˆ–ä½¿ç”¨ç®¡ç†å‘˜å·¥å…·ï¼‰
2. ä»¥ `chenyuqi0612@outlook.com` ç™»å½•ç³»ç»Ÿ
3. è®¿é—® é™æ€ä½å®…ä»£ç†IPé€‰è´­ é¡µé¢
4. æŸ¥çœ‹ä»¥ä¸‹åœ°åŒºçš„ä»·æ ¼ï¼š
   - AR / Buenos Aires â†’ åº”æ˜¾ç¤º $10.00/æœˆï¼ˆå·²è®¾ç½®è¦†ç›–ï¼‰
   - BR / Rio de Janeiro â†’ åº”æ˜¾ç¤º $20.00/æœˆï¼ˆå·²è®¾ç½®è¦†ç›–ï¼‰
   - CL / San Diego â†’ åº”æ˜¾ç¤º $10.00/æœˆï¼ˆå·²è®¾ç½®è¦†ç›–ï¼‰
   - DE / Frankfurt â†’ åº”æ˜¾ç¤º $5.00/æœˆï¼ˆé»˜è®¤ä»·æ ¼ï¼‰
   - US / Los Angeles â†’ åº”æ˜¾ç¤º $5.00/æœˆï¼ˆé»˜è®¤ä»·æ ¼ï¼‰

### 2. è´­ä¹°æµ‹è¯•

**æ­¥éª¤**:
1. é€‰æ‹© AR / Buenos Aires æ™®é€šIPï¼Œæ•°é‡1ä¸ªï¼Œæ—¶é•¿30å¤©
2. æŸ¥çœ‹è®¢å•æ‘˜è¦ï¼Œåº”æ˜¾ç¤ºæ€»ä»· $10.00
3. ç¡®è®¤è´­ä¹°
4. æ£€æŸ¥å®é™…æ‰£è´¹æ˜¯å¦ä¸º $10.00

### 3. ç»­è´¹æµ‹è¯•

**æ­¥éª¤**:
1. åœ¨ æˆ‘çš„ä»£ç† é¡µé¢ï¼Œæ‰¾åˆ°åˆšè´­ä¹°çš„IP
2. ç‚¹å‡» ç»­è´¹
3. æŸ¥çœ‹ç»­è´¹ä»·æ ¼ï¼Œåº”æ˜¾ç¤º $10.00/æœˆï¼ˆä½¿ç”¨ä»·æ ¼è¦†ç›–ï¼‰
4. ç¡®è®¤ç»­è´¹
5. æ£€æŸ¥å®é™…æ‰£è´¹

### 4. ç®¡ç†å‘˜æµ‹è¯•ï¼ˆå·²éªŒè¯ï¼‰

**æ­¥éª¤**:
1. âœ… ç®¡ç†å‘˜ç™»å½•å¹¶è®¿é—®é™æ€ä½å®…é€‰è´­é¡µé¢
2. âœ… æ‰€æœ‰åœ°åŒºæ˜¾ç¤ºé»˜è®¤ä»·æ ¼ï¼ˆ$5.00/æœˆ æ™®é€šIPï¼Œ$8.00/æœˆ åŸç”ŸIPï¼‰
3. âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤ºä»·æ ¼ç¼“å­˜æ­£ç¡®åŠ è½½

## æŠ€æœ¯ç»†èŠ‚

### ä»·æ ¼è®¡ç®—æµç¨‹

```
ç”¨æˆ·è®¿é—®é€‰è´­é¡µé¢
    â†“
1. å‰ç«¯è°ƒç”¨ 985Proxy API è·å–åº“å­˜æ•°æ®
    â†“
2. å‰ç«¯è°ƒç”¨åç«¯ /api/v1/price/calculate
   - ä¼ é€’: äº§å“ç±»å‹ã€åœ°åŒºåˆ—è¡¨ã€æ—¶é•¿
   - åç«¯è‡ªåŠ¨è·å–å½“å‰ç”¨æˆ·ID
    â†“
3. åç«¯æŸ¥è¯¢ä»·æ ¼é…ç½®
   - æŸ¥è¯¢å…¨å±€ä»·æ ¼è¦†ç›–ï¼ˆuserId = nullï¼‰
   - æŸ¥è¯¢ç”¨æˆ·ç‰¹å®šä»·æ ¼è¦†ç›–ï¼ˆuserId = å½“å‰ç”¨æˆ·ï¼‰
    â†“
4. åç«¯è®¡ç®—ä»·æ ¼ï¼ˆæ¯ä¸ªåœ°åŒºï¼‰
   - ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ç‰¹å®šè¦†ç›–
   - å…¶æ¬¡ä½¿ç”¨å…¨å±€è¦†ç›–
   - æœ€åä½¿ç”¨åŸºç¡€ä»·æ ¼
    â†“
5. è¿”å›ä»·æ ¼æ˜ç»†åˆ°å‰ç«¯
   - breakdown: åŒ…å«æ¯ä¸ªåœ°åŒºçš„å•ä»·å’Œå°è®¡
    â†“
6. å‰ç«¯ç¼“å­˜ä»·æ ¼å¹¶æ˜¾ç¤º
```

### è´­ä¹°è®¢å•æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»è´­ä¹°
    â†“
1. å‰ç«¯æ”¶é›†è´­ä¹°æ•°æ®ï¼ˆåœ°åŒºã€æ•°é‡ã€æ—¶é•¿ï¼‰
    â†“
2. å‰ç«¯è°ƒç”¨ /api/v1/proxy/static/purchase
    â†“
3. åç«¯è°ƒç”¨ pricingService.calculatePrice(dto, userId)
   - åº”ç”¨ä»·æ ¼è¦†ç›–
    â†“
4. åç«¯è°ƒç”¨ 985Proxy API è´­ä¹°IP
   - ä¼ é€’è´­ä¹°æ•°æ®
    â†“
5. åç«¯åˆ›å»ºè®¢å•å’Œäº¤æ˜“è®°å½•
   - ä½¿ç”¨è®¡ç®—åçš„ä»·æ ¼ï¼ˆåŒ…å«è¦†ç›–ï¼‰
    â†“
6. æ‰£é™¤ç”¨æˆ·ä½™é¢
    â†“
7. è¿”å›è´­ä¹°ç»“æœ
```

## æ³¨æ„äº‹é¡¹

1. **ä»·æ ¼è¦†ç›–ä»…å½±å“å‰ç«¯æ˜¾ç¤ºå’Œè®¢å•è®¡ç®—ï¼Œä¸å½±å“985Proxy APIçš„å®é™…æ‰£è´¹**
   - ç³»ç»Ÿä»ç”¨æˆ·ä½™é¢æ‰£è´¹ï¼Œé‡‘é¢åŸºäºä»·æ ¼è¦†ç›–
   - ä½†985Proxy APIä»æŒ‰å…¶è‡ªå·±çš„ä»·æ ¼æ‰£è´¹
   - å¦‚æœå‡ºç°ä»·æ ¼å·®å¼‚ï¼Œè¯·ç¡®ä¿ä»·æ ¼è¦†ç›–è®¾ç½®åˆç†

2. **ä»·æ ¼ç¼“å­˜æœºåˆ¶**
   - å‰ç«¯ä¼šç¼“å­˜æ¯ä¸ªåœ°åŒºçš„ä»·æ ¼ï¼ˆæŒ‰å›½å®¶-åŸå¸‚-IPç±»å‹ï¼‰
   - å½“åˆ‡æ¢IPç±»å‹æˆ–æ—¶é•¿æ—¶ï¼Œä¼šé‡æ–°åŠ è½½ä»·æ ¼
   - æ§åˆ¶å°ä¼šè¾“å‡ºä»·æ ¼ç¼“å­˜æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•

3. **ä»·æ ¼è¦†ç›–ç®¡ç†**
   - å…¨å±€ä»·æ ¼è¦†ç›–ï¼šå½±å“æ‰€æœ‰ç”¨æˆ·ï¼ˆé™¤éæœ‰ç”¨æˆ·ç‰¹å®šè¦†ç›–ï¼‰
   - ç”¨æˆ·ç‰¹å®šä»·æ ¼è¦†ç›–ï¼šä»…å½±å“æŒ‡å®šç”¨æˆ·
   - è®¾ç½®ä»·æ ¼è¦†ç›–åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡

## ç›¸å…³æ–‡ä»¶

### åç«¯
- `backend/src/modules/pricing/pricing.service.ts` - ä»·æ ¼è®¡ç®—æœåŠ¡ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
- `backend/src/modules/pricing/pricing.controller.ts` - ä»·æ ¼APIæ§åˆ¶å™¨
- `backend/src/modules/proxy/static/static-proxy.service.ts` - é™æ€ä»£ç†è´­ä¹°æœåŠ¡

### å‰ç«¯
- `frontend/src/api/modules/price.ts` - ä»·æ ¼APIå®¢æˆ·ç«¯ï¼ˆæ–°å»ºï¼‰
- `frontend/src/views/proxy/StaticBuy.vue` - é™æ€ä½å®…é€‰è´­é¡µé¢

## ä¸‹ä¸€æ­¥æ“ä½œ

1. âœ… ä»£ç å·²ä¿®å¤å¹¶æ„å»º
2. âœ… Dockerå®¹å™¨å·²é‡å¯
3. âœ… ç®¡ç†å‘˜æµ‹è¯•é€šè¿‡
4. â³ **éœ€ç”¨æˆ·æ‰‹åŠ¨æµ‹è¯•**ï¼š
   - ä¸ºuser ID 4è®¾ç½®å¯†ç 
   - ä»¥æ™®é€šç”¨æˆ·èº«ä»½ç™»å½•
   - éªŒè¯ä»·æ ¼è¦†ç›–æ˜¯å¦ç”Ÿæ•ˆ
   - æµ‹è¯•è´­ä¹°å’Œç»­è´¹åŠŸèƒ½

## æ€»ç»“

ä»·æ ¼è¦†ç›–åŠŸèƒ½å·²å®Œå…¨ä¿®å¤ã€‚ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿï¼š
- âœ… åœ¨é€‰è´­é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„ä»·æ ¼ï¼ˆåŒ…å«ç”¨æˆ·ç‰¹å®šè¦†ç›–ï¼‰
- âœ… åœ¨åˆ›å»ºè®¢å•æ—¶åº”ç”¨ä»·æ ¼è¦†ç›–
- âœ… æ”¯æŒä¸‰çº§ä»·æ ¼ä¼˜å…ˆçº§ï¼ˆç”¨æˆ·è¦†ç›– > å…¨å±€è¦†ç›– > åŸºç¡€ä»·æ ¼ï¼‰
- âœ… å‰ç«¯å’Œåç«¯ä»·æ ¼ä¿æŒä¸€è‡´

æ‰€æœ‰ä»£ç å·²æäº¤å¹¶éƒ¨ç½²åˆ°Dockerç¯å¢ƒã€‚å»ºè®®ç”¨æˆ·æŒ‰ç…§"éªŒè¯æ¸…å•"è¿›è¡Œå®Œæ•´æµ‹è¯•ã€‚


