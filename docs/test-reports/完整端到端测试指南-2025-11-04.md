# ProxyHub 完整端到端测试指南

**测试日期**: 2025-11-04  
**测试范围**: 所有已修复功能（16项）  
**测试方法**: 手动测试 + Chrome DevTools验证

---

## 📋 测试前准备

### 1. 确保服务运行
```bash
# 使用批处理文件启动
启动ProxyHub测试服务.bat

# 或手动启动
# 后端: cd backend && npm run start:dev
# 前端: cd frontend && npm run serve
```

### 2. 测试账号
- **管理员**: admin@example.com / admin123
- **普通用户**: user@example.com / user123

### 3. 打开Chrome DevTools
- 按 F12 打开开发者工具
- 切换到 Network 标签查看请求
- 切换到 Console 标签查看日志

---

## 🧪 测试流程（按优先级）

## 第一部分：用户端核心功能测试

### 测试1: 登录与余额显示 ✅
**测试步骤**:
1. 访问 http://localhost:8080
2. 使用管理员账号登录
3. 检查导航栏余额显示

**预期结果**:
- ✅ 登录成功，跳转到仪表盘
- ✅ 导航栏显示余额（如：$10083.00）
- ✅ 余额数值准确

**验证点**:
- 检查 Network 标签中的 `/api/v1/users/me` 请求
- 响应应包含 `balance` 字段

---

### 测试2: IP购买功能 ✅ (P0-4 修复)
**测试步骤**:
1. 导航到"静态住宅选购"
2. 选择美国 New York（价格覆盖：$1/月）
3. 数量：1，时长：30天
4. 点击"立即选购"
5. 确认支付面板余额一致（P0-3 修复）
6. 点击"钱包余额支付"
7. 确认支付

**预期结果**:
- ✅ 支付面板余额 = 导航栏余额
- ✅ 显示价格：$1.00（价格覆盖生效）
- ✅ 扣费金额：$1.00
- ✅ 余额变化：$10083.00 → $10082.00
- ✅ 显示成功消息，包含订单号

**验证点**:
- Network: `/api/v1/proxy/static/purchase` (POST)
- 响应: `{ message: "购买成功", orderNo: "ORD-..." }`
- 新请求: `/api/v1/users/me` (余额更新)

---

### 测试3: 订单管理页面 ✅ (CRITICAL-1 修复)
**测试步骤**:
1. 导航到"账单明细" → "订单管理"
2. 检查是否显示刚才的购买订单

**预期结果**:
- ✅ 页面加载时发起 `/api/v1/orders` 请求
- ✅ 显示最新订单（最上面）
- ✅ 订单信息完整（订单号、金额、时间）
- ✅ 订单按时间倒序排列（P0-8 修复）

**验证点**:
- Network: `/api/v1/orders?page=1&limit=20`
- 响应: `{ data: [...], total: X }`

---

### 测试4: 事件日志记录 ✅ (CRITICAL-2 + P1-2 修复)
**测试步骤**:
1. 导航到"我的账户" → "事件日志"
2. 检查是否有"IP购买"记录

**预期结果**:
- ✅ 页面加载时发起 `/api/v1/event-logs/my` 请求
- ✅ 显示"IP购买"事件
- ✅ 事件内容包含IP、金额等详情
- ✅ 时间准确

**验证点**:
- Network: `/api/v1/event-logs/my?page=1&limit=20`
- 事件类型: "IP购买"

---

### 测试5: IP续费功能 ✅ (P0-1 + CRITICAL-3 修复)
**测试步骤**:
1. 导航到"代理管理" → "静态住宅管理"
2. 找到刚购买的IP
3. 点击"续费"按钮
4. 检查续费对话框价格显示（应为 $1.00，非 $5.00）
5. 选择时长：30天
6. 点击"确认续费"

**预期结果**:
- ✅ 续费对话框显示准确价格：$1.00
- ✅ 余额扣减：$10082.00 → $10081.00
- ✅ 到期时间延长30天
- ✅ 显示"续费成功"消息

**验证点**:
- Network: `/api/v1/proxy/static/:id/renew` (POST)
- 请求体: `{ duration: 30 }`
- 检查事件日志是否新增"IP续费"记录

---

### 测试6: IP释放功能 ✅ (P0-2 修复)
**测试步骤**:
1. 在"静态住宅管理"页面
2. 选择一个IP（不是刚续费的）
3. 点击"释放"按钮
4. 确认释放

**预期结果**:
- ✅ 显示"释放成功"消息
- ✅ IP从列表中消失
- ✅ 余额不变（释放不退款）

**验证点**:
- Network: `/api/v1/proxy/static/:id` (DELETE)
- 检查事件日志是否新增"IP释放"记录

---

### 测试7: 充值申请 ✅ (P1-2 修复)
**测试步骤**:
1. 导航到"账单明细" → "钱包充值"
2. 输入金额：100
3. 选择支付方式：微信支付
4. 提交申请

**预期结果**:
- ✅ 显示"充值申请已提交"
- ✅ 生成订单号
- ✅ 状态显示"待审核"

**验证点**:
- Network: `/api/v1/billing/recharge` (POST)
- 检查事件日志是否新增"充值申请"记录

---

## 第二部分：管理端功能测试

### 测试8: 充值审核 ✅ (P1-2 修复)
**测试步骤**:
1. 导航到"管理后台" → "充值审核"
2. 找到刚提交的充值申请
3. 点击"批准"按钮
4. 确认批准

**预期结果**:
- ✅ 显示"充值已批准"
- ✅ 用户余额增加 $100
- ✅ 状态变为"已批准"

**验证点**:
- Network: `/api/v1/billing/recharge/:id/approve` (PUT)
- 请求体: `{ approved: true }`
- 检查事件日志是否新增"充值审核通过"记录

---

### 测试9: 用户管理 - 角色设置 ✅ (P0-5 修复)
**测试步骤**:
1. 导航到"管理后台" → "用户管理"
2. 找到普通用户（user@example.com）
3. 点击"设为管理员"
4. 确认操作

**预期结果**:
- ✅ 显示"角色更新成功"
- ✅ 用户角色变为"管理员"
- ✅ 列表刷新显示最新角色

**验证点**:
- Network: `/api/v1/admin/users/:id/role` (PUT)
- 请求体: `{ role: "admin" }`
- 检查该用户的事件日志是否新增"角色变更"记录

---

### 测试10: 用户管理 - 禁用用户 ✅ (P0-6 修复)
**测试步骤**:
1. 在"用户管理"页面
2. 点击某用户的"禁用"按钮
3. 确认操作

**预期结果**:
- ✅ 显示"禁用成功"
- ✅ 用户状态变为"禁用"
- ✅ 列表刷新显示最新状态

**验证点**:
- Network: `/api/v1/admin/users/:id/status` (PUT)
- 请求体: `{ status: "disabled" }`
- 检查该用户的事件日志是否新增"账户状态变更"记录

---

### 测试11: 用户管理 - 筛选功能 ✅ (P0-7 修复)
**测试步骤**:
1. 在"用户管理"页面
2. 筛选角色：管理员
3. 点击"搜索"
4. 清除筛选，筛选状态：禁用
5. 点击"搜索"

**预期结果**:
- ✅ 角色筛选：仅显示管理员用户
- ✅ 状态筛选：仅显示禁用用户
- ✅ Network请求包含筛选参数

**验证点**:
- Network: `/api/v1/admin/users?page=1&limit=20&role=admin`
- Network: `/api/v1/admin/users?page=1&limit=20&status=disabled`

---

### 测试12: 价格覆盖管理 ✅ (P1-1 修复)
**测试步骤**:
1. 导航到"价格覆盖管理"
2. 找到 Japan Tokyo（原生IP）
3. 修改价格为 $12.00
4. 找到 USA New York（普通IP）
5. 修改价格为 $2.00
6. 点击"保存修改"

**预期结果**:
- ✅ 显示"保存成功"
- ✅ 刷新页面后价格保持
- ✅ Japan Tokyo 原生IP = $12.00
- ✅ USA New York 普通IP = $2.00
- ✅ 其他地区价格不受影响

**验证点**:
- Network: `/api/v1/price/overrides/batch` (POST)
- 请求体应包含 `ipType` 字段

**再次测试购买**:
- 购买 Japan Tokyo 原生IP，价格应为 $12.00/月
- 购买 USA New York 普通IP，价格应为 $2.00/月

---

### 测试13: 系统设置 ✅ (P1-3 修复)
**测试步骤**:
1. 导航到"系统设置"
2. 修改普通IP价格：6.00
3. 修改原生IP价格：12.00
4. 点击"保存价格配置"
5. 修改最小充值金额：10
6. 修改最大充值金额：50000
7. 点击"保存充值设置"
8. 修改客服1 Telegram
9. 点击"保存客服设置"

**预期结果**:
- ✅ 每个保存都显示成功消息
- ✅ 刷新页面后设置保持

**验证点**:
- Network: `/api/v1/admin/settings/:key` (PUT)
- 多个请求，每个设置项一个

---

## 第三部分：数据一致性验证

### 测试14: 余额一致性 ✅ (P0-3 修复)
**测试步骤**:
1. 记录当前导航栏余额
2. 进入"静态住宅选购"
3. 打开支付面板
4. 对比两处余额显示

**预期结果**:
- ✅ 导航栏余额 = 支付面板余额
- ✅ 数值完全一致

---

### 测试15: 订单数据一致性 ✅ (P0-8 修复)
**测试步骤**:
1. 购买一个IP
2. 立即查看"订单管理"
3. 检查新订单是否在最上面

**预期结果**:
- ✅ 新订单显示在列表顶部
- ✅ 订单按创建时间倒序排列
- ✅ 订单信息完整准确

---

### 测试16: 事件日志完整性 ✅ (P1-2 修复)
**测试步骤**:
1. 执行一系列操作：
   - 购买IP
   - 续费IP
   - 释放IP
   - 充值申请
   - 管理员批准充值
2. 查看事件日志

**预期结果**:
- ✅ 所有操作都有对应日志
- ✅ 日志按时间倒序排列
- ✅ 日志内容详细准确
- ✅ 包含以下事件类型：
  - IP购买
  - IP续费
  - IP释放
  - 充值申请
  - 充值审核通过
  - 角色变更（如有）
  - 账户状态变更（如有）

---

## 🔍 常见问题排查

### 问题1: 页面显示"No Data"或空列表
**可能原因**:
- 数据库没有数据
- API请求失败
- 前端未正确解析响应

**排查步骤**:
1. 打开 Network 标签
2. 查看API请求是否发送
3. 查看响应状态码和内容
4. 查看 Console 是否有错误

### 问题2: 价格显示不正确
**可能原因**:
- 价格覆盖未正确加载
- 前端缓存问题

**排查步骤**:
1. 刷新页面（Ctrl+F5 强制刷新）
2. 检查 `/api/v1/price/calculate` 请求
3. 查看响应中的价格

### 问题3: 事件日志为空
**可能原因**:
- 后端EventLogService未正确记录
- 数据库表为空

**排查步骤**:
1. 检查 `/api/v1/event-logs/my` 请求
2. 查看响应: `{ data: [], total: 0 }`
3. 执行操作后再次检查

---

## ✅ 测试完成标准

每项测试完成后，在对应项前打勾：

**用户端** (7项):
- [ ] 测试1: 登录与余额显示
- [ ] 测试2: IP购买功能
- [ ] 测试3: 订单管理页面
- [ ] 测试4: 事件日志记录
- [ ] 测试5: IP续费功能
- [ ] 测试6: IP释放功能
- [ ] 测试7: 充值申请

**管理端** (6项):
- [ ] 测试8: 充值审核
- [ ] 测试9: 用户管理 - 角色设置
- [ ] 测试10: 用户管理 - 禁用用户
- [ ] 测试11: 用户管理 - 筛选功能
- [ ] 测试12: 价格覆盖管理
- [ ] 测试13: 系统设置

**数据一致性** (3项):
- [ ] 测试14: 余额一致性
- [ ] 测试15: 订单数据一致性
- [ ] 测试16: 事件日志完整性

---

## 📊 测试结果记录

| 测试项 | 状态 | 问题描述 | 截图 |
|--------|------|----------|------|
| 测试1 | ⬜ 通过 / ⬜ 失败 | | |
| 测试2 | ⬜ 通过 / ⬜ 失败 | | |
| ... | | | |

---

**测试人员**: _______________  
**测试完成时间**: _______________  
**总体结果**: ⬜ 全部通过 / ⬜ 部分失败

**备注**:
_______________________________________________
_______________________________________________


