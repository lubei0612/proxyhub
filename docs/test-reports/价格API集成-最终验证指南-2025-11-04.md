# 价格API集成 - 最终验证指南

**日期**: 2025-11-04  
**状态**: 代码实现完成，等待手动验证  
**预计验证时间**: 15分钟  

---

## 📋 验证前准备

### 1. 确保服务运行中

```bash
# 后端服务
cd D:\Users\Desktop\proxyhub\backend
npm run start:dev

# 前端服务（新终端）
cd D:\Users\Desktop\proxyhub\frontend
npm run dev
```

**检查点**:
- [ ] 后端日志显示: `Nest application successfully started`
- [ ] 后端监听: `http://localhost:3000`
- [ ] 前端访问: `http://localhost:8080`

### 2. 验证数据库配置（可选）

运行验证脚本：
```bash
cd D:\Users\Desktop\proxyhub\backend
node scripts/verify-price-config.js
```

**预期输出**:
```
✅ static-residential: $5.00
✅ static-residential-native: $10.00
```

---

## ✅ Todo 1: 后端自动初始化验证

**任务ID**: `price-api-7`  
**状态**: ✅ 已完成（代码实现）  

### 实现内容

**文件**: `backend/src/modules/pricing/pricing.service.ts`

```typescript
@Injectable()
export class PricingService implements OnModuleInit {
  async onModuleInit() {
    await this.ensureDefaultPriceConfigs();
  }

  private async ensureDefaultPriceConfigs() {
    const defaultConfigs = [
      { productType: 'static-residential', basePrice: 5.00 },
      { productType: 'static-residential-native', basePrice: 10.00 },
    ];

    for (const config of defaultConfigs) {
      const existing = await this.priceConfigRepo.findOne({
        where: { productType: config.productType },
      });

      if (!existing) {
        const newConfig = this.priceConfigRepo.create({
          productType: config.productType,
          basePrice: config.basePrice as any,
          isActive: true,
        });
        await this.priceConfigRepo.save(newConfig);
        this.logger.log(`[Init] Created default price config: ${config.productType} = $${config.basePrice}`);
      }
    }
  }
}
```

### 验证方法

**方法1: 查看后端日志**

启动后端时，如果配置缺失，应该看到：
```
[Init] Created default price config: static-residential = $5
[Init] Created default price config: static-residential-native = $10
```

**方法2: 运行验证脚本**
```bash
node scripts/verify-price-config.js
```

**方法3: 直接测试API**
```bash
curl -X POST http://localhost:3000/api/v1/price/calculate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"productType":"static-residential-native","buyData":[{"country_code":"JP","city_name":"Tokyo","count":1}],"timePeriod":30}'
```

**预期**: 返回200/201，包含价格数据，**不再是404错误**

---

## ✅ Todo 2: 原生IP价格显示测试

**任务ID**: `price-api-8`  
**预计时间**: 5分钟  

### 测试步骤

#### Step 1: 打开静态住宅选购页面
```
http://localhost:8080/proxy/static/buy
```

#### Step 2: 确认普通IP价格（基线测试）
- [x] 日本 Tokyo: **$10/月** ✅（价格覆盖生效）
- [x] 美国 New York: **$1/月** ✅（价格覆盖生效）
- [x] 其他地区: **$5/月** ✅（默认价格）

#### Step 3: 切换到原生IP
1. 点击"**原生**"选项
2. 等待2-3秒（价格加载）

#### Step 4: 验证原生IP价格

**全部地区应显示**:

| 洲 | 地区 | 预期价格 | 验证 |
|---|------|----------|------|
| 北美 | 美国 Los Angeles | $10/月 | [ ] |
| 北美 | 美国 New York | $10/月 | [ ] |
| 北美 | 美国 Chicago | $10/月 | [ ] |
| 北美 | 加拿大 Toronto | $10/月 | [ ] |
| 亚洲 | 日本 Tokyo | $10/月* | [ ] |
| 亚洲 | 日本 Osaka | $10/月 | [ ] |
| 亚洲 | 韩国 Seoul | $10/月 | [ ] |
| 亚洲 | 新加坡 Singapore | $10/月 | [ ] |
| 欧洲 | 英国 London | $10/月 | [ ] |
| 欧洲 | 德国 Berlin | $10/月 | [ ] |
| 欧洲 | 法国 Paris | $10/月 | [ ] |
| 南美 | 巴西 São Paulo | $10/月 | [ ] |

*注意: 如果管理员已为日本Tokyo原生IP设置价格覆盖，则显示覆盖价格

#### Step 5: Chrome DevTools验证

**打开DevTools (F12)**

1. **Console标签**:
   ```
   [Price] Loading prices for 26 regions with productType: static-residential-native timePeriod: 30
   [Price] Successfully loaded 26 prices
   ```

2. **Network标签**:
   - 请求: `POST /api/v1/price/calculate`
   - 状态: **201** ✅（不再是404）
   - 响应体包含: `breakdown` 数组

### 验收标准

- [ ] **无404错误**: API调用成功返回201
- [ ] **Console无错误**: 价格成功加载日志
- [ ] **所有地区一致**: 26个地区都显示$10/月（或覆盖价格）
- [ ] **切换流畅**: 普通↔原生切换无明显延迟

---

## ✅ Todo 3: IP类型和时长联动测试

**任务ID**: `price-api-9`  
**预计时间**: 5分钟  

### 测试矩阵

| IP类型 | 时长 | 地区 | 单价 | 总价 | 验证 |
|--------|------|------|------|------|------|
| 普通 | 30天 | 日本Tokyo | $10 | $10 | [ ] |
| 普通 | 60天 | 日本Tokyo | $10 | **$20** | [ ] |
| 普通 | 90天 | 日本Tokyo | $10 | **$30** | [ ] |
| 原生 | 30天 | 美国LA | $10 | $10 | [ ] |
| 原生 | 60天 | 美国LA | $10 | **$20** | [ ] |
| 原生 | 180天 | 美国LA | $10 | **$60** | [ ] |

### 测试步骤

#### Test Case 1: 普通IP时长变化

1. 选择"**普通**"IP
2. 选择"**日本 Tokyo**"，数量设为 **1**
3. 依次选择不同时长，观察价格变化：

```
30天  → $10/月 × 1个月 = $10  ✅
60天  → $10/月 × 2个月 = $20  ✅
90天  → $10/月 × 3个月 = $30  ✅
180天 → $10/月 × 6个月 = $60  ✅
360天 → $10/月 × 12个月 = $120 ✅
```

**DevTools验证**:
- 每次切换时长，Console应显示新的API调用
- Network请求中`timePeriod`参数正确变化

#### Test Case 2: 原生IP时长变化

1. 选择"**原生**"IP
2. 选择"**美国 Los Angeles**"，数量设为 **1**
3. 依次选择不同时长，观察价格变化：

```
30天  → $10/月 × 1个月 = $10  ✅
60天  → $10/月 × 2个月 = $20  ✅
90天  → $10/月 × 3个月 = $30  ✅
```

#### Test Case 3: 快速切换测试

**验证响应性和缓存**:

1. 普通IP → 原生IP → 普通IP（快速连续切换）
2. 30天 → 60天 → 30天（快速连续切换）

**预期**:
- [ ] 价格更新流畅，无明显卡顿
- [ ] 二次加载相同配置时使用缓存（Console日志验证）
- [ ] 无重复API调用（Network验证）

### 验收标准

- [ ] **时长倍数正确**: 60天=2倍，90天=3倍，180天=6倍，360天=12倍
- [ ] **IP类型独立**: 普通和原生价格分别计算
- [ ] **响应式更新**: watch监听生效，自动重新加载价格
- [ ] **缓存机制**: 相同配置二次加载使用缓存

---

## ✅ Todo 4: 完整端到端购买流程验证

**任务ID**: `price-api-10`  
**预计时间**: 5分钟  

### 测试场景

#### Scenario 1: 购买普通IP（价格覆盖）

**初始状态**:
- 用户: admin@example.com
- 余额: $10,045.00（从导航栏查看）

**操作步骤**:

1. **选择IP类型**: 普通
2. **选择地区**: 日本 Tokyo
3. **设置数量**: 1
4. **选择时长**: 30天
5. **验证价格显示**: 
   - 单价: $10/月
   - 小计: $10
   - 总计: $10

6. **提交订单**: 点击"提交订单"
7. **确认对话框**: 点击"确认"

**预期结果**:
- [ ] 订单提交成功提示
- [ ] 导航栏余额更新为: **$10,035.00** (-$10)
- [ ] 页面跳转到"静态住宅管理"或订单详情

**验证点**:

**A. 余额扣除正确**
```
购买前: $10,045.00
购买后: $10,035.00
差额:    -$10.00 ✅
```

**B. 订单记录查询**
```
路径: 账单明细 → 订单记录
验证: 最新订单显示
  - 类型: 静态住宅代理 - 普通
  - 地区: JP/Tokyo
  - 数量: 1
  - 金额: $10.00
  - 状态: 已完成
```

**C. 交易记录查询**
```
路径: 账单明细 → 交易明细
验证: 最新交易显示
  - 类型: 支出
  - 金额: -$10.00
  - 备注: 购买静态住宅代理
  - 余额变化: $10,045.00 → $10,035.00
```

**D. 静态代理列表**
```
路径: 静态住宅 → 静态住宅管理
验证: 新增1条代理记录
  - 国家: 日本
  - 城市: Tokyo
  - IP类型: 普通
  - 状态: 活跃
```

#### Scenario 2: 购买原生IP（默认价格）

**操作步骤**:

1. **选择IP类型**: 原生
2. **选择地区**: 美国 Los Angeles
3. **设置数量**: 2
4. **选择时长**: 60天
5. **验证价格显示**:
   - 单价: $10/月
   - 时长: 2个月
   - 小计: $10 × 2 × 2 = **$40**
   - 总计: **$40**

6. **提交订单**

**预期结果**:
- [ ] 余额扣除: $10,035.00 → **$9,995.00** (-$40)
- [ ] 订单创建: 2个IP，美国LA，原生，60天
- [ ] 交易记录: -$40.00

#### Scenario 3: 余额不足测试

**操作步骤**:

1. 选择高价值组合（总价 > 当前余额）
2. 尝试提交订单

**预期结果**:
- [ ] 提交按钮禁用，或
- [ ] 提示"余额不足，请先充值"

### 完整验收清单

#### 前端验证
- [ ] 价格显示准确（普通和原生）
- [ ] 价格覆盖正确应用
- [ ] 时长倍数计算正确
- [ ] 数量乘法计算正确
- [ ] 总价汇总准确
- [ ] 余额实时更新

#### 后端验证
- [ ] 订单成功创建（orders表）
- [ ] 余额正确扣除（users表）
- [ ] 交易记录完整（transactions表）
- [ ] 代理IP正确生成（static_proxies表）

#### 数据一致性
- [ ] 前端显示金额 = 后端扣除金额
- [ ] 订单详情 = 交易记录
- [ ] 代理列表数量 = 购买数量
- [ ] 所有页面数据同步

---

## 📊 综合测试报告模板

### 测试结果汇总

```
测试日期: 2025-11-04
测试人员: [你的名字]
测试环境: 本地开发环境

===== 普通IP测试 =====
✅ 价格显示: 通过
✅ 价格覆盖: 通过（日本Tokyo $10, 美国NY $1）
✅ 时长联动: 通过
✅ 购买流程: 通过
✅ 余额扣除: 通过

===== 原生IP测试 =====
[ ] 价格显示: ___
[ ] API调用: ___
[ ] 时长联动: ___
[ ] 购买流程: ___
[ ] 余额扣除: ___

===== 端到端测试 =====
[ ] 订单创建: ___
[ ] 交易记录: ___
[ ] 代理IP生成: ___
[ ] 数据一致性: ___

总体评分: ___/10
```

### 问题记录

| 序号 | 问题描述 | 严重程度 | 截图 | 状态 |
|------|----------|----------|------|------|
| 1 | | | | |
| 2 | | | | |

### 改进建议

1. ___
2. ___
3. ___

---

## 🚀 验证完成后操作

### 1. 更新TODO状态

所有测试通过后，更新TODO清单：

```bash
# 所有4个TODO标记为completed
price-api-7: ✅ 重启后端服务验证自动初始化
price-api-8: ✅ 测试原生IP价格显示
price-api-9: ✅ 测试IP类型和时长联动
price-api-10: ✅ 完整端到端购买流程验证
```

### 2. 创建最终验收报告

基于此验证指南，创建最终报告：
- 包含所有测试截图
- 记录所有验证结果
- 确认功能100%完成

### 3. Git提交

```bash
git add .
git commit -m "test: 完成用户端价格API集成所有验证测试"
git push
```

---

## 📝 快速验证清单

**5分钟快速验证版本**:

```bash
# 1. 访问页面
http://localhost:8080/proxy/static/buy

# 2. 普通IP - 日本Tokyo
[ ] 显示 $10/月 ✅

# 3. 切换到原生IP
[ ] 所有地区显示 $10/月

# 4. 切换时长到60天
[ ] 价格翻倍（显示×2个月）

# 5. 购买1个日本Tokyo普通IP（30天）
[ ] 余额减少 $10
[ ] 订单记录出现
[ ] 交易明细更新

完成！ 🎉
```

---

**验证指南创建时间**: 2025-11-04  
**预计总验证时间**: 15-20分钟  
**需要工具**: Chrome浏览器 + DevTools (F12)


