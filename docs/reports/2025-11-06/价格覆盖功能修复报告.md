# ä»·æ ¼è¦†ç›–åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-06  
**é—®é¢˜**: åœ¨ç®¡ç†åå°ä¿®æ”¹ä»·æ ¼è¦†ç›–åï¼Œç”¨æˆ·ç•Œé¢é€‰è´­é¡µé¢æ²¡æœ‰æ˜¾ç¤ºä¿®æ”¹åçš„ä»·æ ¼  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
> åœ¨ç®¡ç†åå°çš„"ä»·æ ¼è¦†ç›–ç®¡ç†"ä¸­ä¿®æ”¹äº†IPä»·æ ¼ï¼Œä½†åœ¨ç”¨æˆ·ç•Œé¢çš„"é™æ€ä½å®…é€‰è´­"é¡µé¢æŸ¥çœ‹æ—¶ï¼Œä»·æ ¼æ²¡æœ‰å˜åŒ–ã€‚

**æµ‹è¯•æ­¥éª¤**:
1. ç®¡ç†åå° â†’ ä»·æ ¼è¦†ç›–ç®¡ç†
2. æ‰¾åˆ°æŸä¸ªIPï¼ˆå¦‚ï¼šæ—¥æœ¬TokyoåŸç”ŸIPï¼‰
3. è®¾ç½®è¦†ç›–ä»·æ ¼ä¸º $10.00
4. ä¿å­˜
5. è®¿é—®ç”¨æˆ·ç•Œé¢ â†’ é™æ€ä½å®…é€‰è´­
6. é€‰æ‹©"åŸç”ŸIP"å’Œ"æ—¥æœ¬Tokyo"
7. **é—®é¢˜**: ä»·æ ¼ä»ç„¶æ˜¾ç¤º $8.00ï¼Œæ²¡æœ‰æ˜¾ç¤ºè¦†ç›–ä»·æ ¼ $10.00

---

## ğŸ” é—®é¢˜æ ¹å› 

### ä»£ç åˆ†æ

**é—®é¢˜ä»£ç **: `backend/src/modules/proxy/static/static-proxy.service.ts` - `getInventory()` æ–¹æ³•

```typescript
// âŒ ä¿®æ”¹å‰ï¼šç¡¬ç¼–ç ä»·æ ¼ï¼Œä¸æŸ¥è¯¢ä»·æ ¼è¦†ç›–
async getInventory(ipType: string, duration: number) {
  const static_proxy_type = (ipType === 'native' || ipType === 'premium') ? 'premium' : 'shared';
  const response = await this.proxy985Service.getInventory({ static_proxy_type });

  // âŒ é—®é¢˜ï¼šç›´æ¥ç¡¬ç¼–ç ä»·æ ¼
  const pricePerMonth = static_proxy_type === 'premium' ? 8 : 5;

  const inventory = {
    countries: (response.data || []).map((item: any) => ({
      countryCode: item.country_code,
      countryName: item.country_code,
      stock: item.number || 0,
      price: pricePerMonth, // âŒ æ‰€æœ‰IPéƒ½ç”¨åŒä¸€ä¸ªä»·æ ¼
      cities: item.city_name ? [{ cityName: item.city_name, stock: item.number || 0 }] : [],
    })),
  };

  return inventory;
}
```

### é—®é¢˜åˆ†æ

1. **æ²¡æœ‰æŸ¥è¯¢ä»·æ ¼è¦†ç›–**: `getInventory` æ–¹æ³•ç›´æ¥ä½¿ç”¨ç¡¬ç¼–ç ä»·æ ¼ï¼ˆpremium: $8, shared: $5ï¼‰
2. **å¿½ç•¥ç®¡ç†å‘˜è®¾ç½®**: å³ä½¿ç®¡ç†å‘˜åœ¨åå°è®¾ç½®äº†ä»·æ ¼è¦†ç›–ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿä¸ä¼šè¯»å–
3. **æ•°æ®æµæ–­è£‚**: ä»·æ ¼è¦†ç›–ä¿å­˜åˆ°æ•°æ®åº“ â†’ ä½†inventory APIä¸è¯»å– â†’ å‰ç«¯æ˜¾ç¤ºé»˜è®¤ä»·æ ¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `getInventory` æ–¹æ³•

**æ–‡ä»¶**: `backend/src/modules/proxy/static/static-proxy.service.ts`

```typescript
// âœ… ä¿®æ”¹åï¼šæŸ¥è¯¢å¹¶åº”ç”¨ä»·æ ¼è¦†ç›–
async getInventory(ipType: string, duration: number) {
  const static_proxy_type = (ipType === 'native' || ipType === 'premium') ? 'premium' : 'shared';
  
  // âœ… å¹¶è¡Œè·å–åº“å­˜å’Œä»·æ ¼è¦†ç›–
  const [response, priceOverrides] = await Promise.all([
    this.proxy985Service.getInventory({ static_proxy_type }),
    this.pricingService.getPriceOverridesForInventory(
      static_proxy_type === 'premium' ? 'static-residential-native' : 'static-residential'
    ),
  ]);

  if (response.code !== 0) {
    throw new BadRequestException(`è·å–åº“å­˜å¤±è´¥: ${response.msg}`);
  }

  // âœ… é»˜è®¤ä»·æ ¼
  const defaultPrice = static_proxy_type === 'premium' ? 8 : 5;

  // âœ… æ„å»ºè¦†ç›–ä»·æ ¼Mapï¼ˆO(1)æŸ¥æ‰¾ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰
  const overrideMap = new Map<string, number>();
  priceOverrides.forEach((override: any) => {
    const key = override.cityName 
      ? `${override.countryCode}:${override.cityName}`
      : override.countryCode;
    overrideMap.set(key, parseFloat(override.overridePrice));
  });

  const inventory = {
    countries: (response.data || []).map((item: any) => {
      // âœ… æŸ¥æ‰¾ä»·æ ¼ï¼ˆåŸå¸‚çº§ > å›½å®¶çº§ > é»˜è®¤ä»·æ ¼ï¼‰
      const cityKey = item.city_name ? `${item.country_code}:${item.city_name}` : null;
      const countryKey = item.country_code;
      
      const price = 
        (cityKey && overrideMap.get(cityKey)) ||
        overrideMap.get(countryKey) ||
        defaultPrice;

      return {
        countryCode: item.country_code,
        countryName: item.country_code,
        stock: item.number || 0,
        price, // âœ… ä½¿ç”¨è¦†ç›–ä»·æ ¼æˆ–é»˜è®¤ä»·æ ¼
        cities: item.city_name ? [{ cityName: item.city_name, stock: item.number || 0 }] : [],
      };
    }),
  };

  const overrideCount = inventory.countries.filter(c => 
    overrideMap.has(c.countryCode) || 
    c.cities.some((city: any) => overrideMap.has(`${c.countryCode}:${city.cityName}`))
  ).length;

  this.logger.log(`[Get Inventory] Found ${inventory.countries.length} locations, ${overrideCount} with price overrides`);
  return inventory;
}
```

### 2. æ–°å¢ `getPriceOverridesForInventory` æ–¹æ³•

**æ–‡ä»¶**: `backend/src/modules/pricing/pricing.service.ts`

```typescript
/**
 * è·å–æŒ‡å®šäº§å“ç±»å‹çš„ä»·æ ¼è¦†ç›–ï¼ˆç”¨äºinventory APIï¼‰
 */
async getPriceOverridesForInventory(productType: string) {
  this.logger.log(`[Get Price Overrides] Product Type: ${productType}`);

  try {
    // æŸ¥æ‰¾ä»·æ ¼é…ç½®
    const priceConfig = await this.priceConfigRepo.findOne({
      where: { productType, isActive: true },
    });

    if (!priceConfig) {
      this.logger.warn(`[Get Price Overrides] No price config found for ${productType}`);
      return [];
    }

    // æŸ¥æ‰¾æ‰€æœ‰è¯¥äº§å“ç±»å‹çš„ä»·æ ¼è¦†ç›–
    const overrides = await this.priceOverrideRepo.find({
      where: { 
        priceConfigId: priceConfig.id,
        isActive: true 
      },
    });

    this.logger.log(`[Get Price Overrides] Found ${overrides.length} overrides for ${productType}`);
    return overrides;
  } catch (error) {
    this.logger.error(`[Get Price Overrides] Failed: ${error.message}`);
    return [];
  }
}
```

---

## ğŸ¯ ä¿®å¤ç‰¹æ€§

### ä»·æ ¼ä¼˜å…ˆçº§

ä¿®å¤åçš„ä»·æ ¼æŸ¥æ‰¾ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. **åŸå¸‚çº§è¦†ç›–ä»·æ ¼**: å¦‚æœè®¾ç½®äº†ç‰¹å®šåŸå¸‚çš„è¦†ç›–ä»·æ ¼ï¼ˆå¦‚ï¼šJP:Tokyoï¼‰
2. **å›½å®¶çº§è¦†ç›–ä»·æ ¼**: å¦‚æœè®¾ç½®äº†æ•´ä¸ªå›½å®¶çš„è¦†ç›–ä»·æ ¼ï¼ˆå¦‚ï¼šJPï¼‰
3. **é»˜è®¤ä»·æ ¼**: å¦‚æœæ²¡æœ‰ä»»ä½•è¦†ç›–ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼ï¼ˆpremium: $8, shared: $5ï¼‰

### æ€§èƒ½ä¼˜åŒ–

- **å¹¶è¡ŒæŸ¥è¯¢**: ä½¿ç”¨ `Promise.all` å¹¶è¡Œè·å–åº“å­˜å’Œä»·æ ¼è¦†ç›–ï¼Œå‡å°‘å“åº”æ—¶é—´
- **Mapç»“æ„**: ä½¿ç”¨ `Map` å­˜å‚¨ä»·æ ¼è¦†ç›–ï¼ŒO(1)æ—¶é—´å¤æ‚åº¦æŸ¥æ‰¾
- **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰ä»·æ ¼è¦†ç›–ï¼Œé¿å…N+1æŸ¥è¯¢é—®é¢˜

### æ—¥å¿—å¢å¼º

```typescript
this.logger.log(`[Get Inventory] Found ${inventory.countries.length} locations, ${overrideCount} with price overrides`);
```

æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
- æ€»å…±å¤šå°‘ä¸ªåœ°åŒº
- å…¶ä¸­æœ‰å¤šå°‘ä¸ªåº”ç”¨äº†ä»·æ ¼è¦†ç›–

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1: è®¾ç½®å›½å®¶çº§è¦†ç›–ä»·æ ¼

**æ­¥éª¤**:
1. ç®¡ç†åå° â†’ ä»·æ ¼è¦†ç›–ç®¡ç†
2. æ‰¾åˆ°"æ—¥æœ¬"æ‰€æœ‰åŸå¸‚çš„åŸç”ŸIP
3. è®¾ç½®è¦†ç›–ä»·æ ¼ä¸º $10.00ï¼ˆå›½å®¶çº§ï¼‰
4. ä¿å­˜

**é¢„æœŸç»“æœ**:
- è®¿é—®é™æ€ä½å®…é€‰è´­é¡µé¢
- é€‰æ‹©"åŸç”ŸIP"
- æ‰€æœ‰æ—¥æœ¬åŸå¸‚ï¼ˆTokyo, Osakaç­‰ï¼‰éƒ½æ˜¾ç¤º $10.00/æœˆ

### æµ‹è¯•åœºæ™¯2: è®¾ç½®åŸå¸‚çº§è¦†ç›–ä»·æ ¼

**æ­¥éª¤**:
1. ç®¡ç†åå° â†’ ä»·æ ¼è¦†ç›–ç®¡ç†
2. æ‰¾åˆ°"æ—¥æœ¬ Tokyo"çš„åŸç”ŸIP
3. è®¾ç½®è¦†ç›–ä»·æ ¼ä¸º $12.00ï¼ˆåŸå¸‚çº§ï¼‰
4. æ‰¾åˆ°"æ—¥æœ¬ Osaka"çš„åŸç”ŸIP
5. è®¾ç½®è¦†ç›–ä»·æ ¼ä¸º $9.00ï¼ˆåŸå¸‚çº§ï¼‰
6. ä¿å­˜

**é¢„æœŸç»“æœ**:
- è®¿é—®é™æ€ä½å®…é€‰è´­é¡µé¢
- é€‰æ‹©"åŸç”ŸIP"
- Tokyoæ˜¾ç¤º $12.00/æœˆ
- Osakaæ˜¾ç¤º $9.00/æœˆ
- å…¶ä»–æ—¥æœ¬åŸå¸‚ï¼ˆå¦‚Kyotoï¼‰æ˜¾ç¤ºé»˜è®¤ä»·æ ¼ $8.00/æœˆ

### æµ‹è¯•åœºæ™¯3: æ··åˆè¦†ç›–ï¼ˆå›½å®¶çº§ + åŸå¸‚çº§ï¼‰

**æ­¥éª¤**:
1. è®¾ç½®"æ—¥æœ¬"ï¼ˆå›½å®¶çº§ï¼‰è¦†ç›–ä»·æ ¼ä¸º $10.00
2. è®¾ç½®"æ—¥æœ¬ Tokyo"ï¼ˆåŸå¸‚çº§ï¼‰è¦†ç›–ä»·æ ¼ä¸º $12.00
3. ä¿å­˜

**é¢„æœŸç»“æœ**:
- Tokyo: $12.00ï¼ˆåŸå¸‚çº§ä¼˜å…ˆï¼‰
- Osaka: $10.00ï¼ˆä½¿ç”¨å›½å®¶çº§ï¼‰
- å…¶ä»–æœªè®¾ç½®çš„æ—¥æœ¬åŸå¸‚: $10.00ï¼ˆä½¿ç”¨å›½å®¶çº§ï¼‰

### æµ‹è¯•åœºæ™¯4: é‡ç½®è¦†ç›–ä»·æ ¼

**æ­¥éª¤**:
1. ç®¡ç†åå° â†’ ä»·æ ¼è¦†ç›–ç®¡ç†
2. æ‰¾åˆ°"æ—¥æœ¬ Tokyo"çš„åŸç”ŸIPï¼ˆä¹‹å‰è®¾ç½®ä¸º$12ï¼‰
3. ç‚¹å‡»"é‡ç½®"æŒ‰é’®
4. ç¡®è®¤

**é¢„æœŸç»“æœ**:
- Tokyoæ¢å¤é»˜è®¤ä»·æ ¼ $8.00/æœˆ

---

## ğŸ“Š æ•°æ®æµå›¾

### ä¿®æ”¹å‰ï¼ˆæœ‰é—®é¢˜ï¼‰

```
ç®¡ç†å‘˜è®¾ç½®ä»·æ ¼è¦†ç›–
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ âœ…
    â†“
ã€æ–­è£‚ã€‘âŒ getInventory ä¸è¯»å–ä»·æ ¼è¦†ç›–
    â†“
è¿”å›ç¡¬ç¼–ç ä»·æ ¼
    â†“
å‰ç«¯æ˜¾ç¤ºé»˜è®¤ä»·æ ¼ï¼ˆé”™è¯¯ï¼‰
```

### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰

```
ç®¡ç†å‘˜è®¾ç½®ä»·æ ¼è¦†ç›–
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ âœ…
    â†“
getInventory æŸ¥è¯¢ä»·æ ¼è¦†ç›– âœ…
    â†“
åº”ç”¨è¦†ç›–ä»·æ ¼ï¼ˆåŸå¸‚çº§ > å›½å®¶çº§ > é»˜è®¤ï¼‰ âœ…
    â†“
è¿”å›æ­£ç¡®ä»·æ ¼
    â†“
å‰ç«¯æ˜¾ç¤ºè¦†ç›–ä»·æ ¼ï¼ˆæ­£ç¡®ï¼‰âœ…
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **ç¼–è¯‘ä»£ç **
   ```bash
   cd backend
   npm run build
   ```

2. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   npm run start:dev
   ```

3. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - æŒ‰ `Ctrl+Shift+R` å¼ºåˆ¶åˆ·æ–°å‰ç«¯é¡µé¢

4. **éªŒè¯ä¿®å¤**
   - æŒ‰ç…§æµ‹è¯•åœºæ™¯è¿›è¡ŒéªŒè¯

---

## ğŸ“ Gitæäº¤

```bash
commit c40de6c
Author: AI Assistant
Date: 2025-11-06 16:30

fix: apply price overrides in inventory API

- Modified getInventory() to query and apply price overrides
- Added getPriceOverridesForInventory() method to PricingService
- Price lookup priority: city-level > country-level > default
- Performance: parallel queries with Promise.all
- Performance: Map-based O(1) price lookup
```

---

## âœ… ä¿®å¤æ€»ç»“

| é¡¹ç›® | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| ä»·æ ¼æ¥æº | ç¡¬ç¼–ç  | æ•°æ®åº“ï¼ˆè¦†ç›–ä»·æ ¼ï¼‰ âœ… |
| ä»·æ ¼ä¼˜å…ˆçº§ | æ—  | åŸå¸‚çº§ > å›½å®¶çº§ > é»˜è®¤ âœ… |
| ç®¡ç†å‘˜è®¾ç½® | ä¸ç”Ÿæ•ˆ | å®æ—¶ç”Ÿæ•ˆ âœ… |
| æ€§èƒ½ | N/A | å¹¶è¡ŒæŸ¥è¯¢ + MapæŸ¥æ‰¾ âœ… |
| æ—¥å¿— | åŸºç¡€ | è¯¦ç»†ï¼ˆåŒ…å«è¦†ç›–æ•°é‡ï¼‰âœ… |

---

## ğŸ‰ ç°åœ¨å¯ä»¥æµ‹è¯•äº†

### å¿«é€ŸéªŒè¯æ­¥éª¤

1. **è®¿é—®ç®¡ç†åå°**
   ```
   http://localhost:8080/admin/price-overrides
   ```

2. **è®¾ç½®ä¸€ä¸ªè¦†ç›–ä»·æ ¼**
   - æ‰¾åˆ°"æ—¥æœ¬ Tokyo åŸç”ŸIP"
   - è¾“å…¥è¦†ç›–ä»·æ ¼: 10
   - ç‚¹å‡»ä¿å­˜

3. **è®¿é—®ç”¨æˆ·ç•Œé¢**
   ```
   http://localhost:8080/proxy/static/buy
   ```

4. **éªŒè¯ä»·æ ¼**
   - é€‰æ‹©"åŸç”ŸIP"
   - é€‰æ‹©"æ—¥æœ¬ Tokyo"
   - åº”è¯¥æ˜¾ç¤º: **$10.00/æœˆ** âœ…ï¼ˆè¦†ç›–ä»·æ ¼ï¼‰
   - å…¶ä»–æœªè®¾ç½®çš„åŸå¸‚ä»æ˜¾ç¤º: **$8.00/æœˆ**ï¼ˆé»˜è®¤ä»·æ ¼ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-06 16:30  
**æµ‹è¯•çŠ¶æ€**: âœ… ä»£ç å·²ä¿®å¤ï¼Œç­‰å¾…ç”¨æˆ·éªŒè¯  
**ä¸‹ä¸€æ­¥**: æŒ‰ç…§å¿«é€ŸéªŒè¯æ­¥éª¤æµ‹è¯•ä»·æ ¼è¦†ç›–åŠŸèƒ½

