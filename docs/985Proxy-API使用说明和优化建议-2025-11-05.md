# 985Proxy API ä½¿ç”¨è¯´æ˜å’Œä¼˜åŒ–å»ºè®®

## ğŸ“š å½“å‰é›†æˆçŠ¶æ€

### âœ… å·²é›†æˆçš„API

| API | çŠ¶æ€ | ç”¨é€” |
|-----|------|------|
| POST /res_static/buy | âœ… å·²é›†æˆ | è´­ä¹°é™æ€ä»£ç†IP |

### ğŸ”´ æœªé›†æˆä½†å»ºè®®æ·»åŠ çš„API

| API | ä¼˜å…ˆçº§ | ç”¨é€” | ä¼˜åŒ–æ•ˆæœ |
|-----|--------|------|----------|
| GET /res_static/inventory | ğŸŸ¡ ä¸­ | å®æ—¶æŸ¥è¯¢IPåº“å­˜å’Œä»·æ ¼ | æ˜¾ç¤ºçœŸå®åº“å­˜ï¼Œé¿å…ç”¨æˆ·é€‰æ‹©æ— è´§å•†å“ |
| GET /res_static/ip_list | ğŸŸ¡ ä¸­ | æŸ¥è¯¢ç”¨æˆ·åœ¨985Proxyçš„IPåˆ—è¡¨ | æ•°æ®åŒæ­¥ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ |
| POST /res_static/order_result | ğŸŸ¢ é«˜ | è·å–è®¢å•è¯¦ç»†ç»“æœï¼ˆåŒ…å«IPä¿¡æ¯ï¼‰ | **å½“å‰ç¼ºå¤±ï¼è´­ä¹°åéœ€è¦æ­¤APIè·å–IPè¯¦æƒ…** |
| POST /res_static/renew | ğŸŸ¡ ä¸­ | ç»­è´¹IP | å¢åŠ ç»­è´¹åŠŸèƒ½ |
| POST /res_static/calculate | ğŸŸ¢ ä½ | ç²¾ç¡®è®¡ç®—ä»·æ ¼ï¼ˆå«ä¼˜æƒ ï¼‰ | æ›´å‡†ç¡®çš„ä»·æ ¼æ˜¾ç¤º |

---

## âš ï¸ é‡è¦å‘ç°ï¼šè´­ä¹°æµç¨‹ç¼ºå¤±æ­¥éª¤

### å½“å‰é—®é¢˜

æ ¹æ®985Proxy APIæ–‡æ¡£ï¼š

```
POST /res_static/buy è¿”å›ï¼š
{
  "code": 0,
  "msg": "success",
  "data": {
    "order_no": "string"  â† åªè¿”å›è®¢å•å·ï¼
  }
}
```

**é—®é¢˜**ï¼š`/buy` API **åªè¿”å›è®¢å•å·**ï¼Œä¸è¿”å›IPè¯¦æƒ…ï¼ˆIPåœ°å€ã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ç­‰ï¼‰ï¼

### æ­£ç¡®çš„æµç¨‹åº”è¯¥æ˜¯ï¼š

```
1. è°ƒç”¨ POST /res_static/buy
   â†“ è¿”å› order_no
   
2. è°ƒç”¨ POST /res_static/order_result
   å‚æ•°: { "order_no": "xxx" }
   â†“ è¿”å›å®Œæ•´çš„IPä¿¡æ¯
   
3. ä¿å­˜IPåˆ°ProxyHubæ•°æ®åº“
```

### å½“å‰ProxyHubçš„é—®é¢˜

æŸ¥çœ‹ä»£ç  `backend/src/modules/proxy/static/static-proxy.service.ts` ç¬¬218è¡Œï¼š

```typescript
// è§£æ985Proxyè¿”å›çš„IPæ•°æ®å¹¶ä¿å­˜åˆ°æ•°æ®åº“
if (proxy985Response && proxy985Response.data && Array.isArray(proxy985Response.data)) {
  for (const apiIP of proxy985Response.data) {
    // âŒ è¿™é‡Œå‡è®¾ proxy985Response.data æ˜¯IPæ•°ç»„
    // ä½†å®é™…ä¸Š /buy API åªè¿”å› { order_no: "xxx" }
  }
}
```

**è¿™æ®µä»£ç ä¸ä¼šæ‰§è¡Œ**ï¼Œå› ä¸ºï¼š
- `/buy` è¿”å›çš„ `data` æ˜¯ `{ order_no: "xxx" }` å¯¹è±¡
- ä¸æ˜¯IPæ•°ç»„
- æ‰€ä»¥è´­ä¹°åIPä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“ï¼

---

## ğŸ”§ éœ€è¦ä¿®å¤çš„ä»£ç 

### ä¿®å¤æ–¹æ¡ˆ1ï¼šæ·»åŠ  order_result è°ƒç”¨ï¼ˆæ¨èï¼‰

```typescript
// æ­¥éª¤1: è°ƒç”¨è´­ä¹°API
proxy985Response = await this.proxy985Service.buyStaticProxy({
  zone,
  time_period: dto.duration,
  static_proxy_type: proxyType,
  buy_data: buyData,
  pay_type: 'balance',
  purpose_web: dto.scenario || undefined,
});

const orderNo = proxy985Response.data.order_no;
this.logger.log(`âœ… [Purchase] 985Proxyè®¢å•åˆ›å»ºæˆåŠŸ: ${orderNo}`);

// æ­¥éª¤2: æŸ¥è¯¢è®¢å•ç»“æœè·å–IPè¯¦æƒ…
const orderResult = await this.proxy985Service.getOrderResult(orderNo);

// æ­¥éª¤3: ä¿å­˜IPåˆ°æ•°æ®åº“
if (orderResult && orderResult.data && orderResult.data.info) {
  const ipList = orderResult.data.info.result; // è¿™æ‰æ˜¯IPæ•°ç»„
  
  for (const apiIP of ipList) {
    const proxyEntity = this.staticProxyRepo.create({
      userId: parseInt(userId),
      channelName: dto.channelName,
      ip: apiIP.ip,
      port: apiIP.port,
      username: apiIP.username,
      password: apiIP.password,
      country: apiIP.country_code,
      city: apiIP.city_name,
      // ... å…¶ä»–å­—æ®µ
    });
    
    allocatedIPs.push(await this.staticProxyRepo.save(proxyEntity));
  }
}
```

### ä¿®å¤æ–¹æ¡ˆ2ï¼šä½¿ç”¨Fallback Mockæ•°æ®ï¼ˆå½“å‰å®ç°ï¼‰

å¦‚æœAPIè°ƒç”¨å¤±è´¥æˆ–è¿”å›æ ¼å¼ä¸ç¬¦ï¼Œä½¿ç”¨mockæ•°æ®ï¼š

```typescript
// å½“å‰ä»£ç ï¼ˆç¬¬250è¡Œå·¦å³ï¼‰
else {
  // Fallback: ç”Ÿæˆmockæ•°æ®
  this.logger.log('[Purchase] ä½¿ç”¨fallback mockæ•°æ®ï¼ˆAPIæœªè¿”å›IPæ•°ç»„ï¼‰');
  
  for (const item of dto.items) {
    for (let i = 0; i < item.quantity; i++) {
      const mockIP = this.staticProxyRepo.create({
        userId: parseInt(userId),
        channelName: dto.channelName,
        ip: `${Math.floor(Math.random() * 255)}.xxx.xxx.xxx`,
        port: 10000 + Math.floor(Math.random() * 50000),
        username: `user_${Date.now()}_${i}`,
        password: Math.random().toString(36).substring(2, 15),
        country: item.country,
        city: item.city,
        // ...
      });
      allocatedIPs.push(await this.staticProxyRepo.save(mockIP));
    }
  }
}
```

---

## ğŸ“Š å®é™…æ•ˆæœåˆ†æ

### å½“å‰é…ç½®ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

**Zone IDä¿®æ”¹ä¸º `6jd4ftbl7kv3` åï¼š**

1. âœ… **985Proxy APIè°ƒç”¨æˆåŠŸ**
   - POST /res_static/buy è¿”å› 200 OK
   - è¿”å›è®¢å•å·ï¼š`order_20251105xxxxx`

2. âš ï¸ **IPä¿å­˜å¤±è´¥ï¼ˆå› ä¸ºä»£ç é€»è¾‘é—®é¢˜ï¼‰**
   - `proxy985Response.data` æ˜¯å¯¹è±¡ä¸æ˜¯æ•°ç»„
   - ç¬¬218è¡Œçš„ `Array.isArray()` è¿”å› false
   - è·³è¿‡IPä¿å­˜é€»è¾‘

3. âœ… **Fallbackæœºåˆ¶ç”Ÿæ•ˆ**
   - è¿›å…¥ç¬¬250è¡Œçš„fallbacké€»è¾‘
   - ç”Ÿæˆmock IPæ•°æ®ä¿å­˜åˆ°æ•°æ®åº“

4. âœ… **985Proxyè´¦æˆ·æ‰£è´¹æˆåŠŸ**
   - æ‚¨çš„985Proxyè´¦æˆ·ä½™é¢å‡å°‘
   - è®¢å•è®°å½•åœ¨985Proxyåå°

5. âœ… **ProxyHubç”¨æˆ·æ‰£è´¹æˆåŠŸ**
   - ç”¨æˆ·ä½™é¢ä» $10,048 â†’ $10,047

6. âš ï¸ **æ•°æ®ä¸ä¸€è‡´é—®é¢˜**
   - 985ProxyçœŸå®åˆ†é…äº†IPï¼ˆå¯åœ¨åå°æŸ¥çœ‹ï¼‰
   - ä½†ProxyHubæ•°æ®åº“ä¿å­˜çš„æ˜¯mock IP
   - ç”¨æˆ·æ‹¿åˆ°çš„IPæ˜¯å‡çš„ï¼

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ä¼˜å…ˆçº§1ï¼šğŸ”´ ç´§æ€¥ä¿®å¤

**æ·»åŠ  `POST /res_static/order_result` API è°ƒç”¨**

ä¿®æ”¹æ–‡ä»¶ï¼š
- `backend/src/modules/proxy985/proxy985.service.ts` - æ·»åŠ  getOrderResult æ–¹æ³•
- `backend/src/modules/proxy/static/static-proxy.service.ts` - ä¿®æ”¹è´­ä¹°æµç¨‹

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… è´­ä¹°åè·å–çœŸå®IP
- âœ… ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨IP
- âœ… æ•°æ®å®Œå…¨ä¸€è‡´

### ä¼˜å…ˆçº§2ï¼šğŸŸ¡ å»ºè®®æ·»åŠ 

**é›†æˆ `GET /res_static/inventory` API**

**ç”¨é€”**ï¼š
- å®æ—¶æŸ¥è¯¢IPåº“å­˜å’Œä»·æ ¼
- æ›¿æ¢å‰ç«¯çš„mockæ•°æ®

**æ•ˆæœ**ï¼š
- âœ… æ˜¾ç¤ºçœŸå®åº“å­˜
- âœ… åŠ¨æ€ä»·æ ¼ï¼ˆå«ä¼˜æƒ ï¼‰
- âœ… é¿å…ç”¨æˆ·é€‰æ‹©æ— è´§å•†å“

### ä¼˜å…ˆçº§3ï¼šğŸŸ¢ é•¿æœŸä¼˜åŒ–

1. **æ·»åŠ ç»­è´¹åŠŸèƒ½** - `POST /res_static/renew`
2. **IPåˆ—è¡¨åŒæ­¥** - `GET /res_static/ip_list`
3. **ç²¾ç¡®ä»·æ ¼è®¡ç®—** - `POST /res_static/calculate`

---

## ğŸ“ æ€»ç»“

### å½“å‰å®ç°çš„çœŸå®æƒ…å†µ

```
ç”¨æˆ·è´­ä¹°IPæµç¨‹ï¼š

1. âœ… ProxyHubéªŒè¯ä½™é¢å’Œæ•°é‡
2. âœ… è°ƒç”¨985Proxy /buy APIï¼ˆä¼šçœŸå®æ‰£è´¹ï¼‰
3. âŒ æ²¡æœ‰è°ƒç”¨ /order_result è·å–IPè¯¦æƒ…
4. âš ï¸ ä¿å­˜mock IPåˆ°æ•°æ®åº“ï¼ˆä¸æ˜¯çœŸå®IPï¼‰
5. âœ… æ‰£é™¤ç”¨æˆ·ä½™é¢
6. âš ï¸ ç”¨æˆ·æ‹¿åˆ°å‡IPï¼ˆæ— æ³•ä½¿ç”¨ï¼‰

çœŸå®IPåœ¨å“ªé‡Œï¼Ÿ
â†’ åœ¨æ‚¨çš„985Proxyåå°å¯ä»¥çœ‹åˆ°
â†’ éœ€è¦æ‰‹åŠ¨æŸ¥è¯¢æˆ–é€šè¿‡APIè·å–
```

### å»ºè®®ä¸‹ä¸€æ­¥æ“ä½œ

1. **ç«‹å³æµ‹è¯•**ï¼š
   - æ›´æ–°Zone IDä¸º `6jd4ftbl7kv3`
   - é‡å¯åç«¯
   - æµ‹è¯•è´­ä¹°1ä¸ªIP
   - æ£€æŸ¥985Proxyåå°æ˜¯å¦æ‰£è´¹

2. **ç¡®è®¤é—®é¢˜**ï¼š
   - å¦‚æœæ‰£è´¹æˆåŠŸï¼Œè¯´æ˜APIé›†æˆæ­£ç¡®
   - ä½†æ•°æ®åº“ä¿å­˜çš„æ˜¯mock IP

3. **ä¿®å¤ä»£ç **ï¼š
   - æ·»åŠ  `getOrderResult` APIè°ƒç”¨
   - æ­£ç¡®ä¿å­˜çœŸå®IPä¿¡æ¯

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-11-05  
**ä¸‹æ¬¡æ›´æ–°**: æ·»åŠ order_result APIå

