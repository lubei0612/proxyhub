# ProxyHub 完整集成配置指南

本文档包含 SMTP 邮件服务和 Telegram Bot 的完整配置说明。

---

## 📧 一、SMTP 邮件服务配置

### 1.1 Microsoft Outlook 配置（推荐国内用户）

#### 需要提供的信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `MAIL_HOST` | `smtp-mail.outlook.com` | 固定值 |
| `MAIL_PORT` | `587` | 固定值（TLS加密） |
| `MAIL_USER` | 你的邮箱地址 | 如：example@outlook.com |
| `MAIL_PASSWORD` | 登录密码 | Outlook 邮箱登录密码 |
| `MAIL_FROM` | 发件人显示 | 如：ProxyHub <example@outlook.com> |

#### 支持的邮箱域名
- `@outlook.com`
- `@hotmail.com`
- `@live.com`
- `@msn.com`

#### 配置示例

在 `backend/.env` 文件中添加：

```env
# Microsoft Outlook SMTP 配置
MAIL_HOST=smtp-mail.outlook.com
MAIL_PORT=587
MAIL_USER=your-email@outlook.com
MAIL_PASSWORD=你的Outlook登录密码
MAIL_FROM=ProxyHub <your-email@outlook.com>
```

#### 配置步骤

1. **准备 Outlook 账号**
   - 如果没有账号，访问 https://outlook.com 注册
   - 记住邮箱地址和密码

2. **编辑配置文件**
   - 打开 `backend/.env` 文件
   - 添加上述配置，替换成你的邮箱和密码

3. **重启服务**
   ```bash
   cd backend
   npm run start:dev
   ```

4. **验证配置**
   - 查看日志是否显示：`[EmailService] 邮件服务初始化成功`

#### 特点
- ✅ 配置最简单（直接使用密码）
- ✅ 国内访问稳定
- ✅ 免费额度：300 封/天
- ✅ 送达率高
- ⏱️ 配置时间：1 分钟

---

### 1.2 Gmail 配置（推荐国际用户）

#### 需要提供的信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `MAIL_HOST` | `smtp.gmail.com` | 固定值 |
| `MAIL_PORT` | `587` | TLS加密（推荐） |
| `MAIL_USER` | Gmail 地址 | 如：example@gmail.com |
| `MAIL_PASSWORD` | 应用专用密码 | **必须用应用密码，不能用登录密码** |
| `MAIL_FROM` | 发件人显示 | 如：ProxyHub <example@gmail.com> |

#### 配置示例

```env
# Gmail SMTP 配置
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=your-email@gmail.com
MAIL_PASSWORD=abcdefghijklmnop
MAIL_FROM=ProxyHub <your-email@gmail.com>
```

#### 获取应用专用密码详细步骤

**步骤 1：启用两步验证（必须）**

1. 访问：https://myaccount.google.com/signinoptions/two-step-verification
2. 点击 **"开始使用"** 或 **"使用入门"**
3. 输入 Google 密码确认身份
4. 选择验证方式：
   - 手机号码（推荐）
   - Google Authenticator App
5. 按照提示完成手机验证
6. ⏱️ 时间：5-10 分钟

**步骤 2：生成应用专用密码**

1. **直接访问（推荐）**
   ```
   https://myaccount.google.com/apppasswords
   ```

2. **或手动查找**
   - 访问：https://myaccount.google.com
   - 左侧点击 **"安全性"**（Security）
   - 找到 **"应用专用密码"**（App passwords）

3. **生成密码**
   - 选择应用：**邮件**（Mail）
   - 选择设备：**其他（自定义名称）**
   - 输入名称：`ProxyHub`
   - 点击 **"生成"**
   - 复制 16 位密码（如：`abcd efgh ijkl mnop`）
   - **去掉空格**：`abcdefghijklmnop`
   - ⏱️ 时间：2-3 分钟

4. **配置到项目**
   - 将密码填入 `MAIL_PASSWORD`

#### 特点
- ✅ 送达率最高（99%+）
- ✅ 免费额度：500 封/天
- ⚠️ 必须启用两步验证
- ⚠️ 国内访问可能需要科学上网
- ⏱️ 配置时间：10-15 分钟

---

### 1.3 QQ 邮箱配置（国内推荐）

#### 配置示例

```env
# QQ 邮箱 SMTP 配置
MAIL_HOST=smtp.qq.com
MAIL_PORT=465
MAIL_USER=your-qq-number@qq.com
MAIL_PASSWORD=授权码（16位）
MAIL_FROM=ProxyHub <your-qq-number@qq.com>
```

#### 获取授权码步骤

1. **访问 QQ 邮箱**
   - 打开 https://mail.qq.com
   - 登录您的 QQ 邮箱

2. **进入设置**
   - 点击顶部的 **"设置"**（齿轮图标）
   - 点击 **"账户"** 标签页

3. **开启 SMTP 服务**
   - 向下滚动找到：`POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务`
   - 找到 **"IMAP/SMTP服务"**
   - 如果显示"关闭"，点击 **"开启"**

4. **发送验证短信**
   - 会弹出验证窗口
   - 用手机发送短信：
     ```
     短信内容：配置邮件客户端
     发送到：1069070069
     ```
   - 或扫码验证（更快）

5. **获取授权码**
   - 发送成功后，页面显示 **授权码**（16位字符）
   - 立即复制保存（类似：`abcdefghijklmnop`）
   - 关闭后可点击 **"生成授权码"** 重新获取

#### 特点
- ✅ 界面全中文，操作简单
- ✅ 国内访问速度快
- ✅ 免费额度：50-100 封/天
- ✅ 稳定可靠
- ⏱️ 配置时间：5 分钟

---

### 1.4 完整 .env 配置示例

```env
# ========================================
# 数据库配置
# ========================================
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres123
DATABASE_NAME=proxyhub

# ========================================
# Redis 配置
# ========================================
REDIS_HOST=localhost
REDIS_PORT=6379

# ========================================
# JWT 配置
# ========================================
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_ACCESS_EXPIRY=2h
JWT_REFRESH_EXPIRY=7d

# ========================================
# 邮件服务配置（选择其中一个）
# ========================================

# 方案一：Microsoft Outlook（推荐国内用户）
MAIL_HOST=smtp-mail.outlook.com
MAIL_PORT=587
MAIL_USER=your-email@outlook.com
MAIL_PASSWORD=你的Outlook登录密码
MAIL_FROM=ProxyHub <your-email@outlook.com>

# 方案二：Gmail（推荐国际用户）
# MAIL_HOST=smtp.gmail.com
# MAIL_PORT=587
# MAIL_USER=your-email@gmail.com
# MAIL_PASSWORD=应用专用密码
# MAIL_FROM=ProxyHub <your-email@gmail.com>

# 方案三：QQ 邮箱（国内推荐）
# MAIL_HOST=smtp.qq.com
# MAIL_PORT=465
# MAIL_USER=your-qq-number@qq.com
# MAIL_PASSWORD=授权码
# MAIL_FROM=ProxyHub <your-qq-number@qq.com>

# ========================================
# 应用配置
# ========================================
NODE_ENV=development
PORT=3000
API_PREFIX=/api/v1

# ========================================
# 985Proxy API 配置
# ========================================
PROXY_985_API_KEY=your_api_key
PROXY_985_BASE_URL=https://open-api.985proxy.com
PROXY_985_ZONE=your_zone_id

# ========================================
# 系统配置
# ========================================
USD_TO_CNY_RATE=7.2
TELEGRAM_LINK=https://t.me/lubei12
```

---

## 🤖 二、Telegram Bot 配置

### 2.1 创建 Telegram Bot（获取 Bot Token）

#### 步骤 1：打开 Telegram

在手机或电脑上打开 Telegram 应用。

#### 步骤 2：搜索 BotFather

在 Telegram 搜索框输入：**`@BotFather`**

或直接访问：https://t.me/BotFather

**BotFather 是 Telegram 官方的 Bot 管理机器人。**

#### 步骤 3：创建新 Bot

向 BotFather 发送命令：
```
/newbot
```

#### 步骤 4：设置 Bot 名称

BotFather 会问：**What name do you want your bot to have?**

输入您的 Bot 显示名称（可以包含空格和中文）：
```
ProxyHub Notification Bot
```
或
```
ProxyHub通知助手
```

#### 步骤 5：设置 Bot 用户名

BotFather 会问：**Now choose a username for your bot.**

输入 Bot 用户名（必须以 `bot` 结尾，只能包含字母、数字和下划线）：
```
ProxyHub_Notify_Bot
```
或
```
YourName_ProxyHub_Bot
```

**注意：** 
- 用户名必须是唯一的
- 必须以 `bot` 结尾（不区分大小写）
- 如果提示已被占用，换一个名字

#### 步骤 6：获取 Bot Token

创建成功后，BotFather 会发送一条消息，包含：

```
Done! Congratulations on your new bot. You will find it at t.me/ProxyHub_Notify_Bot

Use this token to access the HTTP API:
1234567890:ABCdefGHIjklMNOpqrsTUVwxyz-1234567

Keep your token secure and store it safely, it can be used by anyone to control your bot.
```

**重要！** 复制这个 Token（格式类似：`1234567890:ABCdefGHIjklMNOpqrsTUVwxyz-1234567`）

⚠️ **千万不要泄露这个 Token！** 任何人拥有这个 Token 都可以控制您的 Bot。

---

### 2.2 获取 Bot 用户名（如果忘记）

如果您不知道 Bot 的用户名，可以：

1. **打开 Telegram**

2. **搜索 `@BotFather`**

3. **发送 `/mybots`**

4. **选择您的 Bot**

5. **查看 Bot 的用户名**（例如：`@ProxyHubBot`）

6. **将用户名更新到配置**（不需要 @ 符号）：
   ```env
   TELEGRAM_BOT_USERNAME=ProxyHubBot
   ```

---

### 2.3 配置环境变量

在 `backend/.env` 文件中添加：

```env
# ========================================
# Telegram Bot 配置
# ========================================
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz-1234567
TELEGRAM_BOT_USERNAME=ProxyHub_Notify_Bot
```

**参数说明：**
- `TELEGRAM_BOT_TOKEN`：从 BotFather 获取的 Token
- `TELEGRAM_BOT_USERNAME`：Bot 的用户名（不含 @ 符号）

---

### 2.4 启动服务

#### 1. 保存 .env 文件

确保配置已保存在 `backend/.env`。

#### 2. 重启后端服务

**Windows：**
```bash
# 停止服务（如果正在运行）
Ctrl + C

# 重新启动
cd backend
npm run start:dev
```

或双击运行：`启动ProxyHub.bat`

**Linux/Mac：**
```bash
cd backend
npm run start:dev
```

#### 3. 查看启动日志

如果配置正确，应该看到：
```
[TelegramService] Telegram Bot初始化成功
[EmailService] 邮件服务初始化成功
```

如果看到警告：
```
[TelegramService] Telegram Bot未配置，将跳过Bot初始化
```
说明 Token 配置有问题，请检查：
- Token 是否正确复制
- .env 文件是否保存
- .env 文件位置是否正确（在 `backend/.env`）

---

### 2.5 测试 Bot

#### 1. 在 Telegram 中搜索您的 Bot

在 Telegram 搜索框输入：`@ProxyHub_Notify_Bot`（替换成您的 Bot 用户名）

或直接访问：`https://t.me/ProxyHub_Notify_Bot`

#### 2. 启动 Bot

点击 **"START"** 按钮，或发送：
```
/start
```

#### 3. 查看响应

Bot 应该回复：
```
👋 欢迎使用ProxyHub通知Bot！

请在ProxyHub网站的账户设置中生成绑定码，然后使用以下格式绑定：
/start <绑定码>

绑定后，您将收到订单、充值等重要通知。
```

✅ **如果收到这条消息，说明 Bot 配置成功！**

#### 4. 测试其他命令

发送 `/help` 查看所有可用命令：
```
/help
```

Bot 会回复：
```
📖 ProxyHub Bot 帮助

/start <绑定码> - 绑定您的ProxyHub账户
/balance - 查询账户余额
/orders - 查看最近订单
/unbind - 解绑账户
/help - 显示此帮助信息

如有疑问，请联系客服：@lubei12
```

---

### 2.6 已实现的功能

#### 用户命令

| 命令 | 功能 | 说明 |
|------|------|------|
| `/start` | 显示帮助 | 显示绑定说明 |
| `/start <绑定码>` | 绑定账号 | 使用绑定码绑定 ProxyHub 账号 |
| `/balance` | 查询余额 | 查看账户余额和赠送余额 |
| `/orders` | 查看订单 | 查看最近订单 |
| `/unbind` | 解绑账户 | 取消绑定，停止接收通知 |
| `/help` | 帮助信息 | 显示所有可用命令 |

#### 自动通知功能

系统会自动向已绑定的用户发送：

✅ **订单通知**
```
📦 订单通知

订单号：ORD20250105001
商品：静态住宅代理
金额：$50.00
状态：已完成
```

✅ **充值通知**
```
💰 充值成功

充值金额：$100.00
当前余额：$150.00
```

✅ **IP 到期提醒**
```
⏰ IP到期提醒

IP地址：192.168.1.100
剩余天数：3天
到期时间：2025-01-08 12:00:00

请及时续费以免影响使用。
```

✅ **余额不足提醒**
```
⚠️ 余额不足提醒

当前余额：$5.50

建议及时充值以免影响使用。
```

---

### 2.7 用户绑定流程

#### 步骤 1：用户在网站生成绑定码

1. 用户登录 ProxyHub 网站
2. 进入 **账户设置** 页面
3. 找到 **Telegram 通知设置**
4. 点击 **"生成绑定码"** 按钮
5. 获取 6-8 位绑定码（如：`A3F7K9M2`）
6. 绑定码有效期：**10 分钟**

#### 步骤 2：用户在 Telegram 中绑定

1. 在 Telegram 搜索并打开您的 Bot
2. 发送命令：
   ```
   /start A3F7K9M2
   ```
3. 等待 Bot 响应

#### 步骤 3：绑定成功

Bot 回复：
```
✅ 绑定成功！

您的ProxyHub账户已成功绑定到Telegram。
现在您将收到重要的通知消息。

使用 /help 查看可用命令。
```

用户开始接收所有系统通知。

---

## 📋 三、完整配置清单

### 3.1 配置文件位置

```
proxyhub/
  └── backend/
      └── .env  ← 所有配置都在这里
```

### 3.2 必需的配置项

```env
# 数据库配置（必需）
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres123
DATABASE_NAME=proxyhub

# Redis 配置（必需）
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT 配置（必需）
JWT_SECRET=your-super-secret-jwt-key
JWT_ACCESS_EXPIRY=2h
JWT_REFRESH_EXPIRY=7d

# 邮件服务配置（可选，选择一个）
MAIL_HOST=smtp-mail.outlook.com
MAIL_PORT=587
MAIL_USER=your-email@outlook.com
MAIL_PASSWORD=your-password
MAIL_FROM=ProxyHub <your-email@outlook.com>

# Telegram Bot 配置（可选）
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz-1234567
TELEGRAM_BOT_USERNAME=ProxyHub_Notify_Bot

# 应用配置（必需）
NODE_ENV=development
PORT=3000
API_PREFIX=/api/v1
```

### 3.3 配置验证清单

- [ ] 数据库配置已填写
- [ ] Redis 配置已填写
- [ ] JWT 密钥已设置
- [ ] 邮件服务已配置（Outlook/Gmail/QQ 任选一个）
- [ ] Telegram Bot Token 已配置
- [ ] Telegram Bot 用户名已配置
- [ ] 已重启后端服务
- [ ] 日志显示邮件服务初始化成功
- [ ] 日志显示 Telegram Bot 初始化成功
- [ ] 已在 Telegram 中测试 Bot 响应

---

## 🛠️ 四、故障排查

### 4.1 邮件服务问题

#### 问题 1：邮件服务未初始化

**症状：** 日志显示 `邮件服务未配置，将跳过邮件发送`

**原因：**
- `MAIL_USER` 或 `MAIL_PASSWORD` 未配置
- 配置文件位置错误

**解决：**
1. 检查 `.env` 文件是否在 `backend/.env`
2. 确认 `MAIL_USER` 和 `MAIL_PASSWORD` 已填写
3. 重启服务

#### 问题 2：Gmail 认证失败

**症状：** `535 Authentication unsuccessful`

**原因：**
- 未启用两步验证
- 使用了登录密码而非应用专用密码

**解决：**
1. 启用 Gmail 两步验证
2. 生成应用专用密码
3. 使用应用专用密码配置

#### 问题 3：Outlook 认证失败

**症状：** `535 5.7.3 Authentication unsuccessful`

**原因：**
- 邮箱或密码错误
- 账号启用了两步验证但未使用应用密码

**解决：**
1. 确认邮箱和密码正确
2. 如果启用了两步验证，生成应用密码

---

### 4.2 Telegram Bot 问题

#### 问题 1：Bot 未初始化

**症状：** 日志显示 `Telegram Bot未配置，将跳过Bot初始化`

**原因：**
- `TELEGRAM_BOT_TOKEN` 未配置

**解决：**
1. 检查 Token 是否正确复制到 `.env`
2. 确认 Token 格式正确（包含冒号）
3. 重启服务

#### 问题 2：Bot 无响应

**症状：** 在 Telegram 发送命令，Bot 没有回复

**原因：**
- Bot Token 错误
- 服务未启动
- 网络问题

**解决：**
1. 检查后端服务是否运行
2. 查看日志是否有错误
3. 重新生成 Token 测试

#### 问题 3：找不到 Bot

**症状：** 在 Telegram 搜索不到 Bot

**原因：**
- Bot 用户名输入错误
- Bot 未创建成功

**解决：**
1. 向 @BotFather 发送 `/mybots` 查看 Bot 列表
2. 确认 Bot 用户名
3. 使用正确的用户名搜索

---

## 📞 五、获取帮助

如果遇到问题，可以：

1. **查看日志**
   ```bash
   cd backend
   npm run start:dev
   ```
   查看控制台输出的错误信息

2. **检查配置文件**
   - 确认 `backend/.env` 文件存在
   - 确认所有配置项已填写
   - 确认没有多余的空格或特殊字符

3. **测试连接**
   - 使用测试脚本验证 SMTP 配置
   - 在 Telegram 中测试 Bot 响应

---

## ✅ 配置完成

完成以上配置后，您的 ProxyHub 系统将支持：

✅ **邮件通知**
- 充值成功通知
- 订单确认通知
- IP 到期提醒
- 余额不足提醒

✅ **Telegram 通知**
- 实时消息推送
- 账户余额查询
- 订单查询
- 绑定/解绑管理

🎉 **恭喜您完成配置！**

